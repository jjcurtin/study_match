---
title: "SHAP for 4-Week Model"
author: "Gaylen Fronk"
date: "`r lubridate::today()`"
number-sections: true
output: 
  html_document:
    toc: true 
    toc_depth: 4
format:
  html:
    embed-resources: true
    toc: true
    toc-depth: 4
editor_options: 
  chunk_output_type: console
---

```{r set_variables}
study <- "match"
version <- "v6"
y_col_name <- "pp_hybrid_wk4_outcome"
```

```{r, packages_script}
#| message: false
#| warning: false

# packages for script
library(tidyverse)
library(patchwork)

theme_set(theme_classic()) 
```

```{r, packages_workflow}
#| message: false
#| warning: false

# handle conflicts
options(conflicts.policy = "depends.ok")
```

```{r, absolute paths}

# absolute paths
switch (Sys.info()[['sysname']],
        # PC paths
        Windows = {
          path_data <- str_c("P:/studydata/match/chtc/", y_col_name)},
        
        # IOS paths
        Darwin = {
          path_data <- str_c("/Volumes/private/studydata/match/chtc/", y_col_name)},
        
        # Linux paths
        Linux = {
          path_data <- str_c("~/mnt/private/studydata/match/chtc/", y_col_name)}
)
```

```{r defaults}

# chunk defaults

options(tibble.width = Inf)
options(tibble.print_max = Inf)
```

## Read in data

SHAP obtained with LOOCV at CHTC
```{r}
local <- read_csv(file.path(path_data, str_c("shap_loocv_", version), 
                            "output", "batch_results.csv"),
                  col_types = "cddd")

glimpse(local)
```
This dataset is already local SHAP values because we have one observation per subid per variable.

## Get global Shapley values

```{r}
global <- local |> 
  mutate(abs_contribution = abs(contribution)) |> 
  group_by(variable_name) |> 
  summarize(mean_contribution = mean(abs_contribution)) |> 
  arrange(desc(mean_contribution))

glimpse(global)

```

Delineate treatment interactions
```{r}
global <- global |> 
  mutate(tx_int = if_else(str_detect(variable_name, "treatment_"), "Interaction", "Main Effect"))
```

Add interpretable names
```{r}
global_tx <- global |> 
  filter(tx_int == "Interaction") |> 
  arrange(desc(mean_contribution)) |> 
  slice(1:25) |> 
  arrange(mean_contribution) |> 
  mutate(Feature = c(
    "C-NRT X Divorced",
    "C-NRT X Currently smokes menthol cigarettes",
    "Patch X Bothered by craving a cigarette (WSWS-2 Item `Crave`)",
    "Varenicline X Kept smoking despite relationship problems (DSM-5 Item 3)",
    "C-NRT X Married",
    "Varenicline X Does not live with another smoker",
    "Varenicline X Has never tried cigars",
    "C-NRT X Worries they are going crazy when they cannot keep their mind on a task (ASI-3 Item 2)",
    "C-NRT X Does not endorse withdrawal symptoms (DSM-5 Item 6)",
    "Patch X Has never tried cigars",
    "C-NRT X Identifies as White",
    "C-NRT X Most of their friends and acquaintances smoke (WISDM-37 Item 30)",
    "Varenicline X No close relative who smokes",
    "Patch X Has tried cigars but has never used regularly",
    "Varenicline X Does not think they do a lot in a day (MFI Item 6)",
    "Patch X No close friend who smokes",
    "Varenicline X Has a spouse/partner who does not smoke",
    "Varenicline X Greater income",
    "Varenicline X Worries they will choke to death when their throat feels tight (ASI-3 Item 15)",
    "C-NRT X Identifies as Black or African American",
    "C-NRT X Has never smoked menthol cigarettes",
    "Varenicline X Lives alone or only with a partner",
    "C-NRT X Disagrees that there is nothing worse than feeling distressed or upset (DTS Item 5)",
    "C-NRT X Sometimes feels like cigarattes are their best friends (WISDM-37 Item 22)",
    "C-NRT X Lives alone or only with a partner"
  )) |> 
  mutate(Feature = fct_inorder(Feature))

global <- global |> 
  arrange(desc(mean_contribution)) |> 
  slice(1:25) |> 
  arrange(mean_contribution) |> 
  mutate(Feature = c(
    "C-NRT X Identifies as Black or African American",
    "A lot of friends or family members smoke (WISDM-37 Item 27)",
    "C-NRT X Has never smoked menthol cigarettes",
    "Varenicline X Lives alone or only with a partner",
    "C-NRT X Disagrees that there is nothing worse than feeling distressed or upset (DTS Item 5)",
    "Does not dread having to do things (MFI Item 9)",
    "Endorses that the flavor of a cigarette is pleasing (WISDM-37 Item 5)",
    "More satisfied with their life as a whole",
    "Currently smokes menthol cigarettes",
    "Does not have a lot of plans (MFI Item 15)",
    "C-NRT X Sometimes feels like cigarattes are their best friends (WISDM-37 Item 22)",
    "Greater income",
    "More time around smokers on the weekend",
    "Won't do much to stop feeling distessed or upset (DTS Item 13)",
    "Identifies as Black or African American",
    "Enjoys being with their family or close friends (SHP Item 2)",
    "Worries they will choke to death when their throat feels tight (ASI-3 Item 15)",
    "C-NRT X Lives alone or only with a partner",
    "Bothered by wanting to smoke (WSWS-2 Item 'Want Cigarette')",
    "Greater duration of longest previous quit attempt",
    "Most of their friends and acquaintances smoke (WISDM-37 Item 30)",
    "Greater motivation to quit",
    "Endorses feeling cigarettes control them (WISDM-37 Item 2)",
    "Identifies as White",
    "Greater exhaled carbon monoxide"
  )) |> 
  mutate(Feature = fct_inorder(Feature))

```

## Make global figures

Overall
```{r}

fig_shap_global <- global |> 
  ggplot(mapping = aes(x = Feature, y = mean_contribution, color = tx_int)) +
  geom_point(size = 2) +
  geom_segment(aes(x = Feature, y = mean_contribution, xend = Feature),
               yend = 0) +
  labs(
    x = "",
    y = "Mean |Shapley value|",
    color = "Feature Type",
    title = "Top Features Overall"
  ) +
  coord_flip() +
  theme(legend.position = "bottom")

fig_shap_global
```

Global Shapley values among treatment interactions
```{r}

fig_shap_global_tx <- global_tx |> 
  ggplot(mapping = aes(x = Feature, y = mean_contribution, color = tx_int)) +
  geom_point(size = 2) +
  geom_segment(aes(x = Feature, y = mean_contribution, xend = Feature),
               yend = 0) +
  labs(
    x = "",
    y = "Mean |Shapley value|",
    title = "Top Interaction Features"
  ) +
  coord_flip() +
  theme(legend.position = "none")

fig_shap_global_tx
```

Paneled Global figure
```{r}
#| label: fig-shap-global
#| fig-height: 9
#| fig-cap: "Global feature importance via Shapley values. Bar represents magnitude of global feature importance, which is calculated from the mean of the absolute value across all observations for that feature. A) Global feature importance for top 25 features overall. B) Global feature importance for top 25 treatment interaction features."
 
fig_panel_shap_global <- (fig_shap_global / fig_shap_global_tx / guide_area()) +
  plot_layout(guides = "collect", axes = "collect", ncol = 1,
              heights = unit(c(3, 3, 0.5), "in")) +
  plot_annotation(tag_levels = "A",
                  title = "Top Global Shapley Values")

fig_panel_shap_global
```

## Make Sina plots (local) 

Set up data
```{r}
local_fig <- global |>
  arrange(desc(mean_contribution)) |> 
  slice(1:25) |> 
  left_join(local, by = c("variable_name", "tx_int"))

local_fig_tx <- global |> 
  filter(tx_int == "Interaction") |> 
  arrange(desc(mean_contribution)) |> 
  slice(1:25) |> 
  left_join(local, by = c("variable_name", "tx_int"))
```


Overall
```{r}
fig_shap_local_all <- local_fig |>
  arrange(mean_contribution) |> 
  mutate(variable_name = str_replace(variable_name, "treatment_", "")) |> 
  mutate(variable_name = fct_inorder(variable_name)) |> 
  ggplot(mapping = aes(x = variable_name, y = contribution,
                       color = tx_int)) +
  ggforce::geom_sina(method = "counts", maxwidth = 0.7, alpha = 0.4) +
  geom_hline(yintercept = 0) +
  scale_y_continuous(limits = c(-0.15, 0.2)) +
  labs(
    x = "",
    y = "Shapley Value",
    color = "Feature Type",
    title = "All Features"
  ) +
  theme(axis.text = element_text(size = 9.5),
        legend.position = "bottom") +
  coord_flip()

fig_shap_local_all

```

Local Shapley values among treatment interactions
```{r}

fig_shap_local_tx <- local_fig_tx |> 
  arrange(mean_contribution) |> 
  mutate(variable_name = str_replace(variable_name, "treatment_", "")) |> 
  mutate(variable_name = fct_inorder(variable_name)) |> 
  ggplot(mapping = aes(x = variable_name, y = contribution,
                       color = tx_int)) +
  ggforce::geom_sina(method = "counts", maxwidth = 0.7, alpha = 0.4) +
  geom_hline(yintercept = 0) +
  scale_y_continuous(limits = c(-0.15, 0.2)) +
  labs(
    x = "",
    y = "Shapley Value",
    title = "Interaction Features"
  ) +
  theme(axis.text = element_text(size = 9.5),
        legend.position = "none") +
  coord_flip()

fig_shap_local_tx
```

Paneled local figure
```{r}
#| label: fig-shap-local
#| fig-height: 9
#| fig-cap: "Local Shapley values for features with the highest global importance. Each dot represents the influence of that feature on a specific observation. A) Local feature importance among all features. B) Local feature importance among treatment interaction features."
#| 
fig_panel_shap_local <- (fig_shap_local_all / fig_shap_local_tx / guide_area()) +
  plot_layout(guides = "collect", axes = "collect", ncol = 1,
              heights = unit(c(3, 3, 0.5), "in")) +
  plot_annotation(tag_levels = "A",
                  title = "Local Shapley Values")

fig_panel_shap_local
```


