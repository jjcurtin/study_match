{
  "hash": "d4fe7792e05051cfa056b030c5f35f46",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Make Figure 1: Model Performance (3-Panel)\"\nauthor: \"Gaylen Fronk\"\ndate: \"2024-05-30\"\nnumber-sections: true\noutput: \n  html_document:\n    toc: true \n    toc_depth: 4\nformat:\n  html:\n    embed-resources: true\n    toc: true\n    toc-depth: 4\neditor_options: \n  chunk_output_type: console\n---\n\n\n## Setup\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nversion <- \"v5\"\ncv <- \"nested\"\ny_col_name <- \"pp_hybrid_wk4_outcome\"\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\n# packages for script\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.4     ✔ readr     2.1.5\n✔ forcats   1.0.0     ✔ stringr   1.5.1\n✔ ggplot2   3.5.1     ✔ tibble    3.2.1\n✔ lubridate 1.9.3     ✔ tidyr     1.3.1\n✔ purrr     1.0.2     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\nlibrary(tidymodels)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n── Attaching packages ────────────────────────────────────── tidymodels 1.2.0 ──\n✔ broom        1.0.5      ✔ rsample      1.2.1 \n✔ dials        1.2.1      ✔ tune         1.2.1 \n✔ infer        1.0.7      ✔ workflows    1.1.4 \n✔ modeldata    1.3.0      ✔ workflowsets 1.1.0 \n✔ parsnip      1.2.1      ✔ yardstick    1.3.1 \n✔ recipes      1.0.10     \n── Conflicts ───────────────────────────────────────── tidymodels_conflicts() ──\n✖ scales::discard() masks purrr::discard()\n✖ dplyr::filter()   masks stats::filter()\n✖ recipes::fixed()  masks stringr::fixed()\n✖ dplyr::lag()      masks stats::lag()\n✖ yardstick::spec() masks readr::spec()\n✖ recipes::step()   masks stats::step()\n• Use tidymodels_prefer() to resolve common conflicts.\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\nlibrary(tidyposterior)\nlibrary(probably)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n\nAttaching package: 'probably'\n\nThe following objects are masked from 'package:base':\n\n    as.factor, as.ordered\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\nlibrary(patchwork)\n\ndevtools::source_url(\"https://github.com/jjcurtin/lab_support/blob/main/fun_eda.R?raw=true\")\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nℹ SHA-1 hash of file is \"c045eee2655a18dc85e715b78182f176327358a7\"\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\ndevtools::source_url(\"https://github.com/jjcurtin/lab_support/blob/main/chtc/static_files/fun_chtc.R?raw=true\")\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nℹ SHA-1 hash of file is \"75cc6f7b855da59c240908bd936834b4da01285b\"\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\ntheme_set(theme_classic()) \n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\n# handle conflicts\noptions(conflicts.policy = \"depends.ok\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nswitch (Sys.info()[['sysname']],\n        # PC paths\n        Windows = {\n          path_models <- str_c(\"P:/studydata/match/models/\", \n                               y_col_name)\n        },\n        \n        # IOS paths\n        Darwin = {\n          path_models <- str_c(\"/Volumes/private/studydata/match/models/\",\n                               y_col_name)\n        },\n        \n        # Linux paths\n        Linux = {\n          path_models <- str_c(\"~/mnt/private/studydata/match/models/\",\n                               y_col_name)\n        }\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n# chunk defaults\n\noptions(tibble.width = Inf)\noptions(tibble.print_max = Inf)\n```\n:::\n\n\n## Make Panels\n\n### Panel A: ROC Curve\n\nRead in outer loop predictions\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\npreds_out <- read_rds(file.path(path_models, \n                                str_c(\"outer_preds_\", version, \n                                      \"_\", cv, \".rds\"))) |> \n  glimpse()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 3,258\nColumns: 3\n$ outer_split_num <int> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …\n$ prob_raw        <dbl> 0.4365827, 0.5961541, 0.5717091, 0.4793436, 0.5308473,…\n$ label           <fct> smoking, smoking, smoking, smoking, abstinent, abstine…\n```\n\n\n:::\n:::\n\n\nSet up data\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nroc_data <- preds_out %>%\n  roc_curve(prob_raw, truth = label) |> \n  glimpse()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 3,260\nColumns: 3\n$ .threshold  <dbl> -Inf, 0.0009771821, 0.0013545969, 0.0073331582, 0.01453086…\n$ specificity <dbl> 0.0000000000, 0.0000000000, 0.0004662005, 0.0009324009, 0.…\n$ sensitivity <dbl> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…\n```\n\n\n:::\n:::\n\n\nCreate plot\n\n::: {#cell-fig-roc-single .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-roc-single\n#| fig-cap: \"ROC Curve\"\n\nfig_roc <- roc_data %>%\n  ggplot(aes(x = 1 - specificity, y = sensitivity, color = .threshold)) +\n  geom_path(linewidth = 2) +\n  geom_abline(lty = 3) +\n  coord_fixed(xlim = c(0, 1), ylim = c(0, 1)) +\n  labs(x = \"False Positive Rate\",\n       y = \"True Positive Rate\",\n       color = \"Threshold\") +\n  scale_x_continuous(breaks = seq(0,1,.25),\n                     labels = sprintf(\"%.2f\", seq(1,0,-.25))) +\n  scale_color_gradient(low=\"blue\", high=\"red\") +\n  theme(axis.text = element_text(size = rel(1)),\n        axis.title = element_text(size = rel(1)))\n\nfig_roc\n```\n\n::: {.cell-output-display}\n![ROC Curve](mak_fig_1_files/figure-html/fig-roc-single-1.png){#fig-roc-single width=672}\n:::\n:::\n\n\n### Panel B: Prediction Calibration\n\nRead in final model predictions (LOOCV)\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nd_cal <- read_csv(file.path(path_models,\n                            str_c(\"aim_2_\", version, \"_\", y_col_name, \".csv\")),\n                  show_col_types = FALSE) |> \n  glimpse()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 1,086\nColumns: 11\n$ subid            <dbl> 20010, 20015, 20030, 20049, 20051, 20072, 20077, 2008…\n$ tx_rct           <chr> \"patch\", \"combo_nrt\", \"patch\", \"varenicline\", \"patch\"…\n$ tx_best          <chr> \"varenicline\", \"varenicline\", \"varenicline\", \"patch\",…\n$ tx_match         <lgl> FALSE, FALSE, FALSE, FALSE, FALSE, TRUE, TRUE, FALSE,…\n$ prob_best        <dbl> 0.4606941, 0.6425940, 0.4593556, 0.5377679, 0.5762493…\n$ outcome_rct_wk4  <chr> \"smoking\", \"smoking\", \"smoking\", \"smoking\", \"smoking\"…\n$ outcome_rct_wk12 <chr> \"smoking\", \"smoking\", \"smoking\", \"abstinent\", \"smokin…\n$ outcome_rct_wk26 <chr> \"smoking\", \"smoking\", \"smoking\", \"abstinent\", \"smokin…\n$ prob_patch       <dbl> 0.3623282, 0.5838388, 0.3770966, 0.5377679, 0.4731365…\n$ prob_combo_nrt   <dbl> 0.3074446, 0.6021400, 0.4396889, 0.5035007, 0.5689455…\n$ prob_varenicline <dbl> 0.4606941, 0.6425940, 0.4593556, 0.5268828, 0.5762493…\n```\n\n\n:::\n:::\n\n\nSet up data\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nd_cal <- d_cal |> \n  mutate(.pred_abstinent = case_when(\n    tx_rct == \"patch\" ~ prob_patch,\n    tx_rct == \"combo_nrt\" ~ prob_combo_nrt,\n    tx_rct == \"varenicline\" ~ prob_varenicline,\n    TRUE ~ NA_real_\n  )) |> \n  select(outcome_rct = outcome_rct_wk4, .pred_abstinent) |> \n  mutate(outcome_rct = factor(outcome_rct,\n                              levels = c(\"abstinent\", \"smoking\"))) |> \n  glimpse()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 1,086\nColumns: 2\n$ outcome_rct     <fct> smoking, smoking, smoking, smoking, smoking, smoking, …\n$ .pred_abstinent <dbl> 0.3623282, 0.6021400, 0.3770966, 0.5268828, 0.4731365,…\n```\n\n\n:::\n:::\n\n\nCreate breaks plot\n\n::: {#cell-fig-cal-breaks .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-cal-breaks\n#| fig-cap: \"Breaks Plot\"\n\nfig_cal_breaks <- d_cal |> \n  cal_plot_breaks(truth = outcome_rct, \n                  estimate = .pred_abstinent)\n\nfig_cal_breaks\n```\n\n::: {.cell-output-display}\n![Breaks Plot](mak_fig_1_files/figure-html/fig-cal-breaks-1.png){#fig-cal-breaks width=672}\n:::\n:::\n\n\nCreate windowed plot\n\n::: {#cell-fig-cal-window .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-cal-window\n#| fig-cap: \"Windowed Plot\"\n\nfig_cal_window <- d_cal |> \n  cal_plot_windowed(truth = outcome_rct, \n                    estimate = .pred_abstinent)\nfig_cal_window\n```\n\n::: {.cell-output-display}\n![Windowed Plot](mak_fig_1_files/figure-html/fig-cal-window-1.png){#fig-cal-window width=672}\n:::\n:::\n\n\nCreated binned plot\n\n::: {#cell-fig-cal-bins .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-cal-bins\n#| fig-cap: \"Binned Plot\"\n\nbin_width = 0.10\n\nfig_cal_bins <- d_cal |> \n  rename(prob_raw = .pred_abstinent) |> \n  mutate(bins = cut(prob_raw, breaks = seq(0, 1, bin_width)),\n         abstinent = if_else(outcome_rct == \"abstinent\", 1, 0)) |> \n  group_by(bins)  |> \n  summarize(mean_abstinent = mean(abstinent),\n            .groups = \"drop\") |>\n  mutate(bins = as.numeric(bins),\n         midpoints = bin_width/2 + bin_width * (bins - 1))  |> \n  ggplot(data = _, aes(x = midpoints, y = mean_abstinent)) +\n    geom_abline(slope = 1, intercept = 0, linetype = \"dotted\") +\n    geom_line() +\n    geom_point() +\n    xlab(\"Predicted Abstinence Probability (bin mid-point)\") +\n    ylab(\"Observed Abstinence Probability\") +\n    scale_x_continuous(breaks = seq(0, 1, bin_width),\n                       limits = c(0, 1)) +\n    scale_y_continuous(breaks = seq(0, 1, bin_width),\n                       limits = c(0, 1)) +\n  theme(axis.text = element_text(size = rel(1)),\n        axis.title = element_text(size = rel(1)))\n\nfig_cal_bins\n```\n\n::: {.cell-output-display}\n![Binned Plot](mak_fig_1_files/figure-html/fig-cal-bins-1.png){#fig-cal-bins width=672}\n:::\n:::\n\n\n### Panel C: Posterior Probability Distribution\n\nRead in posterior probabilities\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\npp <- read_rds(file.path(path_models, \n                         str_c(\"posteriors_\", version, \"_nested.rds\"))) \n```\n:::\n\n\nSet up data\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\npp_tidy <- pp %>% \n  tidy(seed = 123) \n\nci_week4 <- pp_tidy |> \n  summary() |> \n  mutate(model = factor(model, \n                        levels = \"roc_auc\",\n                        labels = \"Week 4\"),\n         y = 1000) \n```\n:::\n\n\nCreate plot\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-pp-wk4\n#| fig-cap: \"Posterior Probabilities Distribution\"\n\nfig_pp <- pp_tidy |> \n  mutate(model = factor(model, \n                        levels = \"roc_auc\",\n                        labels = \"Week 4\")) |> \n  ggplot() + \n  geom_histogram(aes(x = posterior, fill = model), \n                 color = \"black\", alpha = .4, \n                 bins = 30) +\n  geom_segment(mapping = aes(y = y + 100, yend = y - 100, \n                             x = mean, xend = mean,\n                             color = model),\n               data = ci_week4) +\n  geom_segment(mapping = aes(y = y, yend = y, \n                             x = lower, xend = upper, \n                             color = model),\n               data = ci_week4) +\n  scale_y_continuous(\"Posterior Probability\", \n                     breaks = c(0, 250, 500, 750)) +\n  xlab(\"Area Under ROC Curve\") +\n  theme(legend.position = \"none\")\n```\n:::\n\n\n## Combine into single figure\n\n\n::: {#cell-fig-combined .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-combined\n#| fig-height: 10\n#| fig-cap: \"Gaylen\"\n\npatchwork <- fig_roc + fig_cal_bins + fig_pp\n\npatchwork + plot_annotation(\n  title = \"Model Performance\",\n  tag_levels = c(\"A\", \"B\", \"C\")\n) +\n  plot_layout(ncol = 1, heights = unit(c(2.5,2.5,2.5), 'in'))\n```\n\n::: {.cell-output-display}\n![Gaylen](mak_fig_1_files/figure-html/fig-combined-1.png){#fig-combined width=672}\n:::\n:::\n",
    "supporting": [
      "mak_fig_1_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}