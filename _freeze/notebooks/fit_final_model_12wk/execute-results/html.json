{
  "hash": "0e607090d3c9809fe6c0cfd2db853cbe",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Fits and characterizes final model for 12-week outcome\"\nauthor: \"Gaylen Fronk\"\ndate: \"2024-06-04\"\noutput: \n  html_document:\n    toc: true \n    toc_depth: 4\nformat:\n  html:\n    embed-resources: true\neditor_options: \n  chunk_output_type: console\n---\n\n\n### Set Up Environment\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nstudy <- \"match\"\nversion <- \"v6\"\ncv <- \"kfold\"\ny_col_name <- \"pp_hybrid_wk12_outcome\"\n```\n:::\n\n\nPackages for script\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\nlibrary(tidymodels)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n── Attaching packages ────────────────────────────────────── tidymodels 1.2.0 ──\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n✔ broom        1.0.5      ✔ recipes      1.0.10\n✔ dials        1.2.1      ✔ rsample      1.2.1 \n✔ dplyr        1.1.4      ✔ tibble       3.2.1 \n✔ ggplot2      3.5.1      ✔ tidyr        1.3.1 \n✔ infer        1.0.7      ✔ tune         1.2.1 \n✔ modeldata    1.3.0      ✔ workflows    1.1.4 \n✔ parsnip      1.2.1      ✔ workflowsets 1.1.0 \n✔ purrr        1.0.2      ✔ yardstick    1.3.1 \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n── Conflicts ───────────────────────────────────────── tidymodels_conflicts() ──\n✖ purrr::discard() masks scales::discard()\n✖ dplyr::filter()  masks stats::filter()\n✖ dplyr::lag()     masks stats::lag()\n✖ recipes::step()  masks stats::step()\n• Use tidymodels_prefer() to resolve common conflicts.\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ forcats   1.0.0     ✔ readr     2.1.5\n✔ lubridate 1.9.3     ✔ stringr   1.5.1\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ readr::col_factor() masks scales::col_factor()\n✖ purrr::discard()    masks scales::discard()\n✖ dplyr::filter()     masks stats::filter()\n✖ stringr::fixed()    masks recipes::fixed()\n✖ dplyr::lag()        masks stats::lag()\n✖ readr::spec()       masks yardstick::spec()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\nlibrary(Matrix)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n\nAttaching package: 'Matrix'\n\nThe following objects are masked from 'package:tidyr':\n\n    expand, pack, unpack\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\nlibrary(probably)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n\nAttaching package: 'probably'\n\nThe following objects are masked from 'package:base':\n\n    as.factor, as.ordered\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\nlibrary(here)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nhere() starts at C:/Users/gfronk/Documents/GitHub/study_match\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\ndevtools::source_url(\"https://github.com/jjcurtin/lab_support/blob/main/fun_eda.R?raw=true\")\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nℹ SHA-1 hash of file is \"c045eee2655a18dc85e715b78182f176327358a7\"\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\ndevtools::source_url(\"https://github.com/jjcurtin/lab_support/blob/main/chtc/static_files/fun_chtc.R?raw=true\")\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nℹ SHA-1 hash of file is \"75cc6f7b855da59c240908bd936834b4da01285b\"\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\ntheme_set(theme_classic()) \n```\n:::\n\n\nHandle conflicts\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\noptions(conflicts.policy = \"depends.ok\")\n```\n:::\n\n\nAbsolute paths\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nswitch (Sys.info()[['sysname']],\n        # PC paths\n        Windows = {\n          path_input <- stringr::str_c(\"P:/studydata/match/chtc/\", \n                                       y_col_name)\n          path_models <- stringr::str_c(\"P:/studydata/match/models/\", \n                                        y_col_name)},\n        \n        # IOS paths\n        Darwin = {\n          path_input <- stringr::str_c(\"/Volumes/private/studydata/match/chtc/\", \n                                       y_col_name)\n          path_models <- stringr::str_c(\"/Volumes/private/studydata/match/models/\", \n                                        y_col_name)},\n        \n        # Linux paths\n        Linux = {\n          path_input <- stringr::str_c(\"~/mnt/private/studydata/match/chtc/\", \n                                       y_col_name)\n          path_models <- stringr::str_c(\"~/mnt/private/studydata/match/models/\", \n                                        y_col_name)}\n)\n```\n:::\n\n\nChunk Defaults\n\n\n::: {.cell .hidden}\n\n```{.r .cell-code .hidden}\n#| include: false\n\nknitr::opts_chunk$set(attr.output='style=\"max-height: 500px;\"')\n\noptions(tibble.width = Inf)\noptions(tibble.print_max = Inf)\n```\n:::\n\n\n### Read in best configuration\n\nSelected in 1_metrics_inner (k-fold CV)\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nbest_config <- read_csv(file.path(path_models, \n                                  str_c(\"best_config_\", version, \".csv\")),\n                        show_col_types = FALSE)\n\nglimpse(best_config)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```{style=\"max-height: 500px;\"}\nRows: 1\nColumns: 9\n$ n_jobs      <dbl> 10\n$ algorithm   <chr> \"glmnet_manual\"\n$ feature_set <chr> \"scale_dummy\"\n$ hp1         <dbl> 0.1\n$ hp2         <dbl> 0.1542244\n$ hp3         <lgl> NA\n$ resample    <chr> \"none\"\n$ roc_auc     <dbl> 0.6830971\n$ n_tx        <dbl> 50\n```\n\n\n:::\n:::\n\n\n### Fit best model in full dataset\n\n**NOTE**: This model will only be used for 1) examining parameter estimates, and 2) ultimate dissemination.\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nbatch_names <- list.dirs(path_input, full.names = FALSE, recursive = FALSE) \n\nbatch_name <- batch_names[str_detect(batch_names, \"train\") & \n                            str_detect(batch_names, cv) &\n                            str_detect(batch_names, version) &\n                            str_detect(batch_names, best_config$algorithm)] \n\npath_batch <- file.path(path_input, batch_name)\nsource(file.path(path_batch, \"input\", \"training_controls.R\"))\n\nd <- read_csv(file.path(path_batch, \"input\", \"data_trn.csv\"), \n              show_col_types = FALSE) \n\nd_outcomes <- d |> \n  select(subid, ends_with(\"outcome\") & contains(\"hybrid\"))\n\nd <- format_data(d) \n\nrec <- build_recipe(d = d, config = best_config)\n\nrec_prepped_full <- rec |> \n  prep(training = d, strings_as_factors = FALSE)\n\nfeat_all <- rec_prepped_full |> \n  bake(new_data = NULL)\n\nmodel_best_full <- fit_best_model(best_model = best_config, \n                                  feat = feat_all, \n                                  ml_mode = \"classification\")\n```\n:::\n\n\n### Model coefficients\n\n**NOTE**: Coefficients are naturally inverted (i.e., positive class [abstinence] treated as first [vs. second] class). Here, we multiply coefficients by -1 to align the direction of coefficients with the rest of our analyses. Once flipped (i.e., as they appear below)...\n\nA *positive coefficient* indicates that increases in the feature *increase* the likelihood of abstinence. For example, increases in motivation to quit (\"motive_quit_order\") *increase* the likelihood of abstinence.\n\nA *negative coefficient* indicates that increases in the feature *decrease* the likelihood of smoking. For example, increases in carbon monoxide (\"co\") *decrease* the likelihood of abstinence.\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nmodel_tidy <- tidy(model_best_full)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nLoaded glmnet 4.1-8\n```\n\n\n:::\n:::\n\n::: {#tbl-retained-vars-12wk .cell}\n\n```{.r .cell-code .hidden}\n#| label: tbl-retained-vars-12wk\n#| fig-cap: \"Supplemental Table 2: Retained features in 12-week final model\"\nretained_vars <- model_tidy |> \n  mutate(estimate = estimate * -1) |> \n  filter(abs(estimate) > 0) |> \n  select(-penalty) |> \n  arrange(desc(abs(estimate)))\n\nknitr::kable(retained_vars, digits = 4)\n```\n\n::: {.cell-output-display}\n\n\n|term                                                                   | estimate|\n|:----------------------------------------------------------------------|--------:|\n|(Intercept)                                                            |  -0.9527|\n|co                                                                     |  -0.1268|\n|race_ehr_white                                                         |   0.1130|\n|wisdm37_en_goad_scale                                                  |  -0.0791|\n|treatment_varenicline_x_confident_quit_order_09                        |   0.0730|\n|age_ehr                                                                |   0.0696|\n|wsws_crave_scale                                                       |  -0.0677|\n|alc_qty_order_09                                                       |   0.0571|\n|race_ehr_black_african_american                                        |  -0.0569|\n|alc_freq_order_02                                                      |   0.0524|\n|treatment_varenicline_x_income_order_1                                 |  -0.0522|\n|longest_quit_order_2                                                   |  -0.0496|\n|life_satisfaction_order_2                                              |  -0.0473|\n|confident_quit_order_09                                                |   0.0470|\n|time_around_smokers_order_1                                            |   0.0465|\n|income_order_1                                                         |  -0.0464|\n|motive_quit_order_10                                                   |   0.0461|\n|treatment_patch_x_time_around_smokers_order_3                          |  -0.0431|\n|last_rct_quit_order_7                                                  |  -0.0421|\n|treatment_varenicline_x_marital_status_ehr_divorced                    |  -0.0419|\n|treatment_combo_nrt_x_alc_freq_order_10                                |   0.0409|\n|wisdm37_tolerance_scale                                                |  -0.0408|\n|smoke_menthol_no                                                       |   0.0374|\n|sip2r_total_scale                                                      |  -0.0360|\n|shp_total_scale                                                        |   0.0358|\n|treatment_varenicline_x_berlin_7_order_2                               |   0.0332|\n|employment_unemployed                                                  |  -0.0327|\n|treatment_combo_nrt_x_smoke_menthol_yes                                |  -0.0327|\n|time_around_smokers_order_3                                            |  -0.0323|\n|treatment_combo_nrt_x_berlin_7_order_5                                 |   0.0315|\n|alc_freq_order_05                                                      |  -0.0314|\n|treatment_patch_x_tried_chantix_yes                                    |  -0.0309|\n|smoke_menthol_yes                                                      |  -0.0303|\n|alc_binge_order_06                                                     |  -0.0299|\n|treatment_varenicline_x_used_pipe_tried                                |   0.0296|\n|hdsm_pain                                                              |  -0.0290|\n|treatment_combo_nrt_x_last_rct_quit_order_5                            |   0.0286|\n|treatment_combo_nrt_x_time_around_smokers_weekend_order_4              |  -0.0281|\n|years_smoke                                                            |   0.0277|\n|cigs_per_day_heaviest                                                  |  -0.0275|\n|live_with_smoker_yes                                                   |  -0.0272|\n|hdsm_tired                                                             |  -0.0259|\n|life_satisfaction_order_5                                              |   0.0254|\n|tot_quit_attempt                                                       |   0.0235|\n|treatment_combo_nrt_x_time_around_smokers_weekend_order_2              |   0.0227|\n|treatment_varenicline_x_alc_qty_order_09                               |   0.0225|\n|alc_binge_order_08                                                     |   0.0215|\n|wsws_hunger_scale                                                      |   0.0213|\n|life_enjoyment_order_3                                                 |  -0.0205|\n|alc_freq_order_10                                                      |   0.0188|\n|treatment_combo_nrt_x_motive_quit_order_09                             |  -0.0170|\n|treatment_varenicline_x_life_satisfaction_order_5                      |   0.0160|\n|treatment_varenicline_x_race_ehr_white                                 |   0.0159|\n|motive_quit_order_09                                                   |  -0.0159|\n|treatment_combo_nrt_x_longest_quit_order_2                             |  -0.0158|\n|longest_quit_order_8                                                   |   0.0148|\n|time_around_smokers_order_5                                            |  -0.0140|\n|treatment_combo_nrt_x_smoke_menthol_no                                 |   0.0131|\n|last_rct_quit_order_6                                                  |   0.0126|\n|longest_quit_order_4                                                   |  -0.0125|\n|cigs_per_day                                                           |  -0.0123|\n|treatment_patch_x_tried_zyban_yes                                      |  -0.0114|\n|alc_freq_order_08                                                      |   0.0109|\n|marital_status_ehr_married                                             |   0.0104|\n|treatment_varenicline_x_used_e_cig_never_tried                         |   0.0097|\n|phq9_severity_scale_order_2                                            |  -0.0092|\n|treatment_varenicline_x_life_enjoyment_order_4                         |   0.0090|\n|dts_absorption_scale                                                   |  -0.0080|\n|wisdm37_auto_scale                                                     |  -0.0077|\n|used_pipe_never_tried                                                  |  -0.0074|\n|treatment_combo_nrt_x_live_with_smoker_live_alone_or_only_with_partner |   0.0074|\n|treatment_patch_x_psych_depression_yes                                 |  -0.0068|\n|treatment_varenicline_x_time_around_smokers_order_4                    |   0.0067|\n|treatment_varenicline_x_motive_quit_order_10                           |   0.0067|\n|treatment_varenicline_x_quit_success_30d_order_7                       |   0.0067|\n|treatment_combo_nrt_x_life_enjoyment_order_7                           |   0.0065|\n|treatment_varenicline_x_income_order_6                                 |   0.0062|\n|life_enjoyment_order_5                                                 |  -0.0062|\n|dts_tolerance_scale                                                    |  -0.0059|\n|treatment_combo_nrt_x_confident_quit_order_10                          |  -0.0047|\n|time_around_smokers_weekend_order_2                                    |   0.0047|\n|treatment_combo_nrt_x_life_satisfaction_order_5                        |   0.0045|\n|treatment_varenicline_x_work_ban_no_smoking_allowed                    |   0.0041|\n|treatment_combo_nrt_x_psych_depression_yes                             |  -0.0036|\n|treatment_patch_x_close_smoke_co_worker_yes                            |   0.0034|\n|income_order_7                                                         |   0.0031|\n|treatment_combo_nrt_x_time_around_smokers_weekend_order_1              |   0.0031|\n|dts_regulation_scale                                                   |  -0.0031|\n|treatment_varenicline_x_employment_employed_full_time                  |   0.0029|\n|treatment_varenicline_x_life_enjoyment_order_5                         |  -0.0028|\n|treatment_combo_nrt_x_motive_quit_order_10                             |   0.0027|\n|close_smoke_friend_yes                                                 |   0.0023|\n|close_smoke_friend_no                                                  |  -0.0023|\n|hrqol_1_order_4                                                        |   0.0022|\n|used_pipe_tried                                                        |   0.0020|\n|treatment_patch_x_spouse_smoke_yes                                     |  -0.0018|\n|confident_quit_order_07                                                |   0.0017|\n|berlin_7_order_4                                                       |  -0.0014|\n|treatment_varenicline_x_alc_binge_order_09                             |   0.0013|\n|treatment_patch_x_close_smoke_friend_no                                |  -0.0012|\n|treatment_varenicline_x_employment_unemployed                          |  -0.0011|\n|phq9_severity_scale_order_3                                            |   0.0011|\n|hrqol_2                                                                |  -0.0010|\n|treatment_patch_x_time_around_smokers_weekend_order_3                  |  -0.0009|\n|treatment_combo_nrt_x_berlin_6_order_3                                 |   0.0009|\n|treatment_varenicline_x_marital_status_ehr_married                     |   0.0006|\n|longest_quit_order_5                                                   |   0.0004|\n|alc_freq_order_03                                                      |  -0.0003|\n|treatment_combo_nrt_x_marital_status_ehr_never_married                 |  -0.0002|\n|wisdm37_cue_scale                                                      |  -0.0002|\n|treatment_varenicline_x_spouse_smoke_no                                |   0.0001|\n\n\n\nSupplemental Table 2: Retained features in 12-week final model\n:::\n:::\n\n17.18% of features were retained by the glmnet solution (111 features of a total considered 646 features).\n\n\n::: {#tbl-retained-tx-12wk .cell}\n\n```{.r .cell-code .hidden}\n#| label: tbl-retained-tx-12wk\nretained_vars_tx <- retained_vars |> \n  filter(str_detect(term, \"treatment_\")) |> \n  arrange(desc(abs(estimate))) \n\nknitr::kable(retained_vars_tx, digits = 4)\n```\n\n::: {.cell-output-display}\n\n\n|term                                                                   | estimate|\n|:----------------------------------------------------------------------|--------:|\n|treatment_varenicline_x_confident_quit_order_09                        |   0.0730|\n|treatment_varenicline_x_income_order_1                                 |  -0.0522|\n|treatment_patch_x_time_around_smokers_order_3                          |  -0.0431|\n|treatment_varenicline_x_marital_status_ehr_divorced                    |  -0.0419|\n|treatment_combo_nrt_x_alc_freq_order_10                                |   0.0409|\n|treatment_varenicline_x_berlin_7_order_2                               |   0.0332|\n|treatment_combo_nrt_x_smoke_menthol_yes                                |  -0.0327|\n|treatment_combo_nrt_x_berlin_7_order_5                                 |   0.0315|\n|treatment_patch_x_tried_chantix_yes                                    |  -0.0309|\n|treatment_varenicline_x_used_pipe_tried                                |   0.0296|\n|treatment_combo_nrt_x_last_rct_quit_order_5                            |   0.0286|\n|treatment_combo_nrt_x_time_around_smokers_weekend_order_4              |  -0.0281|\n|treatment_combo_nrt_x_time_around_smokers_weekend_order_2              |   0.0227|\n|treatment_varenicline_x_alc_qty_order_09                               |   0.0225|\n|treatment_combo_nrt_x_motive_quit_order_09                             |  -0.0170|\n|treatment_varenicline_x_life_satisfaction_order_5                      |   0.0160|\n|treatment_varenicline_x_race_ehr_white                                 |   0.0159|\n|treatment_combo_nrt_x_longest_quit_order_2                             |  -0.0158|\n|treatment_combo_nrt_x_smoke_menthol_no                                 |   0.0131|\n|treatment_patch_x_tried_zyban_yes                                      |  -0.0114|\n|treatment_varenicline_x_used_e_cig_never_tried                         |   0.0097|\n|treatment_varenicline_x_life_enjoyment_order_4                         |   0.0090|\n|treatment_combo_nrt_x_live_with_smoker_live_alone_or_only_with_partner |   0.0074|\n|treatment_patch_x_psych_depression_yes                                 |  -0.0068|\n|treatment_varenicline_x_time_around_smokers_order_4                    |   0.0067|\n|treatment_varenicline_x_motive_quit_order_10                           |   0.0067|\n|treatment_varenicline_x_quit_success_30d_order_7                       |   0.0067|\n|treatment_combo_nrt_x_life_enjoyment_order_7                           |   0.0065|\n|treatment_varenicline_x_income_order_6                                 |   0.0062|\n|treatment_combo_nrt_x_confident_quit_order_10                          |  -0.0047|\n|treatment_combo_nrt_x_life_satisfaction_order_5                        |   0.0045|\n|treatment_varenicline_x_work_ban_no_smoking_allowed                    |   0.0041|\n|treatment_combo_nrt_x_psych_depression_yes                             |  -0.0036|\n|treatment_patch_x_close_smoke_co_worker_yes                            |   0.0034|\n|treatment_combo_nrt_x_time_around_smokers_weekend_order_1              |   0.0031|\n|treatment_varenicline_x_employment_employed_full_time                  |   0.0029|\n|treatment_varenicline_x_life_enjoyment_order_5                         |  -0.0028|\n|treatment_combo_nrt_x_motive_quit_order_10                             |   0.0027|\n|treatment_patch_x_spouse_smoke_yes                                     |  -0.0018|\n|treatment_varenicline_x_alc_binge_order_09                             |   0.0013|\n|treatment_patch_x_close_smoke_friend_no                                |  -0.0012|\n|treatment_varenicline_x_employment_unemployed                          |  -0.0011|\n|treatment_patch_x_time_around_smokers_weekend_order_3                  |  -0.0009|\n|treatment_combo_nrt_x_berlin_6_order_3                                 |   0.0009|\n|treatment_varenicline_x_marital_status_ehr_married                     |   0.0006|\n|treatment_combo_nrt_x_marital_status_ehr_never_married                 |  -0.0002|\n|treatment_varenicline_x_spouse_smoke_no                                |   0.0001|\n\n\n:::\n:::\n\n42.34% of the retained features were treatment interaction features (47 treatment features of 111 retained features). Of the 435 available treatment interaction features, 11% were retained.\n\n### Calculate and calibrate probabilities\n\nMake triplicate dataset\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nd_patch <- d |> \n  mutate(treatment = \"patch\") \n\nd_combo <- d |> \n  mutate(treatment = \"combo_nrt\")\n\nd_varen <- d |> \n  mutate(treatment = \"varenicline\")\n\nd_trip <- bind_rows(d_patch, d_combo) |> \n  bind_rows(d_varen) |> \n  mutate(treatment = factor(treatment, \n                            levels = c(\n                              \"patch\",\n                              \"varenicline\",\n                              \"combo_nrt\")))\n```\n:::\n\n\nMake function to: 1) hold out each sub once, 2) fit model with remaining 1085 subs, 3) get 3 raw predictions for held-out sub, 4) get calibrated predictions for held-out sub\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nget_triple_probs <- function(i_sub, best_config, d, d_trip){\n  \n  # hold out single subject\n  d_out <- d_trip |> \n    filter(subid == i_sub)\n  \n  d_in <- d |> \n    filter(subid != i_sub)\n  \n  # prep recipe \n  rec <- build_recipe(d = d_in, config = best_config)\n  rec_prepped <- rec |> \n    prep(training = d_in, strings_as_factors = FALSE)\n  \n  # bake feat_in and feat_out\n  feat_in <- rec_prepped |> \n    bake(new_data = NULL)\n  \n  feat_out <- rec_prepped |> \n    bake(new_data = d_out)\n  \n  # fit model\n  model_best <- fit_best_model(best_config, feat = feat_in,\n                               \"classification\")\n  \n  # raw (uncalibrated) predictions\n  preds_prob <- predict(model_best, feat_out,\n                        type = \"prob\")\n  \n  # fit calibration model\n  set.seed(2468)\n  cal_split <- d_in |> \n    initial_split(prop = 3/4, strata = y)\n  d_cal_in <- training(cal_split) \n  d_cal_out <- testing(cal_split)\n  \n  rec_cal_prepped <- rec |> \n    prep(training = d_cal_in, strings_as_factors = FALSE)\n  \n  feat_cal_in <- rec_cal_prepped |> \n    bake(new_data = NULL) \n  \n  feat_cal_out <- rec_cal_prepped |> \n    bake(new_data = d_cal_out) \n  \n  model_cal <- fit_best_model(best_config, feat = feat_cal_in, \"classification\")\n  \n  # beta calibration\n  beta <- predict(model_cal, feat_cal_out,\n                  type = \"prob\") |>\n    mutate(truth = feat_cal_out$y) |>\n    cal_estimate_beta(truth = truth,\n                      estimate = dplyr::starts_with(\".pred_\"),\n                      smooth = TRUE)\n  preds_prob_beta <- preds_prob |>\n    cal_apply(beta)\n  \n  # iso calibration\n  iso <- predict(model_cal, feat_cal_out,\n                 type = \"prob\") |>\n    mutate(truth = feat_cal_out$y) |>\n    cal_estimate_isotonic(truth = truth,\n                          estimate = dplyr::starts_with(\".pred_\"))\n  preds_prob_iso <- preds_prob |>\n    cal_apply(iso)\n  \n  # logistic calibration\n  logi <- predict(model_cal, feat_cal_out,\n                  type = \"prob\") |>\n    mutate(truth = feat_cal_out$y) |>\n    cal_estimate_logistic(truth = truth,\n                          estimate = dplyr::starts_with(\".pred_\"),\n                          smooth = TRUE)\n  preds_prob_logi <- preds_prob |>\n    cal_apply(logi)\n  \n  # combine raw and calibrated probs\n  probs <- tibble(subid = d_out$subid,\n                  tx = d_out$treatment,\n                  prob_raw = preds_prob[[str_c(\".pred_\", y_level_pos)]],\n                  prob_beta = preds_prob_beta[[str_c(\".pred_\", y_level_pos)]],\n                  prob_iso = preds_prob_iso[[str_c(\".pred_\", y_level_pos)]],\n                  prob_logi = preds_prob_logi[[str_c(\".pred_\", y_level_pos)]]) \n}\n```\n:::\n\n\nMap over participants so that each is held-out once\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nif(file.exists(file.path(path_models, \n                         str_c(\"trip_probs_\", version, \".csv\")))) {\n  all_probs <- read_csv(file.path(path_models, \n                                  str_c(\"trip_probs_\", version, \".csv\")),\n                        show_col_types = FALSE)\n} else {\n  all_probs <- d$subid |> \n    map(\\(i_sub) get_triple_probs(i_sub, best_config, d, d_trip)) |> \n    list_rbind()\n  \n  all_probs |> \n    write_csv(file.path(path_models, \n                        str_c(\"trip_probs_\", version, \".csv\")))\n}\n```\n:::\n\n\n### Make AIM 2 Dataset\n\nPivot probabilities into wide format & select only raw probability (based on calibration validity check below)\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nraw_probs_wide <- all_probs |> \n  select(subid, tx, prob_raw) |> \n  pivot_wider(names_prefix = \"prob_\",\n              names_from = tx,\n              values_from = prob_raw)\n\nglimpse(raw_probs_wide)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```{style=\"max-height: 500px;\"}\nRows: 1,086\nColumns: 4\n$ subid            <dbl> 20010, 20015, 20030, 20049, 20051, 20072, 20077, 2008…\n$ prob_patch       <dbl> 0.1610573, 0.3272543, 0.2825550, 0.3491451, 0.4286955…\n$ prob_combo_nrt   <dbl> 0.1860530, 0.3877443, 0.3185973, 0.4018380, 0.4309108…\n$ prob_varenicline <dbl> 0.1601103, 0.5184533, 0.2743758, 0.4938523, 0.4883779…\n```\n\n\n:::\n:::\n\n\nJoin with d & create new variables\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nset.seed(52592)\nd_aim_2 <- d |> \n  select(subid, tx_rct = treatment, outcome_rct_wk12 = y) |> \n  left_join(raw_probs_wide, by = \"subid\") |> \n    mutate(tx_best = case_when(\n    prob_patch > prob_combo_nrt & prob_patch > prob_varenicline ~ \"patch\",\n    prob_combo_nrt > prob_patch & prob_combo_nrt > prob_varenicline ~ \"combo_nrt\",\n    prob_varenicline > prob_patch & prob_varenicline > prob_combo_nrt ~ \"varenicline\",\n    TRUE ~ NA_character_\n  )) |> \n  # handle ties (prefer CNRT and varenicline per clinical guidelines)\n  # sample among those if tied\n  mutate(tx_best = if_else(is.na(tx_best), case_when(\n    prob_patch == prob_combo_nrt ~ \"combo_nrt\",\n    prob_patch == prob_varenicline ~ \"varenicline\",\n    prob_combo_nrt == prob_varenicline ~ sample(c(\"combo_nrt\",\n                                                  \"varenicline\"), 1),\n    TRUE ~ NA_character_\n  ), tx_best)) |>  \n  mutate(prob_best = case_when(\n    tx_best == \"patch\" ~ prob_patch,\n    tx_best == \"combo_nrt\" ~ prob_combo_nrt,\n    tx_best == \"varenicline\" ~ prob_varenicline,\n    TRUE ~ NA_real_\n  )) |> \n  mutate(tx_best = factor(tx_best, \n                          levels = c(\n                            \"patch\",\n                            \"varenicline\",\n                            \"combo_nrt\"))) |> \n  mutate(tx_match = if_else(tx_best == tx_rct, TRUE, FALSE)) |> \n  left_join(d_outcomes, by = \"subid\") |> \n  select(-pp_hybrid_wk12_outcome, -pp_hybrid_wk1_outcome, \n         -pp_hybrid_yr3_outcome, -pp_hybrid_wk52_outcome) |> \n  rename(outcome_rct_wk4 = pp_hybrid_wk4_outcome,\n         outcome_rct_wk26 = pp_hybrid_wk26_outcome) |> \n  relocate(subid, tx_rct, tx_best, tx_match,\n           prob_best, starts_with(\"outcome\"), starts_with(\"prob\"))\n\nglimpse(d_aim_2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```{style=\"max-height: 500px;\"}\nRows: 1,086\nColumns: 11\n$ subid            <dbl> 20010, 20015, 20030, 20049, 20051, 20072, 20077, 2008…\n$ tx_rct           <fct> patch, combo_nrt, patch, varenicline, patch, combo_nr…\n$ tx_best          <fct> combo_nrt, varenicline, combo_nrt, varenicline, varen…\n$ tx_match         <lgl> FALSE, FALSE, FALSE, TRUE, FALSE, FALSE, FALSE, FALSE…\n$ prob_best        <dbl> 0.1860530, 0.5184533, 0.3185973, 0.4938523, 0.4883779…\n$ outcome_rct_wk12 <fct> smoking, smoking, smoking, abstinent, smoking, smokin…\n$ outcome_rct_wk4  <chr> \"smoking\", \"smoking\", \"smoking\", \"smoking\", \"smoking\"…\n$ outcome_rct_wk26 <chr> \"smoking\", \"smoking\", \"smoking\", \"abstinent\", \"smokin…\n$ prob_patch       <dbl> 0.1610573, 0.3272543, 0.2825550, 0.3491451, 0.4286955…\n$ prob_combo_nrt   <dbl> 0.1860530, 0.3877443, 0.3185973, 0.4018380, 0.4309108…\n$ prob_varenicline <dbl> 0.1601103, 0.5184533, 0.2743758, 0.4938523, 0.4883779…\n```\n\n\n:::\n:::\n\n\nQuick EDA checks\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n# confirm logic worked as expected\nhead(d_aim_2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```{style=\"max-height: 500px;\"}\n# A tibble: 6 × 11\n  subid tx_rct      tx_best     tx_match prob_best outcome_rct_wk12\n  <dbl> <fct>       <fct>       <lgl>        <dbl> <fct>           \n1 20010 patch       combo_nrt   FALSE        0.186 smoking         \n2 20015 combo_nrt   varenicline FALSE        0.518 smoking         \n3 20030 patch       combo_nrt   FALSE        0.319 smoking         \n4 20049 varenicline varenicline TRUE         0.494 abstinent       \n5 20051 patch       varenicline FALSE        0.488 smoking         \n6 20072 combo_nrt   varenicline FALSE        0.467 smoking         \n  outcome_rct_wk4 outcome_rct_wk26 prob_patch prob_combo_nrt prob_varenicline\n  <chr>           <chr>                 <dbl>          <dbl>            <dbl>\n1 smoking         smoking               0.161          0.186            0.160\n2 smoking         smoking               0.327          0.388            0.518\n3 smoking         smoking               0.283          0.319            0.274\n4 smoking         abstinent             0.349          0.402            0.494\n5 smoking         smoking               0.429          0.431            0.488\n6 smoking         smoking               0.293          0.360            0.467\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n# check on variability of best tx\nd_aim_2 |> \n  tab(tx_best)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```{style=\"max-height: 500px;\"}\n# A tibble: 3 × 3\n  tx_best         n   prop\n  <fct>       <int>  <dbl>\n1 patch          68 0.0626\n2 varenicline   689 0.634 \n3 combo_nrt     329 0.303 \n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n# check on variability of tx matching\nd_aim_2 |> \n  tab(tx_match)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```{style=\"max-height: 500px;\"}\n# A tibble: 2 × 3\n  tx_match     n  prop\n  <lgl>    <int> <dbl>\n1 FALSE      679 0.625\n2 TRUE       407 0.375\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n# variability of matching within assigned (RCT) tx\nd_aim_2 |> \n  group_by(tx_rct) |> \n  tab(tx_match)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```{style=\"max-height: 500px;\"}\n# A tibble: 6 × 4\n# Groups:   tx_rct [3]\n  tx_rct      tx_match     n   prop\n  <fct>       <lgl>    <int>  <dbl>\n1 patch       FALSE      227 0.942 \n2 patch       TRUE        14 0.0581\n3 varenicline FALSE      154 0.363 \n4 varenicline TRUE       270 0.637 \n5 combo_nrt   FALSE      298 0.708 \n6 combo_nrt   TRUE       123 0.292 \n```\n\n\n:::\n:::\n\n\nWrite out\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nd_aim_2 |> \n  write_csv(file.path(path_models, str_c(\"aim_2_\", version, \"_\", \n                                         y_col_name, \".csv\")))\n```\n:::\n\n\n### Validity check: Model Calibration\n\nMake wide format for all calibrated probabilities\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nall_probs_wide <- all_probs |> \n  rename_with(~ str_replace(.x, \"prob_\", \"\"), .cols = starts_with(\"prob_\")) |> \n  pivot_wider(\n    names_from = tx,\n    values_from = c(raw, beta, iso, logi),\n    names_glue = \"{.value}_{tx}\"\n  )\n```\n:::\n\n\nSet up validity check data\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nd_valid <- d_aim_2 |> \n  select(subid, tx_rct, outcome_rct_wk12) |> \n  left_join(all_probs_wide, by = \"subid\") |> \n  mutate(beta = case_when(\n    tx_rct == \"patch\" ~ beta_patch,\n    tx_rct == \"combo_nrt\" ~ beta_combo_nrt,\n    tx_rct == \"varenicline\" ~ beta_varenicline,\n    TRUE ~ NA_real_\n  ),\n  raw = case_when(\n    tx_rct == \"patch\" ~ raw_patch,\n    tx_rct == \"combo_nrt\" ~ raw_combo_nrt,\n    tx_rct == \"varenicline\" ~ raw_varenicline,\n    TRUE ~ NA_real_\n  ),\n  isotonic = case_when(\n    tx_rct == \"patch\" ~ iso_patch,\n    tx_rct == \"combo_nrt\" ~ iso_combo_nrt,\n    tx_rct == \"varenicline\" ~ iso_varenicline,\n    TRUE ~ NA_real_\n  ),\n  logistic = case_when(\n    tx_rct == \"patch\" ~ logi_patch,\n    tx_rct == \"combo_nrt\" ~ logi_combo_nrt,\n    tx_rct == \"varenicline\" ~ logi_varenicline,\n    TRUE ~ NA_real_\n  )) |> \n  select(subid, outcome_rct_wk12, beta, raw, isotonic, logistic) \n```\n:::\n\n\n#### Comparison of means\n\nCompare mean abstinence from RCT to predicted probabilities for RCT tx across calibrations\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nd_valid |> \n  mutate(outcome_rct = if_else(outcome_rct_wk12 == \"abstinent\", 1, 0)) |> \n  summarize(mean_rct = mean(outcome_rct),\n            mean_beta = mean(beta),\n            mean_iso = mean(isotonic),\n            mean_logi = mean(logistic),\n            mean_raw = mean(raw))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```{style=\"max-height: 500px;\"}\n# A tibble: 1 × 5\n  mean_rct mean_beta mean_iso mean_logi mean_raw\n     <dbl>     <dbl>    <dbl>     <dbl>    <dbl>\n1    0.290     0.284    0.205     0.288    0.290\n```\n\n\n:::\n:::\n\nRaw probabilities match best, though beta and logistic calibration are close.\n\n#### Plots\n\nPivot data longer for required format\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nd_plot <- d_valid |> \n  pivot_longer(\n    cols = c(beta, raw, isotonic, logistic),\n    names_to = \"method\",\n    values_to = \".pred_abstinent\"\n  )\n```\n:::\n\n\nMake plots by calibration method\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nd_plot |> \n  cal_plot_breaks(truth = outcome_rct_wk12, \n                  estimate = .pred_abstinent,\n                  .by = method)\n```\n\n::: {.cell-output-display}\n![](fit_final_model_12wk_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n\n```{.r .cell-code .hidden}\nd_plot |> \n  cal_plot_windowed(truth = outcome_rct_wk12, \n                    estimate = .pred_abstinent,\n                    .by = method)\n```\n\n::: {.cell-output-display}\n![](fit_final_model_12wk_files/figure-html/unnamed-chunk-15-2.png){width=672}\n:::\n:::\n\nRaw and logistic look best. Raw follows the diagonal more closely in the first half, but logistic spans the full range. Upper half of logistic range has a very wide confidence interval/spread.\n\n#### Brier score\n\nBeta calibration\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nbrier_class_vec(truth = d_valid$outcome_rct_wk12,\n                estimate = d_valid$beta)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```{style=\"max-height: 500px;\"}\n[1] 0.1978052\n```\n\n\n:::\n:::\n\n\nLogistic calibration\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nbrier_class_vec(truth = d_valid$outcome_rct_wk12,\n                estimate = d_valid$logistic)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```{style=\"max-height: 500px;\"}\n[1] 0.1993562\n```\n\n\n:::\n:::\n\n\nIsotonic calibration\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nbrier_class_vec(truth = d_valid$outcome_rct_wk12,\n                estimate = d_valid$isotonic)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```{style=\"max-height: 500px;\"}\n[1] 0.21211\n```\n\n\n:::\n:::\n\n\nRaw calibration\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nbrier_class_vec(truth = d_valid$outcome_rct_wk12,\n                estimate = d_valid$raw)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```{style=\"max-height: 500px;\"}\n[1] 0.1916881\n```\n\n\n:::\n:::\n\n\nRaw calibration has the lowest Brier score (though all are relatively similar). In keeping with the other methods above, beta and logistic are next-best followed by isotonic last.\n\n",
    "supporting": [
      "fit_final_model_12wk_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}