{
  "hash": "035b3d0ac9adebbfe022afa31091da48",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Make Figure 1: Model Performance (3-Panel)\"\nauthor: \"Gaylen Fronk\"\ndate: \"2024-06-01\"\nnumber-sections: true\noutput: \n  html_document:\n    toc: true \n    toc_depth: 4\nformat:\n  html:\n    embed-resources: true\n    toc: true\n    toc-depth: 4\neditor_options: \n  chunk_output_type: console\n---\n\n\n## Setup\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nversion <- \"v5\"\ncv <- \"nested\"\ny_col_name <- \"pp_hybrid_wk4_outcome\"\n```\n:::\n\n\nRead in posterior probabilities for Panel B\n\n---\ntitle: \"Posterior probabilities across models for MATCH study\"\nauthor: \"John Curtin\"\ndate: \"2024-06-01\"\nnumber-sections: true\noutput: \n  html_document:\n    toc: true \n    toc_depth: 4\nformat:\n  html:\n    embed-resources: true\n    toc: true\n    toc-depth: 4\neditor_options: \n  chunk_output_type: console\n---\n\n### Code Status\n\nIn use with iterative improvement.\n\nUpdating for use with MATCH\n\n### Notes\nCan review online docs for \n\n* [how to use rstanarm](https://cran.r-project.org/web/packages/rstanarm/vignettes/rstanarm.html)\n* [priors](https://cran.r-project.org/web/packages/rstanarm/vignettes/priors.html)\n* [warnings](https://mc-stan.org/misc/warnings.html)\n* [tutorial on rstanarm and shinystan](https://www.tqmp.org/RegularArticles/vol14-2/p099/p099.pdf)\n* [R Bloggers on perf_mod](https://www.r-bloggers.com/2019/12/tidyposteriors-bayesian-approach-to-model-comparison/)\n\n### Set Up Environment\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nstudy <- \"match\"\nversion <- \"v5\"\ncv <- \"nested\"\n```\n:::\n\nPackages for script\n::: {.cell}\n\n```{.r .cell-code .hidden}\nlibrary(tidyposterior)\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.4     ✔ readr     2.1.5\n✔ forcats   1.0.0     ✔ stringr   1.5.1\n✔ ggplot2   3.5.1     ✔ tibble    3.2.1\n✔ lubridate 1.9.3     ✔ tidyr     1.3.1\n✔ purrr     1.0.2     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nlibrary(tidymodels)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n── Attaching packages ────────────────────────────────────── tidymodels 1.2.0 ──\n✔ broom        1.0.5      ✔ rsample      1.2.1 \n✔ dials        1.2.1      ✔ tune         1.2.1 \n✔ infer        1.0.7      ✔ workflows    1.1.4 \n✔ modeldata    1.3.0      ✔ workflowsets 1.1.0 \n✔ parsnip      1.2.1      ✔ yardstick    1.3.1 \n✔ recipes      1.0.10     \n── Conflicts ───────────────────────────────────────── tidymodels_conflicts() ──\n✖ scales::discard() masks purrr::discard()\n✖ dplyr::filter()   masks stats::filter()\n✖ recipes::fixed()  masks stringr::fixed()\n✖ dplyr::lag()      masks stats::lag()\n✖ yardstick::spec() masks readr::spec()\n✖ recipes::step()   masks stats::step()\n• Dig deeper into tidy modeling with R at https://www.tmwr.org\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\ntheme_set(theme_classic()) \n```\n:::\n\nAbsolute paths\n::: {.cell}\n\n```{.r .cell-code .hidden}\nswitch (Sys.info()[['sysname']],\n        # PC paths\n        Windows = {\n          path_models <- \"P:/studydata/match/models/\"},\n        \n        # IOS paths\n        Darwin = {\n          path_models <- \"/Volumes/private/studydata/match/models/\"},\n        \n        # Linux paths\n        Linux = {\n          path_models <- \"~/mnt/private/studydata/match/models/\"}\n)\n```\n:::\n\n\nChunk Defaults\n::: {.cell .hidden}\n\n```{.r .cell-code .hidden}\nknitr::opts_chunk$set(attr.output='style=\"max-height: 500px;\"')\n\noptions(tibble.width = Inf)\noptions(tibble.print_max = Inf)\n```\n:::\n\n\nSource training controls \n::: {.cell}\n\n```{.r .cell-code .hidden}\n# EDA\ndevtools::source_url(\"https://github.com/jjcurtin/lab_support/blob/main/fun_eda.R?raw=true\")\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nℹ SHA-1 hash of file is \"c045eee2655a18dc85e715b78182f176327358a7\"\n```\n\n\n:::\n:::\n\n\n### Read in preds and metrics for best model\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nauc_wk4 <- read_rds(file.path(path_models, \"pp_hybrid_wk4_outcome\",\n                              str_c(\"outer_metrics_\", \n                                    version, \"_\", cv, \".rds\"))) |> \n  arrange(outer_split_num) |> \n  mutate(repeat_num = rep(str_c(\"repeat\", 1:3), each = 10),\n         fold_num = rep(str_c(\"fold\", 1:10), 3)) |>   # assumes 3x10 fold\n  select(repeat_num, fold_num, roc_auc) |> \n  glimpse()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```{style=\"max-height: 500px;\"}\nRows: 30\nColumns: 3\n$ repeat_num <chr> \"repeat1\", \"repeat1\", \"repeat1\", \"repeat1\", \"repeat1\", \"rep…\n$ fold_num   <chr> \"fold1\", \"fold2\", \"fold3\", \"fold4\", \"fold5\", \"fold6\", \"fold…\n$ roc_auc    <dbl> 0.5890269, 0.7846271, 0.7469794, 0.6510043, 0.7406656, 0.68…\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nauc_wk26 <- read_rds(file.path(path_models, \"pp_hybrid_wk26_outcome\",\n                               str_c(\"outer_metrics_\", \n                                     version, \"_\", cv, \".rds\"))) |> \n  arrange(outer_split_num) |> \n  mutate(repeat_num = rep(str_c(\"repeat\", 1:3), each = 10),\n         fold_num = rep(str_c(\"fold\", 1:10), 3)) |>   # assumes 3x10 fold\n  select(repeat_num, fold_num, roc_auc) |> \n  glimpse()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```{style=\"max-height: 500px;\"}\nRows: 30\nColumns: 3\n$ repeat_num <chr> \"repeat1\", \"repeat1\", \"repeat1\", \"repeat1\", \"repeat1\", \"rep…\n$ fold_num   <chr> \"fold1\", \"fold2\", \"fold3\", \"fold4\", \"fold5\", \"fold6\", \"fold…\n$ roc_auc    <dbl> 0.6405063, 0.6494382, 0.6266667, 0.5597776, 0.6827004, 0.63…\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nauc <- auc_wk4 |> \n  rename(week_4 = roc_auc) |> \n  mutate(week_26 = auc_wk26$roc_auc) |> \n  glimpse()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```{style=\"max-height: 500px;\"}\nRows: 30\nColumns: 4\n$ repeat_num <chr> \"repeat1\", \"repeat1\", \"repeat1\", \"repeat1\", \"repeat1\", \"rep…\n$ fold_num   <chr> \"fold1\", \"fold2\", \"fold3\", \"fold4\", \"fold5\", \"fold6\", \"fold…\n$ week_4     <dbl> 0.5890269, 0.7846271, 0.7469794, 0.6510043, 0.7406656, 0.68…\n$ week_26    <dbl> 0.6405063, 0.6494382, 0.6266667, 0.5597776, 0.6827004, 0.63…\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nauc_wk4 %>% \n  ggplot() + \n  geom_histogram(aes(x = roc_auc), bins = 10)\n```\n\n::: {.cell-output-display}\n![](mak_fig_1_files/figure-html/auc_plots-1.png){width=672}\n:::\n\n```{.r .cell-code .hidden}\nauc_wk26 %>% \n  ggplot() + \n  geom_histogram(aes(x = roc_auc), bins = 10)\n```\n\n::: {.cell-output-display}\n![](mak_fig_1_files/figure-html/auc_plots-2.png){width=672}\n:::\n:::\n\n### All models\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n# from ?perf_mod()\n# Repeated CV (id = repeat, id2 = fold within repeat)\n\nset.seed(101)\npp <- auc |> \n  rename(id = repeat_num,\n         id2 = fold_num) |> \n  perf_mod(formula = statistic ~ model + (1 | id2/id), \n           # prior_intercept = rstanarm::student_t(autoscale = TRUE),\n           # prior = rstanarm::student_t(autoscale = TRUE),\n           transform = tidyposterior::logit_trans,  # for skewed & bounded AUC\n           iter = 2000, chains = 4,  \n           adapt_delta = .99,\n           # cores = 4, seed = 12345,\n           family = gaussian, \n  )  \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```{style=\"max-height: 500px;\"}\n\nSAMPLING FOR MODEL 'continuous' NOW (CHAIN 1).\nChain 1: \nChain 1: Gradient evaluation took 0.00011 seconds\nChain 1: 1000 transitions using 10 leapfrog steps per transition would take 1.1 seconds.\nChain 1: Adjust your expectations accordingly!\nChain 1: \nChain 1: \nChain 1: Iteration:    1 / 2000 [  0%]  (Warmup)\nChain 1: Iteration:  200 / 2000 [ 10%]  (Warmup)\nChain 1: Iteration:  400 / 2000 [ 20%]  (Warmup)\nChain 1: Iteration:  600 / 2000 [ 30%]  (Warmup)\nChain 1: Iteration:  800 / 2000 [ 40%]  (Warmup)\nChain 1: Iteration: 1000 / 2000 [ 50%]  (Warmup)\nChain 1: Iteration: 1001 / 2000 [ 50%]  (Sampling)\nChain 1: Iteration: 1200 / 2000 [ 60%]  (Sampling)\nChain 1: Iteration: 1400 / 2000 [ 70%]  (Sampling)\nChain 1: Iteration: 1600 / 2000 [ 80%]  (Sampling)\nChain 1: Iteration: 1800 / 2000 [ 90%]  (Sampling)\nChain 1: Iteration: 2000 / 2000 [100%]  (Sampling)\nChain 1: \nChain 1:  Elapsed Time: 1.455 seconds (Warm-up)\nChain 1:                0.496 seconds (Sampling)\nChain 1:                1.951 seconds (Total)\nChain 1: \n\nSAMPLING FOR MODEL 'continuous' NOW (CHAIN 2).\nChain 2: \nChain 2: Gradient evaluation took 2.7e-05 seconds\nChain 2: 1000 transitions using 10 leapfrog steps per transition would take 0.27 seconds.\nChain 2: Adjust your expectations accordingly!\nChain 2: \nChain 2: \nChain 2: Iteration:    1 / 2000 [  0%]  (Warmup)\nChain 2: Iteration:  200 / 2000 [ 10%]  (Warmup)\nChain 2: Iteration:  400 / 2000 [ 20%]  (Warmup)\nChain 2: Iteration:  600 / 2000 [ 30%]  (Warmup)\nChain 2: Iteration:  800 / 2000 [ 40%]  (Warmup)\nChain 2: Iteration: 1000 / 2000 [ 50%]  (Warmup)\nChain 2: Iteration: 1001 / 2000 [ 50%]  (Sampling)\nChain 2: Iteration: 1200 / 2000 [ 60%]  (Sampling)\nChain 2: Iteration: 1400 / 2000 [ 70%]  (Sampling)\nChain 2: Iteration: 1600 / 2000 [ 80%]  (Sampling)\nChain 2: Iteration: 1800 / 2000 [ 90%]  (Sampling)\nChain 2: Iteration: 2000 / 2000 [100%]  (Sampling)\nChain 2: \nChain 2:  Elapsed Time: 0.933 seconds (Warm-up)\nChain 2:                0.778 seconds (Sampling)\nChain 2:                1.711 seconds (Total)\nChain 2: \n\nSAMPLING FOR MODEL 'continuous' NOW (CHAIN 3).\nChain 3: \nChain 3: Gradient evaluation took 2.7e-05 seconds\nChain 3: 1000 transitions using 10 leapfrog steps per transition would take 0.27 seconds.\nChain 3: Adjust your expectations accordingly!\nChain 3: \nChain 3: \nChain 3: Iteration:    1 / 2000 [  0%]  (Warmup)\nChain 3: Iteration:  200 / 2000 [ 10%]  (Warmup)\nChain 3: Iteration:  400 / 2000 [ 20%]  (Warmup)\nChain 3: Iteration:  600 / 2000 [ 30%]  (Warmup)\nChain 3: Iteration:  800 / 2000 [ 40%]  (Warmup)\nChain 3: Iteration: 1000 / 2000 [ 50%]  (Warmup)\nChain 3: Iteration: 1001 / 2000 [ 50%]  (Sampling)\nChain 3: Iteration: 1200 / 2000 [ 60%]  (Sampling)\nChain 3: Iteration: 1400 / 2000 [ 70%]  (Sampling)\nChain 3: Iteration: 1600 / 2000 [ 80%]  (Sampling)\nChain 3: Iteration: 1800 / 2000 [ 90%]  (Sampling)\nChain 3: Iteration: 2000 / 2000 [100%]  (Sampling)\nChain 3: \nChain 3:  Elapsed Time: 1.257 seconds (Warm-up)\nChain 3:                0.692 seconds (Sampling)\nChain 3:                1.949 seconds (Total)\nChain 3: \n\nSAMPLING FOR MODEL 'continuous' NOW (CHAIN 4).\nChain 4: \nChain 4: Gradient evaluation took 2.5e-05 seconds\nChain 4: 1000 transitions using 10 leapfrog steps per transition would take 0.25 seconds.\nChain 4: Adjust your expectations accordingly!\nChain 4: \nChain 4: \nChain 4: Iteration:    1 / 2000 [  0%]  (Warmup)\nChain 4: Iteration:  200 / 2000 [ 10%]  (Warmup)\nChain 4: Iteration:  400 / 2000 [ 20%]  (Warmup)\nChain 4: Iteration:  600 / 2000 [ 30%]  (Warmup)\nChain 4: Iteration:  800 / 2000 [ 40%]  (Warmup)\nChain 4: Iteration: 1000 / 2000 [ 50%]  (Warmup)\nChain 4: Iteration: 1001 / 2000 [ 50%]  (Sampling)\nChain 4: Iteration: 1200 / 2000 [ 60%]  (Sampling)\nChain 4: Iteration: 1400 / 2000 [ 70%]  (Sampling)\nChain 4: Iteration: 1600 / 2000 [ 80%]  (Sampling)\nChain 4: Iteration: 1800 / 2000 [ 90%]  (Sampling)\nChain 4: Iteration: 2000 / 2000 [100%]  (Sampling)\nChain 4: \nChain 4:  Elapsed Time: 0.86 seconds (Warm-up)\nChain 4:                0.448 seconds (Sampling)\nChain 4:                1.308 seconds (Total)\nChain 4: \n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nrstanarm::prior_summary(pp$stan)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```{style=\"max-height: 500px;\"}\nPriors for model 'pp$stan' \n------\nIntercept (after predictors centered)\n  Specified prior:\n    ~ normal(location = 0.68, scale = 2.5)\n  Adjusted prior:\n    ~ normal(location = 0.68, scale = 0.66)\n\nCoefficients\n  Specified prior:\n    ~ normal(location = 0, scale = 2.5)\n  Adjusted prior:\n    ~ normal(location = 0, scale = 1.3)\n\nAuxiliary (sigma)\n  Specified prior:\n    ~ exponential(rate = 1)\n  Adjusted prior:\n    ~ exponential(rate = 3.8)\n\nCovariance\n ~ decov(reg. = 1, conc. = 1, shape = 1, scale = 1)\n------\nSee help('prior_summary.stanreg') for more details\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nsummary(pp$stan)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```{style=\"max-height: 500px;\"}\n\nModel Info:\n function:     stan_glmer\n family:       gaussian [identity]\n formula:      statistic ~ model + (1 | id2/id)\n algorithm:    sampling\n sample:       4000 (posterior sample size)\n priors:       see help('prior_summary')\n observations: 60\n groups:       id:id2 (30), id2 (10)\n\nEstimates:\n                                        mean   sd   10%   50%   90%\n(Intercept)                            0.6    0.0  0.5   0.6   0.6 \nmodelweek_4                            0.2    0.0  0.2   0.2   0.3 \nb[(Intercept) id:id2:repeat1:fold1]   -0.1    0.1 -0.3  -0.2   0.0 \nb[(Intercept) id:id2:repeat1:fold10]  -0.2    0.1 -0.3  -0.2   0.0 \nb[(Intercept) id:id2:repeat1:fold2]    0.2    0.1  0.1   0.2   0.3 \nb[(Intercept) id:id2:repeat1:fold3]    0.1    0.1 -0.1   0.1   0.2 \nb[(Intercept) id:id2:repeat1:fold4]   -0.2    0.1 -0.3  -0.2   0.0 \nb[(Intercept) id:id2:repeat1:fold5]    0.2    0.1  0.0   0.2   0.3 \nb[(Intercept) id:id2:repeat1:fold6]    0.0    0.1 -0.1   0.0   0.1 \nb[(Intercept) id:id2:repeat1:fold7]    0.1    0.1  0.0   0.1   0.3 \nb[(Intercept) id:id2:repeat1:fold8]    0.1    0.1  0.0   0.1   0.2 \nb[(Intercept) id:id2:repeat1:fold9]   -0.1    0.1 -0.2  -0.1   0.0 \nb[(Intercept) id:id2:repeat2:fold1]    0.1    0.1  0.0   0.1   0.2 \nb[(Intercept) id:id2:repeat2:fold10]   0.2    0.1  0.0   0.2   0.3 \nb[(Intercept) id:id2:repeat2:fold2]   -0.1    0.1 -0.2  -0.1   0.0 \nb[(Intercept) id:id2:repeat2:fold3]   -0.3    0.1 -0.5  -0.3  -0.2 \nb[(Intercept) id:id2:repeat2:fold4]    0.1    0.1 -0.1   0.0   0.2 \nb[(Intercept) id:id2:repeat2:fold5]    0.0    0.1 -0.2   0.0   0.1 \nb[(Intercept) id:id2:repeat2:fold6]    0.2    0.1  0.0   0.2   0.3 \nb[(Intercept) id:id2:repeat2:fold7]    0.0    0.1 -0.2   0.0   0.1 \nb[(Intercept) id:id2:repeat2:fold8]    0.0    0.1 -0.1   0.0   0.1 \nb[(Intercept) id:id2:repeat2:fold9]    0.0    0.1 -0.2   0.0   0.1 \nb[(Intercept) id:id2:repeat3:fold1]    0.0    0.1 -0.1   0.0   0.2 \nb[(Intercept) id:id2:repeat3:fold10]   0.0    0.1 -0.1   0.0   0.1 \nb[(Intercept) id:id2:repeat3:fold2]   -0.2    0.1 -0.3  -0.2   0.0 \nb[(Intercept) id:id2:repeat3:fold3]    0.4    0.1  0.3   0.4   0.6 \nb[(Intercept) id:id2:repeat3:fold4]    0.0    0.1 -0.1   0.0   0.1 \nb[(Intercept) id:id2:repeat3:fold5]   -0.1    0.1 -0.2  -0.1   0.1 \nb[(Intercept) id:id2:repeat3:fold6]    0.0    0.1 -0.1   0.0   0.2 \nb[(Intercept) id:id2:repeat3:fold7]   -0.1    0.1 -0.2  -0.1   0.0 \nb[(Intercept) id:id2:repeat3:fold8]   -0.3    0.1 -0.4  -0.3  -0.2 \nb[(Intercept) id:id2:repeat3:fold9]    0.2    0.1  0.0   0.2   0.3 \nb[(Intercept) id2:fold1]               0.0    0.0  0.0   0.0   0.0 \nb[(Intercept) id2:fold10]              0.0    0.0  0.0   0.0   0.0 \nb[(Intercept) id2:fold2]               0.0    0.0  0.0   0.0   0.0 \nb[(Intercept) id2:fold3]               0.0    0.0  0.0   0.0   0.1 \nb[(Intercept) id2:fold4]               0.0    0.0 -0.1   0.0   0.0 \nb[(Intercept) id2:fold5]               0.0    0.0  0.0   0.0   0.1 \nb[(Intercept) id2:fold6]               0.0    0.0  0.0   0.0   0.1 \nb[(Intercept) id2:fold7]               0.0    0.0  0.0   0.0   0.0 \nb[(Intercept) id2:fold8]               0.0    0.0 -0.1   0.0   0.0 \nb[(Intercept) id2:fold9]               0.0    0.0  0.0   0.0   0.0 \nsigma                                  0.2    0.0  0.1   0.2   0.2 \nSigma[id:id2:(Intercept),(Intercept)]  0.0    0.0  0.0   0.0   0.1 \nSigma[id2:(Intercept),(Intercept)]     0.0    0.0  0.0   0.0   0.0 \n\nFit Diagnostics:\n           mean   sd   10%   50%   90%\nmean_PPD 0.7    0.0  0.6   0.7   0.7  \n\nThe mean_ppd is the sample average posterior predictive distribution of the outcome variable (for details see help('summary.stanreg')).\n\nMCMC diagnostics\n                                      mcse Rhat n_eff\n(Intercept)                           0.0  1.0  1737 \nmodelweek_4                           0.0  1.0  5576 \nb[(Intercept) id:id2:repeat1:fold1]   0.0  1.0  3670 \nb[(Intercept) id:id2:repeat1:fold10]  0.0  1.0  3327 \nb[(Intercept) id:id2:repeat1:fold2]   0.0  1.0  3301 \nb[(Intercept) id:id2:repeat1:fold3]   0.0  1.0  3430 \nb[(Intercept) id:id2:repeat1:fold4]   0.0  1.0  3255 \nb[(Intercept) id:id2:repeat1:fold5]   0.0  1.0  3369 \nb[(Intercept) id:id2:repeat1:fold6]   0.0  1.0  3569 \nb[(Intercept) id:id2:repeat1:fold7]   0.0  1.0  4026 \nb[(Intercept) id:id2:repeat1:fold8]   0.0  1.0  3263 \nb[(Intercept) id:id2:repeat1:fold9]   0.0  1.0  3755 \nb[(Intercept) id:id2:repeat2:fold1]   0.0  1.0  3529 \nb[(Intercept) id:id2:repeat2:fold10]  0.0  1.0  2776 \nb[(Intercept) id:id2:repeat2:fold2]   0.0  1.0  4086 \nb[(Intercept) id:id2:repeat2:fold3]   0.0  1.0  2658 \nb[(Intercept) id:id2:repeat2:fold4]   0.0  1.0  3614 \nb[(Intercept) id:id2:repeat2:fold5]   0.0  1.0  4061 \nb[(Intercept) id:id2:repeat2:fold6]   0.0  1.0  3211 \nb[(Intercept) id:id2:repeat2:fold7]   0.0  1.0  3737 \nb[(Intercept) id:id2:repeat2:fold8]   0.0  1.0  3452 \nb[(Intercept) id:id2:repeat2:fold9]   0.0  1.0  3795 \nb[(Intercept) id:id2:repeat3:fold1]   0.0  1.0  3882 \nb[(Intercept) id:id2:repeat3:fold10]  0.0  1.0  3644 \nb[(Intercept) id:id2:repeat3:fold2]   0.0  1.0  3129 \nb[(Intercept) id:id2:repeat3:fold3]   0.0  1.0  2515 \nb[(Intercept) id:id2:repeat3:fold4]   0.0  1.0  4015 \nb[(Intercept) id:id2:repeat3:fold5]   0.0  1.0  3361 \nb[(Intercept) id:id2:repeat3:fold6]   0.0  1.0  3931 \nb[(Intercept) id:id2:repeat3:fold7]   0.0  1.0  3863 \nb[(Intercept) id:id2:repeat3:fold8]   0.0  1.0  2233 \nb[(Intercept) id:id2:repeat3:fold9]   0.0  1.0  2988 \nb[(Intercept) id2:fold1]              0.0  1.0  3274 \nb[(Intercept) id2:fold10]             0.0  1.0  3286 \nb[(Intercept) id2:fold2]              0.0  1.0  3026 \nb[(Intercept) id2:fold3]              0.0  1.0  2850 \nb[(Intercept) id2:fold4]              0.0  1.0  3367 \nb[(Intercept) id2:fold5]              0.0  1.0  3093 \nb[(Intercept) id2:fold6]              0.0  1.0  2201 \nb[(Intercept) id2:fold7]              0.0  1.0  3708 \nb[(Intercept) id2:fold8]              0.0  1.0  2398 \nb[(Intercept) id2:fold9]              0.0  1.0  3616 \nsigma                                 0.0  1.0  1388 \nSigma[id:id2:(Intercept),(Intercept)] 0.0  1.0  1352 \nSigma[id2:(Intercept),(Intercept)]    0.0  1.0  1519 \nmean_PPD                              0.0  1.0  4162 \nlog-posterior                         0.3  1.0   774 \n\nFor each parameter, mcse is Monte Carlo standard error, n_eff is a crude measure of effective sample size, and Rhat is the potential scale reduction factor on split chains (at convergence Rhat=1).\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n# shinystan::launch_shinystan(pp$stan)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\npp %>%  write_rds(file.path(path_models, \n                            str_c(\"posteriors_\", version, \"_nested.rds\")))\n```\n:::\n\n### Model posterier CIs\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\npp_tidy <- pp %>% \n  tidy(seed = 123)\n\nq = c(.025, .5, .975)\npp_tidy |> \n  group_by(model) |> \n  summarize(median = quantile(posterior, probs = q[2]),\n            lower = quantile(posterior, probs = q[1]), \n            upper = quantile(posterior, probs = q[3])) |> \n  mutate(model = factor(model, levels = c(\"week_26\", \"week_4\"),\n                        labels = c(\"Week 26\", \"Week 4\")),\n         y = 1000) |> \n  arrange(model)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```{style=\"max-height: 500px;\"}\n# A tibble: 2 × 5\n  model   median lower upper     y\n  <fct>    <dbl> <dbl> <dbl> <dbl>\n1 Week 26  0.639 0.617 0.661  1000\n2 Week 4   0.687 0.666 0.707  1000\n```\n\n\n:::\n:::\n\n### Model contrasts\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\npp_contrasts <- contrast_models(pp, \n                                list(\"week_4\"), \n                                list(\"week_26\"))\nsummary(pp_contrasts, size = .01, prob = 0.95)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```{style=\"max-height: 500px;\"}\n# A tibble: 1 × 9\n  contrast          probability   mean  lower  upper  size pract_neg pract_equiv\n  <chr>                   <dbl>  <dbl>  <dbl>  <dbl> <dbl>     <dbl>       <dbl>\n1 week_4 vs week_26           1 0.0474 0.0298 0.0646  0.01         0           0\n  pract_pos\n      <dbl>\n1         1\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\npp_contrasts |> autoplot(size = .01)\n```\n\n::: {.cell-output-display}\n![](mak_fig_1_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\nHere are contrasts against 0 rather than using ROPE\n::: {.cell}\n\n```{.r .cell-code .hidden}\npp_contrasts |> \n  mutate(wk4_gt_wk26 = if_else(difference > 0, 1, 0)) |>\n  pull(wk4_gt_wk26) |> \n  mean()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```{style=\"max-height: 500px;\"}\n[1] 1\n```\n\n\n:::\n:::\n\n### Plots\n\nModel posteriors\n::: {.cell}\n\n```{.r .cell-code .hidden}\nci <- pp_tidy |> \n  summary() |> \n  mutate(model = factor(model, levels = c(\"week_4\", \"week_26\")),\n         y = 1000) \n\nci_week4 <- ci |> \n  filter(model == \"week_4\")\n```\n:::\n\n::: {#cell-fig-posteriors .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-posteriors\nfig_posteriors <- pp_tidy |> \n  mutate(model = factor(model, levels = c(\"week_4\", \"week_26\"))) |> \n  ggplot() + \n  geom_histogram(aes(x = posterior, fill = model), color = \"black\", alpha = .4, \n                 bins = 30) +\n  geom_segment(mapping = aes(y = y + 100, yend = y - 100, x = mean, xend = mean,\n                             color = model),\n               data = ci) +\n  geom_segment(mapping = aes(y = y, yend = y, \n                             x = lower, xend = upper, color = model),\n               data = ci) +\n  facet_wrap(~model, ncol = 1) +\n  scale_y_continuous(\"Posterior Probability\", breaks = c(0, 500, 1000)) +\n  # ylab(\"Posterior Probability Density\") +\n  xlab(\"Area Under ROC Curve\")\n\nfig_posteriors\n```\n\n::: {.cell-output-display}\n![](mak_fig_1_files/figure-html/fig-posteriors-1.png){#fig-posteriors width=672}\n:::\n:::\n\n::: {#cell-fig-week4 .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-week4\n\npp_tidy |> \n  mutate(model = factor(model, levels = c(\"week_4\", \"week_26\"))) |> \n  filter(model == \"week_4\") |> \n  ggplot() + \n  geom_histogram(aes(x = posterior, fill = model), color = \"black\", alpha = .4, \n                 bins = 30) +\n  geom_segment(mapping = aes(y = y + 100, yend = y - 100, x = mean, xend = mean,\n                             color = model),\n               data = ci_week4) +\n  geom_segment(mapping = aes(y = y, yend = y, \n                             x = lower, xend = upper, color = model),\n               data = ci_week4) +\n  scale_y_continuous(\"Posterior Probability\", breaks = c(0, 500, 1000)) +\n  # ylab(\"Posterior Probability Density\") +\n  xlab(\"Area Under ROC Curve\") +\n  theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![](mak_fig_1_files/figure-html/fig-week4-1.png){#fig-week4 width=672}\n:::\n:::\n\n\nmodel contrast posteriors\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nci_con <- pp |>\n  contrast_models(list(\"week_4\"), \n                  list(\"week_26\")) |> \n  summary(size = .01) |> \n  mutate(contrast = factor(contrast, \n                           levels = c(\"week_4 vs week_26\"),\n                           labels = c(\"week 4 vs. week 26\")),\n         y = 700)\n```\n:::\n\n::: {#cell-fig-contrasts .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-contrasts\n\nfig_contrasts <- pp |> \n  tidy(seed = 123) |>   \n  group_by(model) |> \n  mutate(sample = row_number()) |> \n  ungroup() |> \n  pivot_wider(names_from = model, values_from = posterior) |> \n  mutate(posterior = week_4 - week_26) |> \n  ggplot() +\n  geom_histogram(aes(x = posterior), \n                 color = \"black\", alpha = .4, bins = 30) +\n  geom_vline(xintercept = 0, color = \"yellow\", \n             linetype = \"dashed\", linewidth = 1) +\n  # geom_vline(xintercept = .01, color = \"yellow\", \n  #            linetype = \"dashed\", linewidth = 1) +\n  geom_segment(mapping = aes(y = y+50, yend = y-50, \n                             x = mean, xend = mean), \n               data = ci_con) +\n  geom_segment(mapping = aes(y = y, yend = y, \n                             x = lower, xend = upper), \n               data = ci_con) +\n  ylab(\"Posterior Probability\") +\n  xlab(\"Model Contrast for auROC (Week 4 vs. Week 26)\")\n\nfig_contrasts\n```\n\n::: {.cell-output-display}\n![](mak_fig_1_files/figure-html/fig-contrasts-1.png){#fig-contrasts width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\n# packages for script\nlibrary(tidyverse)\nlibrary(tidymodels)\nlibrary(tidyposterior)\nlibrary(probably)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n\nAttaching package: 'probably'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following objects are masked from 'package:base':\n\n    as.factor, as.ordered\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\nlibrary(patchwork)\n\ndevtools::source_url(\"https://github.com/jjcurtin/lab_support/blob/main/fun_eda.R?raw=true\")\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nℹ SHA-1 hash of file is \"c045eee2655a18dc85e715b78182f176327358a7\"\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\ndevtools::source_url(\"https://github.com/jjcurtin/lab_support/blob/main/chtc/static_files/fun_chtc.R?raw=true\")\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nℹ SHA-1 hash of file is \"75cc6f7b855da59c240908bd936834b4da01285b\"\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\ntheme_set(theme_classic()) \n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\n# handle conflicts\noptions(conflicts.policy = \"depends.ok\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nswitch (Sys.info()[['sysname']],\n        # PC paths\n        Windows = {\n          path_models <- str_c(\"P:/studydata/match/models/\", \n                               y_col_name)\n        },\n        \n        # IOS paths\n        Darwin = {\n          path_models <- str_c(\"/Volumes/private/studydata/match/models/\",\n                               y_col_name)\n        },\n        \n        # Linux paths\n        Linux = {\n          path_models <- str_c(\"~/mnt/private/studydata/match/models/\",\n                               y_col_name)\n        }\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n# chunk defaults\n\noptions(tibble.width = Inf)\noptions(tibble.print_max = Inf)\n```\n:::\n\n\n## Make Panels\n\n### Panel A: ROC Curve\n\nRead in outer loop predictions\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\npreds_out <- read_rds(file.path(path_models, \n                                str_c(\"outer_preds_\", version, \n                                      \"_\", cv, \".rds\"))) |> \n  glimpse()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```{style=\"max-height: 500px;\"}\nRows: 3,258\nColumns: 3\n$ outer_split_num <int> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …\n$ prob_raw        <dbl> 0.4365827, 0.5961541, 0.5717091, 0.4793436, 0.5308473,…\n$ label           <fct> smoking, smoking, smoking, smoking, abstinent, abstine…\n```\n\n\n:::\n:::\n\n\nSet up data\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nroc_data <- preds_out %>%\n  roc_curve(prob_raw, truth = label) |> \n  glimpse()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```{style=\"max-height: 500px;\"}\nRows: 3,260\nColumns: 3\n$ .threshold  <dbl> -Inf, 0.0009771821, 0.0013545969, 0.0073331582, 0.01453086…\n$ specificity <dbl> 0.0000000000, 0.0000000000, 0.0004662005, 0.0009324009, 0.…\n$ sensitivity <dbl> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…\n```\n\n\n:::\n:::\n\n\nCreate plot\n\n::: {#cell-fig-roc-single .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-roc-single\n#| fig-cap: \"ROC Curve\"\n\nfig_roc <- roc_data %>%\n  ggplot(aes(x = 1 - specificity, y = sensitivity, color = .threshold)) +\n  geom_path(linewidth = 2) +\n  geom_abline(lty = 3) +\n  coord_fixed(xlim = c(0, 1), ylim = c(0, 1)) +\n  labs(x = \"False Positive Rate\",\n       y = \"True Positive Rate\",\n       color = \"Threshold\") +\n  scale_x_continuous(breaks = seq(0,1,.25),\n                     labels = sprintf(\"%.2f\", seq(1,0,-.25))) +\n  scale_color_gradient(low=\"blue\", high=\"red\") +\n  theme(axis.text = element_text(size = rel(1)),\n        axis.title = element_text(size = rel(1)))\n\nfig_roc\n```\n\n::: {.cell-output-display}\n![ROC Curve](mak_fig_1_files/figure-html/fig-roc-single-1.png){#fig-roc-single width=672}\n:::\n:::\n\n\n### Panel B: Posterior Probability Distribution\n\n\n\nCreate plot\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-pp-wk4\n#| fig-cap: \"Posterior Probabilities Distribution\"\n\nfig_pp <- pp_tidy |> \n  mutate(model = factor(model, \n                        levels = \"roc_auc\",\n                        labels = \"Week 4\")) |> \n  ggplot() + \n  geom_histogram(aes(x = posterior, fill = model), \n                 color = \"black\", alpha = .4, \n                 bins = 30) +\n  geom_segment(mapping = aes(y = y + 100, yend = y - 100, \n                             x = mean, xend = mean,\n                             color = model),\n               data = ci_week4) +\n  geom_segment(mapping = aes(y = y, yend = y, \n                             x = lower, xend = upper, \n                             color = model),\n               data = ci_week4) +\n  scale_y_continuous(\"Posterior Probability\", \n                     breaks = c(0, 250, 500, 750)) +\n  xlab(\"Area Under ROC Curve\") +\n  theme(legend.position = \"none\")\n```\n:::\n\n\n\n\n\n### Panel C: Prediction Calibration\n\nRead in final model predictions (LOOCV)\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nd_cal <- read_csv(file.path(path_models,\n                            str_c(\"aim_2_\", version, \"_\", y_col_name, \".csv\")),\n                  show_col_types = FALSE) |> \n  glimpse()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```{style=\"max-height: 500px;\"}\nRows: 1,086\nColumns: 11\n$ subid            <dbl> 20010, 20015, 20030, 20049, 20051, 20072, 20077, 2008…\n$ tx_rct           <chr> \"patch\", \"combo_nrt\", \"patch\", \"varenicline\", \"patch\"…\n$ tx_best          <chr> \"varenicline\", \"varenicline\", \"varenicline\", \"patch\",…\n$ tx_match         <lgl> FALSE, FALSE, FALSE, FALSE, FALSE, TRUE, TRUE, FALSE,…\n$ prob_best        <dbl> 0.4606941, 0.6425940, 0.4593556, 0.5377679, 0.5762493…\n$ outcome_rct_wk4  <chr> \"smoking\", \"smoking\", \"smoking\", \"smoking\", \"smoking\"…\n$ outcome_rct_wk12 <chr> \"smoking\", \"smoking\", \"smoking\", \"abstinent\", \"smokin…\n$ outcome_rct_wk26 <chr> \"smoking\", \"smoking\", \"smoking\", \"abstinent\", \"smokin…\n$ prob_patch       <dbl> 0.3623282, 0.5838388, 0.3770966, 0.5377679, 0.4731365…\n$ prob_combo_nrt   <dbl> 0.3074446, 0.6021400, 0.4396889, 0.5035007, 0.5689455…\n$ prob_varenicline <dbl> 0.4606941, 0.6425940, 0.4593556, 0.5268828, 0.5762493…\n```\n\n\n:::\n:::\n\n\nSet up data\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nd_cal <- d_cal |> \n  mutate(.pred_abstinent = case_when(\n    tx_rct == \"patch\" ~ prob_patch,\n    tx_rct == \"combo_nrt\" ~ prob_combo_nrt,\n    tx_rct == \"varenicline\" ~ prob_varenicline,\n    TRUE ~ NA_real_\n  )) |> \n  select(outcome_rct = outcome_rct_wk4, .pred_abstinent) |> \n  mutate(outcome_rct = factor(outcome_rct,\n                              levels = c(\"abstinent\", \"smoking\"))) |> \n  glimpse()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```{style=\"max-height: 500px;\"}\nRows: 1,086\nColumns: 2\n$ outcome_rct     <fct> smoking, smoking, smoking, smoking, smoking, smoking, …\n$ .pred_abstinent <dbl> 0.3623282, 0.6021400, 0.3770966, 0.5268828, 0.4731365,…\n```\n\n\n:::\n:::\n\n\nCreate breaks plot\n\n::: {#cell-fig-cal-breaks .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-cal-breaks\n#| fig-cap: \"Breaks Plot\"\n\nfig_cal_breaks <- d_cal |> \n  cal_plot_breaks(truth = outcome_rct, \n                  estimate = .pred_abstinent)\n\nfig_cal_breaks\n```\n\n::: {.cell-output-display}\n![Breaks Plot](mak_fig_1_files/figure-html/fig-cal-breaks-1.png){#fig-cal-breaks width=672}\n:::\n:::\n\n\nCreate windowed plot\n\n::: {#cell-fig-cal-window .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-cal-window\n#| fig-cap: \"Windowed Plot\"\n\nfig_cal_window <- d_cal |> \n  cal_plot_windowed(truth = outcome_rct, \n                    estimate = .pred_abstinent)\nfig_cal_window\n```\n\n::: {.cell-output-display}\n![Windowed Plot](mak_fig_1_files/figure-html/fig-cal-window-1.png){#fig-cal-window width=672}\n:::\n:::\n\n\nCreated binned plot\n\n::: {#cell-fig-cal-bins .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-cal-bins\n#| fig-cap: \"Binned Plot\"\n\nbin_width = 0.10\n\nfig_cal_bins <- d_cal |> \n  rename(prob_raw = .pred_abstinent) |> \n  mutate(bins = cut(prob_raw, breaks = seq(0, 1, bin_width)),\n         abstinent = if_else(outcome_rct == \"abstinent\", 1, 0)) |> \n  group_by(bins)  |> \n  summarize(mean_abstinent = mean(abstinent),\n            .groups = \"drop\") |>\n  mutate(bins = as.numeric(bins),\n         midpoints = bin_width/2 + bin_width * (bins - 1))  |> \n  ggplot(data = _, aes(x = midpoints, y = mean_abstinent)) +\n    geom_abline(slope = 1, intercept = 0, linetype = \"dotted\") +\n    geom_line() +\n    geom_point() +\n    xlab(\"Predicted Abstinence Probability (bin mid-point)\") +\n    ylab(\"Observed Abstinence Probability\") +\n    scale_x_continuous(breaks = seq(0, 1, bin_width),\n                       limits = c(0, 1)) +\n    scale_y_continuous(breaks = seq(0, 1, bin_width),\n                       limits = c(0, 1)) +\n  theme(axis.text = element_text(size = rel(1)),\n        axis.title = element_text(size = rel(1)))\n\nfig_cal_bins\n```\n\n::: {.cell-output-display}\n![Binned Plot](mak_fig_1_files/figure-html/fig-cal-bins-1.png){#fig-cal-bins width=672}\n:::\n:::\n\n\n\n## Combine into single figure\n\n\n::: {#cell-fig-combined .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-combined\n#| fig-height: 10\n#| fig-cap: \"Gaylen\"\n\npatchwork <- fig_roc + fig_contrasts + fig_cal_bins \n\npatchwork + plot_annotation(\n  title = \"Model Performance\",\n  tag_levels = c(\"A\", \"B\", \"C\")\n) +\n  plot_layout(ncol = 1, heights = unit(c(2.5,2.5,2.5), 'in'))\n```\n\n::: {.cell-output-display}\n![Gaylen](mak_fig_1_files/figure-html/fig-combined-1.png){#fig-combined width=672}\n:::\n:::\n",
    "supporting": [
      "mak_fig_1_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}