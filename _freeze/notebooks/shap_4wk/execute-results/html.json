{
  "hash": "68cd6671690f540cca5837b39113d0c0",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"SHAP for 4-Week Model\"\nauthor: \"Gaylen Fronk\"\ndate: \"2024-06-04\"\nnumber-sections: true\noutput: \n  html_document:\n    toc: true \n    toc_depth: 4\nformat:\n  html:\n    embed-resources: true\n    toc: true\n    toc-depth: 4\neditor_options: \n  chunk_output_type: console\n---\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nstudy <- \"match\"\nversion <- \"v6\"\ny_col_name <- \"pp_hybrid_wk4_outcome\"\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\n# packages for script\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.4     ✔ readr     2.1.5\n✔ forcats   1.0.0     ✔ stringr   1.5.1\n✔ ggplot2   3.5.1     ✔ tibble    3.2.1\n✔ lubridate 1.9.3     ✔ tidyr     1.3.1\n✔ purrr     1.0.2     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\nlibrary(patchwork)\n\ntheme_set(theme_classic()) \n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\n# handle conflicts\noptions(conflicts.policy = \"depends.ok\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n# absolute paths\nswitch (Sys.info()[['sysname']],\n        # PC paths\n        Windows = {\n          path_data <- str_c(\"P:/studydata/match/chtc/\", y_col_name)},\n        \n        # IOS paths\n        Darwin = {\n          path_data <- str_c(\"/Volumes/private/studydata/match/chtc/\", y_col_name)},\n        \n        # Linux paths\n        Linux = {\n          path_data <- str_c(\"~/mnt/private/studydata/match/chtc/\", y_col_name)}\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n# chunk defaults\n\noptions(tibble.width = Inf)\noptions(tibble.print_max = Inf)\n```\n:::\n\n\n## Read in data\n\nSHAP obtained with LOOCV at CHTC\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nlocal <- read_csv(file.path(path_data, str_c(\"shap_loocv_\", version), \n                            \"output\", \"batch_results.csv\"),\n                  col_types = \"cddd\")\n\nglimpse(local)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 1,272,852\nColumns: 4\n$ variable_name  <chr> \"age_1st_cig\", \"age_daily_smoker\", \"age_ehr\", \"alc_bing…\n$ variable_value <dbl> 0.18140, -0.56780, 0.57420, 0.70530, 1.41800, -0.02156,…\n$ contribution   <dbl> 0.0000000000, 0.0000000000, 0.0000000000, 0.0000000000,…\n$ subid          <dbl> 51514, 51514, 51514, 51514, 51514, 51514, 51514, 51514,…\n```\n\n\n:::\n:::\n\nThis dataset is already local SHAP values because we have one observation per subid per variable.\n\n## Get global Shapley values\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nglobal <- local |> \n  mutate(abs_contribution = abs(contribution)) |> \n  group_by(variable_name) |> \n  summarize(mean_contribution = mean(abs_contribution)) |> \n  arrange(desc(mean_contribution))\n\nglimpse(global)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 1,173\nColumns: 2\n$ variable_name     <chr> \"co\", \"race_ehr_white\", \"wisdm37_2_item_order\", \"mot…\n$ mean_contribution <dbl> 0.029854168, 0.023656426, 0.018174897, 0.016328284, …\n```\n\n\n:::\n:::\n\n\nDelineate treatment interactions\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nglobal <- global |> \n  mutate(tx_int = if_else(str_detect(variable_name, \"treatment_\"), \"Interaction\", \"Main Effect\"))\n```\n:::\n\n\nAdd interpretable names\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nglobal_tx <- global |> \n  filter(tx_int == \"Interaction\") |> \n  arrange(desc(mean_contribution)) |> \n  slice(1:25) |> \n  arrange(mean_contribution) |> \n  mutate(Feature = c(\n    \"C-NRT X Divorced\",\n    \"C-NRT X Currently smokes menthol cigarettes\",\n    \"Patch X Bothered by craving a cigarette (WSWS-2 Item `Crave`)\",\n    \"Varenicline X Kept smoking despite relationship problems (DSM-5 Item 3)\",\n    \"C-NRT X Married\",\n    \"Varenicline X Does not live with another smoker\",\n    \"Varenicline X Has never tried cigars\",\n    \"C-NRT X Worries they are going crazy when they cannot keep their mind on a task (ASI-3 Item 2)\",\n    \"C-NRT X Does not endorse withdrawal symptoms (DSM-5 Item 6)\",\n    \"Patch X Has never tried cigars\",\n    \"C-NRT X Identifies as White\",\n    \"C-NRT X Most of their friends and acquaintances smoke (WISDM-37 Item 30)\",\n    \"Varenicline X No close relative who smokes\",\n    \"Patch X Has tried cigars but has never used regularly\",\n    \"Varenicline X Does not think they do a lot in a day (MFI Item 6)\",\n    \"Patch X No close friend who smokes\",\n    \"Varenicline X Has a spouse/partner who does not smoke\",\n    \"Varenicline X Greater income\",\n    \"Varenicline X Worries they will choke to death when their throat feels tight (ASI-3 Item 15)\",\n    \"C-NRT X Identifies as Black or African American\",\n    \"C-NRT X Has never smoked menthol cigarettes\",\n    \"Varenicline X Lives alone or only with a partner\",\n    \"C-NRT X Disagrees that there is nothing worse than feeling distressed or upset (DTS Item 5)\",\n    \"C-NRT X Sometimes feels like cigarattes are their best friends (WISDM-37 Item 22)\",\n    \"C-NRT X Lives alone or only with a partner\"\n  )) |> \n  mutate(Feature = fct_inorder(Feature))\n\nglobal <- global |> \n  arrange(desc(mean_contribution)) |> \n  slice(1:25) |> \n  arrange(mean_contribution) |> \n  mutate(Feature = c(\n    \"C-NRT X Identifies as Black or African American\",\n    \"A lot of friends or family members smoke (WISDM-37 Item 27)\",\n    \"C-NRT X Has never smoked menthol cigarettes\",\n    \"Varenicline X Lives alone or only with a partner\",\n    \"C-NRT X Disagrees that there is nothing worse than feeling distressed or upset (DTS Item 5)\",\n    \"Does not dread having to do things (MFI Item 9)\",\n    \"Endorses that the flavor of a cigarette is pleasing (WISDM-37 Item 5)\",\n    \"More satisfied with their life as a whole\",\n    \"Currently smokes menthol cigarettes\",\n    \"Does not have a lot of plans (MFI Item 15)\",\n    \"C-NRT X Sometimes feels like cigarattes are their best friends (WISDM-37 Item 22)\",\n    \"Greater income\",\n    \"More time around smokers on the weekend\",\n    \"Won't do much to stop feeling distessed or upset (DTS Item 13)\",\n    \"Identifies as Black or African American\",\n    \"Enjoys being with their family or close friends (SHP Item 2)\",\n    \"Worries they will choke to death when their throat feels tight (ASI-3 Item 15)\",\n    \"C-NRT X Lives alone or only with a partner\",\n    \"Bothered by wanting to smoke (WSWS-2 Item 'Want Cigarette')\",\n    \"Greater duration of longest previous quit attempt\",\n    \"Most of their friends and acquaintances smoke (WISDM-37 Item 30)\",\n    \"Greater motivation to quit\",\n    \"Endorses feeling cigarettes control them (WISDM-37 Item 2)\",\n    \"Identifies as White\",\n    \"Greater exhaled carbon monoxide\"\n  )) |> \n  mutate(Feature = fct_inorder(Feature))\n```\n:::\n\n\n## Make global figures\n\nOverall\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nfig_shap_global <- global |> \n  ggplot(mapping = aes(x = Feature, y = mean_contribution, color = tx_int)) +\n  geom_point(size = 2) +\n  geom_segment(aes(x = Feature, y = mean_contribution, xend = Feature),\n               yend = 0) +\n  labs(\n    x = \"\",\n    y = \"Mean |Shapley value|\",\n    color = \"Feature Type\",\n    title = \"Top Features Overall\"\n  ) +\n  coord_flip() +\n  theme(legend.position = \"bottom\",\n        axis.text = element_text(size = rel(0.75)),\n        axis.title = element_text(size = rel(1)))\n\nfig_shap_global\n```\n\n::: {.cell-output-display}\n![](shap_4wk_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\nGlobal Shapley values among treatment interactions\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nfig_shap_global_tx <- global_tx |> \n  ggplot(mapping = aes(x = Feature, y = mean_contribution, color = tx_int)) +\n  geom_point(size = 2) +\n  geom_segment(aes(x = Feature, y = mean_contribution, xend = Feature),\n               yend = 0) +\n  labs(\n    x = \"\",\n    y = \"Mean |Shapley value|\",\n    title = \"Top Interaction Features\"\n  ) +\n  coord_flip() +\n  theme(legend.position = \"none\",\n        axis.text = element_text(size = rel(0.75)),\n        axis.title = element_text(size = rel(1)))\n\nfig_shap_global_tx\n```\n\n::: {.cell-output-display}\n![](shap_4wk_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\nPaneled Global figure\n\n::: {#cell-fig-shap-global .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-shap-global\n#| fig-height: 9\n#| fig-cap: \"Global feature importance via Shapley values. Bar represents magnitude of global feature importance, which is calculated from the mean of the absolute value across all observations for that feature. A) Global feature importance for top 25 features overall. B) Global feature importance for top 25 treatment interaction features.\"\n\nfig_panel_shap_global <- (fig_shap_global / fig_shap_global_tx / guide_area()) +\n  plot_layout(guides = \"collect\", axes = \"collect\", ncol = 1,\n              heights = unit(c(3, 3, 0.5), \"in\")) +\n  plot_annotation(tag_levels = \"A\",\n                  title = \"Top Global Shapley Values\")\n\nfig_panel_shap_global\n```\n\n::: {.cell-output-display}\n![Global feature importance via Shapley values. Bar represents magnitude of global feature importance, which is calculated from the mean of the absolute value across all observations for that feature. A) Global feature importance for top 25 features overall. B) Global feature importance for top 25 treatment interaction features.](shap_4wk_files/figure-html/fig-shap-global-1.png){#fig-shap-global width=672}\n:::\n:::\n",
    "supporting": [
      "shap_4wk_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}