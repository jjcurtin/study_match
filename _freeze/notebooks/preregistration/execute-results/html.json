{
  "hash": "c330f15a620c20d9cc2c04564a04e517",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Preregistration: Evaluation of Clinical Benefit\"\nauthor: \"Gaylen Fronk\"\ndate: \"2024-04-23\"\noutput: \n  html_document:\n    toc: true \n    toc_depth: 4\nparams:\n  study: \"match\"\n  version: \"v5\"\n  algorithms: \"all\"   # \"all\" or name of specific algorithm\nformat:\n  html:\n    embed-resources: true\neditor_options: \n  chunk_output_type: console\n---\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| echo: false\nstudy <- params$study\nversion <- params$version\nalgorithms <- params$algorithms\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n#| echo: false\n\n# packages for script\nlibrary(lme4)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nLoading required package: Matrix\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n#| echo: false\n\nlibrary(tidymodels)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n── Attaching packages ────────────────────────────────────── tidymodels 1.1.1 ──\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n✔ broom        1.0.5     ✔ recipes      1.0.9\n✔ dials        1.2.0     ✔ rsample      1.2.0\n✔ dplyr        1.1.4     ✔ tibble       3.2.1\n✔ ggplot2      3.4.4     ✔ tidyr        1.3.1\n✔ infer        1.0.6     ✔ tune         1.1.2\n✔ modeldata    1.3.0     ✔ workflows    1.1.3\n✔ parsnip      1.1.1     ✔ workflowsets 1.0.1\n✔ purrr        1.0.2     ✔ yardstick    1.3.0\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n── Conflicts ───────────────────────────────────────── tidymodels_conflicts() ──\n✖ purrr::discard()  masks scales::discard()\n✖ tidyr::expand()   masks Matrix::expand()\n✖ dplyr::filter()   masks stats::filter()\n✖ dplyr::lag()      masks stats::lag()\n✖ tidyr::pack()     masks Matrix::pack()\n✖ recipes::step()   masks stats::step()\n✖ tidyr::unpack()   masks Matrix::unpack()\n✖ recipes::update() masks Matrix::update(), stats::update()\n• Learn how to get started at https://www.tidymodels.org/start/\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n#| echo: false\n\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ forcats   1.0.0     ✔ readr     2.1.5\n✔ lubridate 1.9.3     ✔ stringr   1.5.1\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ readr::col_factor() masks scales::col_factor()\n✖ purrr::discard()    masks scales::discard()\n✖ tidyr::expand()     masks Matrix::expand()\n✖ dplyr::filter()     masks stats::filter()\n✖ stringr::fixed()    masks recipes::fixed()\n✖ dplyr::lag()        masks stats::lag()\n✖ tidyr::pack()       masks Matrix::pack()\n✖ readr::spec()       masks yardstick::spec()\n✖ tidyr::unpack()     masks Matrix::unpack()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n#| echo: false\n\nlibrary(blme)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning: package 'blme' was built under R version 4.3.3\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n#| echo: false\n\nlibrary(parallel)\n\ndevtools::source_url(\"https://github.com/jjcurtin/lab_support/blob/main/fun_eda.R?raw=true\")\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nℹ SHA-1 hash of file is \"c045eee2655a18dc85e715b78182f176327358a7\"\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n#| echo: false\n\ndevtools::source_url(\"https://github.com/jjcurtin/lab_support/blob/main/chtc/static_files/fun_chtc.R?raw=true\")\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nℹ SHA-1 hash of file is \"bb7bddab14e337e74cb65ad3b94d58a2492d34cd\"\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n#| echo: false\n\ntheme_set(theme_classic()) \n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n#| echo: false\n\n# handle conflicts\noptions(conflicts.policy = \"depends.ok\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| echo: false\n\n# absolute paths\nswitch (Sys.info()[['sysname']],\n        # PC paths\n        Windows = {\n          path_models <- \"P:/studydata/match/models\"},\n        \n        # IOS paths\n        Darwin = {\n          path_models <- \"/Volumes/private/studydata/match/models\"},\n        \n        # Linux paths\n        Linux = {\n          path_models <- \"~/mnt/private/studydata/match/models\"}\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| echo: false\n\n# chunk defaults\nknitr::opts_chunk$set(attr.output='style=\"max-height: 500px;\"')\n\noptions(tibble.width = Inf)\noptions(tibble.print_max = Inf)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| echo: false\n\n# read in d for week 4 model\nd_wk4 <- read_csv(file.path(path_models, \"pp_hybrid_wk4_outcome\", \n                            str_c(\"aim_2_\", version, \"_pp_hybrid_wk4_outcome.csv\")),\n                  show_col_types = FALSE) |> \n  mutate(outcome_rct_wk4_num = if_else(outcome_rct_wk4 == \"abstinent\", 1, 0),\n         outcome_rct_wk12_num = if_else(outcome_rct_wk12 == \"abstinent\", 1, 0),\n         outcome_rct_wk26_num = if_else(outcome_rct_wk26 == \"abstinent\", 1, 0),\n         tx_worst = case_when(\n           prob_patch < prob_combo_nrt & prob_patch < prob_varenicline ~ \"patch\",\n           prob_combo_nrt < prob_patch & prob_combo_nrt < prob_varenicline ~ \"combo_nrt\",\n           prob_varenicline < prob_patch & prob_varenicline < prob_combo_nrt ~ \"varenicline\",\n           TRUE ~ NA_character_),\n         tx_second = case_when(\n           tx_worst == \"patch\" & tx_best == \"varenicline\" ~ \"combo_nrt\",\n           tx_worst == \"patch\" & tx_best == \"combo_nrt\" ~ \"varenicline\",\n           tx_worst == \"varenicline\" & tx_best == \"patch\" ~ \"combo_nrt\",\n           tx_worst == \"varenicline\" & tx_best == \"combo_nrt\" ~ \"patch\",\n           tx_worst == \"combo_nrt\" & tx_best == \"varenicline\" ~ \"patch\",\n           tx_worst == \"combo_nrt\" & tx_best == \"patch\" ~ \"varenicline\",\n           TRUE ~ NA_character_)) |> \n  mutate(tx_rank = case_when(\n    tx_rct == tx_best ~ \"first\",\n    tx_rct == tx_second ~ \"second\",\n    tx_rct == tx_worst ~ \"third\",\n    TRUE ~ NA_character_)) |> \n  select(subid, starts_with(\"tx_\"), starts_with(\"prob_\"),\n         outcome_rct_wk4_num, outcome_rct_wk12_num, outcome_rct_wk26_num) \n\n# read in best_config for week 4 model\nbest_configuration_wk4 <- read_csv(file.path(path_models, \"pp_hybrid_wk4_outcome\",\n                                             str_c(\"best_config_\", version, \".csv\")),\n                                   show_col_types = FALSE) |> \n  select(algorithm, feature_set, alpha = hp1, lambda = hp2, resample)\n\n# read in d for week 26 model\n# d_wk26 <- read_csv(file.path(path_models, \"pp_hybrid_wk26_outcome\", \n#                         str_c(\"aim_2_\", version, \"_pp_hybrid_wk26_outcome.csv\")),\n#               show_col_types = FALSE) |> \n#   mutate(outcome_rct_wk4_num = if_else(outcome_rct_wk4 == \"abstinent\", 1, 0),\n#          outcome_rct_wk12_num = if_else(outcome_rct_wk12 == \"abstinent\", 1, 0),\n#          outcome_rct_wk26_num = if_else(outcome_rct_wk26 == \"abstinent\", 1, 0),\n#          tx_worst = case_when(\n#            prob_patch < prob_combo_nrt & prob_patch < prob_varenicline ~ \"patch\",\n#            prob_combo_nrt < prob_patch & prob_combo_nrt < prob_varenicline ~ \"combo_nrt\",\n#            prob_varenicline < prob_patch & prob_varenicline < prob_combo_nrt ~ \"varenicline\",\n#            TRUE ~ NA_character_),\n#          tx_second = case_when(\n#            tx_worst == \"patch\" & tx_best == \"varenicline\" ~ \"combo_nrt\",\n#            tx_worst == \"patch\" & tx_best == \"combo_nrt\" ~ \"varenicline\",\n#            tx_worst == \"varenicline\" & tx_best == \"patch\" ~ \"combo_nrt\",\n#            tx_worst == \"varenicline\" & tx_best == \"combo_nrt\" ~ \"patch\",\n#            tx_worst == \"combo_nrt\" & tx_best == \"varenicline\" ~ \"patch\",\n#            tx_worst == \"combo_nrt\" & tx_best == \"patch\" ~ \"varenicline\",\n#            TRUE ~ NA_character_)) |> \n#   mutate(tx_rank = case_when(\n#     tx_rct == tx_best ~ \"first\",\n#     tx_rct == tx_second ~ \"second\",\n#     tx_rct == tx_worst ~ \"third\",\n#     TRUE ~ NA_character_)) |> \n#   select(subid, starts_with(\"tx_\"), starts_with(\"prob_\"),\n#          outcome_rct_wk4_num, outcome_rct_wk12_num, outcome_rct_wk26_num) \n\n# read in best_config for week 26 model\n# best_configuration_wk26 <- read_csv(file.path(path_models, \"pp_hybrid_wk26_outcome\",\n#                                               str_c(\"best_config_\", version, \".csv\")),\n#                                     show_col_types = FALSE) |> \n#   select(algorithm, feature_set, learning_rate = hp1, tree_depth = hp2, \n#          mtry = hp3, resample)\n```\n:::\n\n\n## Study Overview\n\n### Specific Aims\n\nThis project represents a tangible application of the precision mental health paradigm using modern machine learning approaches. This project aims to produce a decision-making tool to select among cigarette smoking cessation treatments for individuals looking to quit smoking. \n\nCigarette smoking remains a critical and costly public health crisis. Existing treatments are only modestly effective at best. Additionally, treatments are similarly effective at the population level, meaning that even population-level effectiveness cannot guide treatment selection for individuals quitting smoking. Thus, deciding among first-line (i.e., FDA-approved) smoking cessation medications is a specific, objective decision that many individuals who smoke (or their providers) must make. Successful application of the precision mental health paradigm to cigarette smoking cessation would have immediate clinical benefit. \n\nSpecifically, this project pursues the following aims:\n\n**AIM 1: Build a machine learning model to guide treatment selection for cigarette smoking cessation.** We will build a machine learning model to predict treatment success (i.e.,7-day point-prevalence abstinence from smoking 4 weeks post-quit) for people who smoke who received one of three cigarette smoking cessation treatments. This model will use clinical features (predictors) from a richly characterized sample of people who smoke from a previously completed randomized controlled trial. The model will produce probabilities of treatment success for each treatment such that it can guide selection of the best treatment for any specific individual.\n\n**AIM 2: Evaluate the clinical benefit of using a treatment selection machine learning model.** Using the best model identified in **AIM 1**, we will identify the treatment for each person that gives them the highest likelihood of abstinence by comparing predicted probabilities of abstinence for each participant for each treatment. We will then evaluate the clinical benefit of this model-based treatment selection approach. \n\n### Data\n\nThis project relies on existing data from a completed comparative effectiveness trial by [Baker et al., 2016](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4824537/). Briefly, 1086 individuals who smoke cigarettes were randomized to receive varenicline, combination nicotine replacement therapy (NRT), or nicotine patch to assist with a quit attempt. Individuals were richly characterized at baseline (pre-treatment) with respect to demographic characteristics, mental health, social/environmental variables, physical health, and smoking history. Participants were assessed periodically for biologically confirmed, 7-day point-prevalence abstinence. When abstinence was biologically confirmed (i.e., via exhaled carbon monoxide), individuals were labeled as abstinent; otherwise, individuals were labeled as smoking. Thus, we used predictors from the rich baseline characterization to predict our **primary outcome** of 7-day point-prevalance abstinence at 4 weeks post-quit.\n\n## Analysis Progress at Time of Preregistration\n\n### Completed: Model Building, Selection, & Evaluation\n\n**AIM 1** analyses have been completed: Models using all available data have been fit and selected with nested cross-validation (1 repeat of 10-fold cross-validation in the inner loops, 3 repeats of 10-fold cross-validation in the outer loop). These 30-held out folds (\"test sets\") were used to evaluate model performance. \n\n### Completed: Model Performance\n\nModels were evaluated using our primary performance metric, area under the ROC curve (auROC), an index of how well our models discriminate between positive (abstinent) and negative (smoking) cases. \n\nWe evaluated model performance in-depth by conducting *Bayesian hierarchical generalized linear models* to estimate the posterior probability distributions and 95% Bayesian credible intervals (CIs) for auROC for our best models from the 30 held-out test sets from nested cross-validation. Below, you can see the posterior probabilities for auROC in held-out folds.\n\n\n{{< embed ana_bayes_match.qmd#fig-week4 >}}\n\n\n\nThe horizontal line indicates the 95% CIs. The vertical line represents the median posterior probability for auROC. This represents our best estimate for the magnitude of the auROC parameter. The CI does not contain 0.5 (i.e., chance performance), suggesting the model is capturing signal in the data.\n\n### Completed: Fit Final Model\n\nA single, best model was selected with 1 repeat of 10-fold cross-validation in the full dataset. \n\nThe best model configuration includes the following:\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| echo: false\nglimpse(best_configuration_wk4)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```{style=\"max-height: 500px;\"}\nRows: 1\nColumns: 5\n$ algorithm   <chr> \"glmnet\"\n$ feature_set <chr> \"item_ordinal\"\n$ alpha       <dbl> 0.1\n$ lambda      <dbl> 0.1326421\n$ resample    <chr> \"up_1\"\n```\n\n\n:::\n:::\n\n\n* Selected algorithm was glmnet (xgboost and random forest also considered)\n\n* Selected feature set was \"item_ordinal\" indicating that individual items (rather than scale scores) were used, and ordinal scoring was used for ordered data (rather than dummy coding)\n\n* Selected resampling approach was \"up_1\" corresponding to upsampling (vs. downsampling or SMOTE) with a ratio of 1:1 (majority:minority class)\n\n* Values of the hyperparameters alpha and lambda were selected from sensible ranges for each value\n\n### In Progress: AIM 2 Clinical Benefit Analyses\n\n**AIM 2** analyses using this full model are underway. We have used the final model fit in the full dataset to generate three predictions (probabilities, `prob_*`) for each participant by substituting each treatment into the model inputs. Thus, there is one prediction per person per treatment. \n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nset.seed(82294)\nd_wk4 |> \n  select(subid, prob_patch, prob_combo_nrt, prob_varenicline) |> \n  slice_sample(n = 8) |> \n  print_kbl(digits = 3)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div style=\"border: 1px solid #ddd; padding: 0px; overflow-y: scroll; height:500px; overflow-x: scroll; width:100%; \"><table class=\"table table-striped table-condensed\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:right;position: sticky; top:0; background-color: #FFFFFF;\"> subid </th>\n   <th style=\"text-align:right;position: sticky; top:0; background-color: #FFFFFF;\"> prob_patch </th>\n   <th style=\"text-align:right;position: sticky; top:0; background-color: #FFFFFF;\"> prob_combo_nrt </th>\n   <th style=\"text-align:right;position: sticky; top:0; background-color: #FFFFFF;\"> prob_varenicline </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 40244 </td>\n   <td style=\"text-align:right;\"> 0.430 </td>\n   <td style=\"text-align:right;\"> 0.531 </td>\n   <td style=\"text-align:right;\"> 0.570 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 51235 </td>\n   <td style=\"text-align:right;\"> 0.189 </td>\n   <td style=\"text-align:right;\"> 0.198 </td>\n   <td style=\"text-align:right;\"> 0.159 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 50478 </td>\n   <td style=\"text-align:right;\"> 0.436 </td>\n   <td style=\"text-align:right;\"> 0.319 </td>\n   <td style=\"text-align:right;\"> 0.403 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 40482 </td>\n   <td style=\"text-align:right;\"> 0.247 </td>\n   <td style=\"text-align:right;\"> 0.222 </td>\n   <td style=\"text-align:right;\"> 0.257 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 30048 </td>\n   <td style=\"text-align:right;\"> 0.583 </td>\n   <td style=\"text-align:right;\"> 0.542 </td>\n   <td style=\"text-align:right;\"> 0.561 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 30294 </td>\n   <td style=\"text-align:right;\"> 0.339 </td>\n   <td style=\"text-align:right;\"> 0.315 </td>\n   <td style=\"text-align:right;\"> 0.340 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 31221 </td>\n   <td style=\"text-align:right;\"> 0.192 </td>\n   <td style=\"text-align:right;\"> 0.153 </td>\n   <td style=\"text-align:right;\"> 0.217 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 50676 </td>\n   <td style=\"text-align:right;\"> 0.148 </td>\n   <td style=\"text-align:right;\"> 0.169 </td>\n   <td style=\"text-align:right;\"> 0.140 </td>\n  </tr>\n</tbody>\n</table></div>\n\n`````\n:::\n:::\n\n\nThe treatment that yields the highest model-predicted probability of abstinence is identified as that participant's \"best\" treatment (`tx_best`). \n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nd_wk4 |> \n  select(subid, tx_best, prob_patch, prob_combo_nrt, prob_varenicline) |> \n  slice_sample(n = 8) |> \n  print_kbl(digits = 3)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div style=\"border: 1px solid #ddd; padding: 0px; overflow-y: scroll; height:500px; overflow-x: scroll; width:100%; \"><table class=\"table table-striped table-condensed\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:right;position: sticky; top:0; background-color: #FFFFFF;\"> subid </th>\n   <th style=\"text-align:right;position: sticky; top:0; background-color: #FFFFFF;\"> tx_best </th>\n   <th style=\"text-align:right;position: sticky; top:0; background-color: #FFFFFF;\"> prob_patch </th>\n   <th style=\"text-align:right;position: sticky; top:0; background-color: #FFFFFF;\"> prob_combo_nrt </th>\n   <th style=\"text-align:right;position: sticky; top:0; background-color: #FFFFFF;\"> prob_varenicline </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 50666 </td>\n   <td style=\"text-align:right;\"> varenicline </td>\n   <td style=\"text-align:right;\"> 0.159 </td>\n   <td style=\"text-align:right;\"> 0.185 </td>\n   <td style=\"text-align:right;\"> 0.189 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 50224 </td>\n   <td style=\"text-align:right;\"> varenicline </td>\n   <td style=\"text-align:right;\"> 0.193 </td>\n   <td style=\"text-align:right;\"> 0.165 </td>\n   <td style=\"text-align:right;\"> 0.207 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 50422 </td>\n   <td style=\"text-align:right;\"> combo_nrt </td>\n   <td style=\"text-align:right;\"> 0.344 </td>\n   <td style=\"text-align:right;\"> 0.352 </td>\n   <td style=\"text-align:right;\"> 0.246 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 30984 </td>\n   <td style=\"text-align:right;\"> combo_nrt </td>\n   <td style=\"text-align:right;\"> 0.195 </td>\n   <td style=\"text-align:right;\"> 0.227 </td>\n   <td style=\"text-align:right;\"> 0.197 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 50295 </td>\n   <td style=\"text-align:right;\"> patch </td>\n   <td style=\"text-align:right;\"> 0.455 </td>\n   <td style=\"text-align:right;\"> 0.431 </td>\n   <td style=\"text-align:right;\"> 0.437 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 20769 </td>\n   <td style=\"text-align:right;\"> varenicline </td>\n   <td style=\"text-align:right;\"> 0.450 </td>\n   <td style=\"text-align:right;\"> 0.516 </td>\n   <td style=\"text-align:right;\"> 0.569 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 51261 </td>\n   <td style=\"text-align:right;\"> patch </td>\n   <td style=\"text-align:right;\"> 0.357 </td>\n   <td style=\"text-align:right;\"> 0.340 </td>\n   <td style=\"text-align:right;\"> 0.305 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 30149 </td>\n   <td style=\"text-align:right;\"> combo_nrt </td>\n   <td style=\"text-align:right;\"> 0.443 </td>\n   <td style=\"text-align:right;\"> 0.465 </td>\n   <td style=\"text-align:right;\"> 0.341 </td>\n  </tr>\n</tbody>\n</table></div>\n\n`````\n:::\n:::\n\n\nThe best treatments spanned all three medication options: varenicline, combination nicotine replacement therapy (\"combo_nrt\"), and nicotine patch (\"patch\").\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nd_wk4 |> \n  tab(tx_best)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```{style=\"max-height: 500px;\"}\n# A tibble: 3 × 3\n  tx_best         n  prop\n  <chr>       <int> <dbl>\n1 combo_nrt     339 0.312\n2 patch         193 0.178\n3 varenicline   554 0.510\n```\n\n\n:::\n:::\n\n\nSome participants' best treatment (`tx_best`) matched what they were randomly assigned in the original trial (`tx_rct`). Other participants may have received what the model identified as their second-best or worst treatment. Thus, participants' RCT-assigned treatment can be categorized by whether it \"matched\" their model-assigned treatment (`tx_match`).\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nd_wk4 |> \n  select(subid, tx_match, tx_rct, tx_best, tx_second, tx_worst) |> \n  slice_sample(n = 10) |> \n  print_kbl()\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div style=\"border: 1px solid #ddd; padding: 0px; overflow-y: scroll; height:500px; overflow-x: scroll; width:100%; \"><table class=\"table table-striped table-condensed\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:right;position: sticky; top:0; background-color: #FFFFFF;\"> subid </th>\n   <th style=\"text-align:right;position: sticky; top:0; background-color: #FFFFFF;\"> tx_match </th>\n   <th style=\"text-align:right;position: sticky; top:0; background-color: #FFFFFF;\"> tx_rct </th>\n   <th style=\"text-align:right;position: sticky; top:0; background-color: #FFFFFF;\"> tx_best </th>\n   <th style=\"text-align:right;position: sticky; top:0; background-color: #FFFFFF;\"> tx_second </th>\n   <th style=\"text-align:right;position: sticky; top:0; background-color: #FFFFFF;\"> tx_worst </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 40645 </td>\n   <td style=\"text-align:right;\"> TRUE </td>\n   <td style=\"text-align:right;\"> varenicline </td>\n   <td style=\"text-align:right;\"> varenicline </td>\n   <td style=\"text-align:right;\"> patch </td>\n   <td style=\"text-align:right;\"> combo_nrt </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 20015 </td>\n   <td style=\"text-align:right;\"> FALSE </td>\n   <td style=\"text-align:right;\"> combo_nrt </td>\n   <td style=\"text-align:right;\"> varenicline </td>\n   <td style=\"text-align:right;\"> combo_nrt </td>\n   <td style=\"text-align:right;\"> patch </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 40126 </td>\n   <td style=\"text-align:right;\"> TRUE </td>\n   <td style=\"text-align:right;\"> combo_nrt </td>\n   <td style=\"text-align:right;\"> combo_nrt </td>\n   <td style=\"text-align:right;\"> varenicline </td>\n   <td style=\"text-align:right;\"> patch </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 51165 </td>\n   <td style=\"text-align:right;\"> TRUE </td>\n   <td style=\"text-align:right;\"> varenicline </td>\n   <td style=\"text-align:right;\"> varenicline </td>\n   <td style=\"text-align:right;\"> patch </td>\n   <td style=\"text-align:right;\"> combo_nrt </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 30705 </td>\n   <td style=\"text-align:right;\"> FALSE </td>\n   <td style=\"text-align:right;\"> combo_nrt </td>\n   <td style=\"text-align:right;\"> patch </td>\n   <td style=\"text-align:right;\"> varenicline </td>\n   <td style=\"text-align:right;\"> combo_nrt </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 30179 </td>\n   <td style=\"text-align:right;\"> TRUE </td>\n   <td style=\"text-align:right;\"> patch </td>\n   <td style=\"text-align:right;\"> patch </td>\n   <td style=\"text-align:right;\"> combo_nrt </td>\n   <td style=\"text-align:right;\"> varenicline </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 51390 </td>\n   <td style=\"text-align:right;\"> TRUE </td>\n   <td style=\"text-align:right;\"> varenicline </td>\n   <td style=\"text-align:right;\"> varenicline </td>\n   <td style=\"text-align:right;\"> patch </td>\n   <td style=\"text-align:right;\"> combo_nrt </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 51817 </td>\n   <td style=\"text-align:right;\"> FALSE </td>\n   <td style=\"text-align:right;\"> patch </td>\n   <td style=\"text-align:right;\"> varenicline </td>\n   <td style=\"text-align:right;\"> combo_nrt </td>\n   <td style=\"text-align:right;\"> patch </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 50140 </td>\n   <td style=\"text-align:right;\"> FALSE </td>\n   <td style=\"text-align:right;\"> patch </td>\n   <td style=\"text-align:right;\"> combo_nrt </td>\n   <td style=\"text-align:right;\"> patch </td>\n   <td style=\"text-align:right;\"> varenicline </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 20359 </td>\n   <td style=\"text-align:right;\"> FALSE </td>\n   <td style=\"text-align:right;\"> patch </td>\n   <td style=\"text-align:right;\"> combo_nrt </td>\n   <td style=\"text-align:right;\"> patch </td>\n   <td style=\"text-align:right;\"> varenicline </td>\n  </tr>\n</tbody>\n</table></div>\n\n`````\n:::\n:::\n\n\nApproximately 38% of participants received their model-assigned \"best\" treatment in the original trial.\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nd_wk4 |> \n  tab(tx_match)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```{style=\"max-height: 500px;\"}\n# A tibble: 2 × 3\n  tx_match     n  prop\n  <lgl>    <int> <dbl>\n1 FALSE      677 0.623\n2 TRUE       409 0.377\n```\n\n\n:::\n:::\n\n\nAt the time of this preregistration, **no analyses have been conducted using these probabilities or model-based treatment assignments.**\n\n## Purpose of Preregistration\n\nThe purpose of this document is to **preregister the analyses for evaluating the clinical benefit of this treatment selection model**. \n\n### Outcomes\n\nOur primary analysis will compare the observed outcomes (i.e., abstinence vs. smoking, from the original trial) for people who did or did not receive their best treatment. We will examine these outcomes over the following time points:\n\n* 4 weeks: This served as the outcome for a prediction model. This selection was made so that, in real-world implementation, treatment could be adjusted earlier for individuals for whom treatment is not working.\n\n* 12 weeks: This is end-of-treatment and represents a mid-point between the early (4-week) and later (26-week) outcomes.\n\n* 26 weeks (6 months): This is the gold standard assessment period for smoking cessation treatments and was the primary outcome for the original trial ([Baker et al., 2016](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4824537/)). This duration is often used as a proxy for long-term success.\n\n### Modeling Specifications\n\nWe plan to follow a mixed-effects modeling approach using the `blme` package. Specifically, we will fit a partially Bayesian generalized linear model using `bglmer()` with the components listed below. This approach uses regularizing priors to force the estimated random effects variance-covariance matrices away from singularity ([Chung et al., 2013](https://link.springer.com/article/10.1007/s11336-013-9328-2), `blme` package). We would use the default `\"nlminbwrap\"` optimizer.\n\nTo ensure that all proposed analyses are feasible and to specify analyses as precisely as possible, **we conduct these proposed analyses using our data with shuffled outcome variables**. Following preregistration, our analyses will follow this script exactly using our real data.\n\nOur model will have the following components:\n\n1. Dependent variable: abstinence (vs. smoking; `outcome_rct_num`). Binary outcome with abstinence coded as 1 and smoking coded as 0.\n\n2. Independent variable: treatment match (`tx_match`). Between-subjects categorical variable with two levels (TRUE or FALSE). This variable will be coded with an orthogonal contrast such that we compare individuals who received their best treatment to individuals who did not.\n\n3. Independent variable: time (`week`). This variable has repeated measures such that there are three time points for each subject. This variable will be treated as a numeric variable, and it will be log-transformed (natural log) to meet linearity assumptions. Log transformation is appropriate when the shape of the relationship between the raw variable and outcome is asymptotic. \n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| echo: false\nd_log_fig <- d_wk4 |> \n  select(subid, outcome_rct_wk4_num, outcome_rct_wk12_num, outcome_rct_wk26_num) |> \n  pivot_longer(\n    cols = c(outcome_rct_wk4_num, outcome_rct_wk12_num, outcome_rct_wk26_num),\n    names_to = \"week\",\n    names_pattern = \"(?<=outcome_rct_wk)(.+)(?=_num)\",\n    values_to = \"outcome_rct_num\"\n  ) |> \n  mutate(week = as.numeric(week)) |> \n  mutate(week_log = log(week)) # default base = e (natural log)\n\nd_log_fig |>\n  group_by(week) |> \n  summarize(mean_outcome = mean(outcome_rct_num)) |> \n  ggplot(aes(x = week, y = mean_outcome)) +\n  geom_line() +\n  ggtitle(\"Relationship Between Raw Week & Outcome\")\n```\n\n::: {.cell-output-display}\n![](preregistration_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n\n```{.r .cell-code .hidden}\n#| echo: false\nd_log_fig |>\n  group_by(week_log) |> \n  summarize(mean_outcome = mean(outcome_rct_num)) |> \n  ggplot(aes(x = week_log, y = mean_outcome)) +\n  geom_line() +\n  ggtitle(\"Relationship Between Log-Transformed Week & Outcome\")\n```\n\n::: {.cell-output-display}\n![](preregistration_files/figure-html/unnamed-chunk-8-2.png){width=672}\n:::\n:::\n\n\n4. Interaction between treatment match and time\n\n5. Random slope for time (3 repeated observations of time for each subject)\n\n6. Random intercept\n\n### Focal & Secondary Effects\n\nOur **focal effect** is the effect of treatment match. We predict that individuals who received their best treatment will have improved outcomes compared to individuals who did not. \n\nOur **secondary effects** include: \n\n* The interaction between treatment match and time. We do not have a directional hypothesis about this interaction.\n\n  + If this interaction is significant (*p* < 0.05), we will conduct **follow-up tests** of the simple effect of treatment match at all 3 time points (week 4, week 12, and week 26). These will be general linear models using the `glm` function within the `stats` package.\n\nWe plan to report the estimates, test statistics, *p*-values, and confidence intervals for all effects from this model.\n\n## Shuffle Data\n\nTo create our shuffled dataset, we randomly sample (without replacement) the treatment match (`tx_match`) variable. This:\n\n* Breaks any relationship between `tx_match` and the outcome\n\n* Breaks any interactive effect of `tx_match` and `week` on the outcome\n\n* Maintains the random effect structure within the `week` variable\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nset.seed(72905)\nd_shuf <- d_wk4 |> \n  # select only necessary variables\n  select(subid, tx_match, \n         outcome_rct_wk4_num, outcome_rct_wk12_num, outcome_rct_wk26_num) |> \n  # randomize tx_match variable\n  mutate(tx_match = sample(d_wk4$tx_match, nrow(d_wk4), replace = FALSE)) |>\n  # pivot to long data format where week is its own variable\n  pivot_longer(\n    cols = c(outcome_rct_wk4_num, outcome_rct_wk12_num, outcome_rct_wk26_num),\n    names_to = \"week\",\n    names_pattern = \"(?<=outcome_rct_wk)(.+)(?=_num)\",\n    values_to = \"outcome_rct_num\"\n  ) |> \n  # correctly class independent variables\n  mutate(tx_match = factor(tx_match, \n                           levels = c(FALSE, TRUE)),\n         week = as.numeric(week)) |> \n  # log transform week variable per above\n  mutate(week_log = log(week)) # default base is e (natural log)\n\nglimpse(d_shuf)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```{style=\"max-height: 500px;\"}\nRows: 3,258\nColumns: 5\n$ subid           <dbl> 20010, 20010, 20010, 20015, 20015, 20015, 20030, 20030…\n$ tx_match        <fct> TRUE, TRUE, TRUE, FALSE, FALSE, FALSE, FALSE, FALSE, F…\n$ week            <dbl> 4, 12, 26, 4, 12, 26, 4, 12, 26, 4, 12, 26, 4, 12, 26,…\n$ outcome_rct_num <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, …\n$ week_log        <dbl> 1.386294, 2.484907, 3.258097, 1.386294, 2.484907, 3.25…\n```\n\n\n:::\n:::\n\n\nConfirm that data look random\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nd_shuf |> \n  group_by(week, tx_match) |> \n  summarize(mean_outcome = mean(outcome_rct_num)) \n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n`summarise()` has grouped output by 'week'. You can override using the\n`.groups` argument.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```{style=\"max-height: 500px;\"}\n# A tibble: 6 × 3\n# Groups:   week [3]\n   week tx_match mean_outcome\n  <dbl> <fct>           <dbl>\n1     4 FALSE           0.349\n2     4 TRUE            0.330\n3    12 FALSE           0.290\n4    12 TRUE            0.291\n5    26 FALSE           0.244\n6    26 TRUE            0.252\n```\n\n\n:::\n:::\n\n\n## Analysis Steps\n\nSet contrasts for treatment match\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nc_tx <- contr.helmert(c(FALSE, TRUE))\nc_tx[, 1] <- c_tx[, 1] / (max(c_tx[, 1]) - min(c_tx[, 1])) # scale\ncolnames(c_tx) <- c(\"best_v_other\")\ncontrasts(d_shuf$tx_match) <- c_tx\ncontrasts(d_shuf$tx_match)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```{style=\"max-height: 500px;\"}\n      best_v_other\nFALSE         -0.5\nTRUE           0.5\n```\n\n\n:::\n:::\n\n\n### Primary Model\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nmodel_1 <- blme::bglmer(outcome_rct_num ~ tx_match * week_log + \n                          (1 + week_log | subid),\n                        data = d_shuf,\n                        family = binomial(link = \"logit\"),\n                        control = glmerControl(optCtrl = list(maxfun = 3e6)))\n\nsummary(model_1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```{style=\"max-height: 500px;\"}\nCov prior  : subid ~ wishart(df = 4.5, scale = Inf, posterior.scale = cov, common.scale = TRUE)\nPrior dev  : -2.0001\n\nGeneralized linear mixed model fit by maximum likelihood (Laplace\n  Approximation) [bglmerMod]\n Family: binomial  ( logit )\nFormula: outcome_rct_num ~ tx_match * week_log + (1 + week_log | subid)\n   Data: d_shuf\nControl: glmerControl(optCtrl = list(maxfun = 3e+06))\n\n     AIC      BIC   logLik deviance df.resid \n  3091.9   3134.5  -1539.0   3077.9     3251 \n\nScaled residuals: \n     Min       1Q   Median       3Q      Max \n-1.22909 -0.41112 -0.06664  0.14531  1.40569 \n\nRandom effects:\n Groups Name        Variance Std.Dev. Corr \n subid  (Intercept) 11.08    3.329         \n        week_log    13.23    3.638    -0.99\nNumber of obs: 3258, groups:  subid, 1086\n\nFixed effects:\n                              Estimate Std. Error z value Pr(>|z|)    \n(Intercept)                     1.9482     0.3557   5.478 4.31e-08 ***\ntx_matchbest_v_other           -0.3387     0.4028  -0.841    0.400    \nweek_log                       -2.2343     0.2221 -10.060  < 2e-16 ***\ntx_matchbest_v_other:week_log   0.1244     0.2783   0.447    0.655    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nCorrelation of Fixed Effects:\n            (Intr) tx_m__ wek_lg\ntx_mtchbs__  0.142              \nweek_log    -0.917 -0.118       \ntx_mtch__:_ -0.103 -0.861  0.129\n```\n\n\n:::\n:::\n\n\n### Follow-up analyses: Simple Effects\n\nIf the interaction between `tx_match` and `week` is significant (*p* < 0.05), we will conduct follow-up analyses to test the simple effect of `tx_match` at each time point.\n\nSimple effect at 4 weeks\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nd_4_shuf <- d_shuf |> \n  filter(week == 4)\n\nmodel_4wk <- glm(outcome_rct_num ~ tx_match, \n                 data = d_4_shuf,\n                 family = binomial(link = \"logit\"))\n\nsummary(model_4wk)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```{style=\"max-height: 500px;\"}\n\nCall:\nglm(formula = outcome_rct_num ~ tx_match, family = binomial(link = \"logit\"), \n    data = d_4_shuf)\n\nCoefficients:\n                     Estimate Std. Error z value Pr(>|z|)    \n(Intercept)          -0.66653    0.06626 -10.059   <2e-16 ***\ntx_matchbest_v_other -0.08264    0.13252  -0.624    0.533    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for binomial family taken to be 1)\n\n    Null deviance: 1394.7  on 1085  degrees of freedom\nResidual deviance: 1394.3  on 1084  degrees of freedom\nAIC: 1398.3\n\nNumber of Fisher Scoring iterations: 4\n```\n\n\n:::\n:::\n\n\nSimple effect at 12 weeks\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nd_12_shuf <- d_shuf |> \n  filter(week == 12)\n\nmodel_12wk <- glm(outcome_rct_num ~ tx_match, \n                  data = d_12_shuf,\n                  family = binomial(link = \"logit\"))\n\nsummary(model_12wk)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```{style=\"max-height: 500px;\"}\n\nCall:\nglm(formula = outcome_rct_num ~ tx_match, family = binomial(link = \"logit\"), \n    data = d_12_shuf)\n\nCoefficients:\n                      Estimate Std. Error z value Pr(>|z|)    \n(Intercept)          -0.894255   0.068979 -12.964   <2e-16 ***\ntx_matchbest_v_other  0.006995   0.137959   0.051     0.96    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for binomial family taken to be 1)\n\n    Null deviance: 1308  on 1085  degrees of freedom\nResidual deviance: 1308  on 1084  degrees of freedom\nAIC: 1312\n\nNumber of Fisher Scoring iterations: 4\n```\n\n\n:::\n:::\n\n\nSimple effect at 26 weeks\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nd_26_shuf <- d_shuf |> \n  filter(week == 26)\n\nmodel_26wk <- glm(outcome_rct_num ~ tx_match, \n                  data = d_26_shuf,\n                  family = binomial(link = \"logit\"))\n\nsummary(model_26wk)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```{style=\"max-height: 500px;\"}\n\nCall:\nglm(formula = outcome_rct_num ~ tx_match, family = binomial(link = \"logit\"), \n    data = d_26_shuf)\n\nCoefficients:\n                     Estimate Std. Error z value Pr(>|z|)    \n(Intercept)          -1.11062    0.07244  -15.33   <2e-16 ***\ntx_matchbest_v_other  0.04352    0.14488    0.30    0.764    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for binomial family taken to be 1)\n\n    Null deviance: 1213.6  on 1085  degrees of freedom\nResidual deviance: 1213.6  on 1084  degrees of freedom\nAIC: 1217.6\n\nNumber of Fisher Scoring iterations: 4\n```\n\n\n:::\n:::",
    "supporting": [
      "preregistration_files\\figure-html"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}