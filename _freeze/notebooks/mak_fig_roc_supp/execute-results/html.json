{
  "hash": "fd395d738a41e759dbf98c446d1d6ef2",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Make 30-fold ROC Figure (Supplement)\"\nauthor: \"Gaylen Fronk & John Curtin\"\ndate: \"2024-06-04\"\nnumber-sections: true\noutput: \n  html_document:\n    toc: true \n    toc_depth: 4\nformat:\n  html:\n    embed-resources: true\n    toc: true\n    toc-depth: 4\neditor_options: \n  chunk_output_type: console\n---\n\n\n## Set Up Environment\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nversion <- \"v6\"\ncv <- \"nested\"\n```\n:::\n\n\nFunction conflicts\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\n# source\ndevtools::source_url(\"https://github.com/jjcurtin/lab_support/blob/main/fun_ml.R?raw=true\")\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nℹ SHA-1 hash of file is \"77e91675366f10788c6bcb59fa1cfc9ee0c75281\"\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\n# handle conflicts\noptions(conflicts.policy = \"depends.ok\")\ntidymodels_conflictRules()\n```\n:::\n\n\nPackages for script\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.4     ✔ readr     2.1.5\n✔ forcats   1.0.0     ✔ stringr   1.5.1\n✔ ggplot2   3.5.1     ✔ tibble    3.2.1\n✔ lubridate 1.9.3     ✔ tidyr     1.3.1\n✔ purrr     1.0.2     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\nlibrary(tidymodels)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n── Attaching packages ────────────────────────────────────── tidymodels 1.2.0 ──\n✔ broom        1.0.5      ✔ rsample      1.2.1 \n✔ dials        1.2.1      ✔ tune         1.2.1 \n✔ infer        1.0.7      ✔ workflows    1.1.4 \n✔ modeldata    1.3.0      ✔ workflowsets 1.1.0 \n✔ parsnip      1.2.1      ✔ yardstick    1.3.1 \n✔ recipes      1.0.10     \n── Conflicts ───────────────────────────────────────── tidymodels_conflicts() ──\n✖ scales::discard() masks purrr::discard()\n✖ dplyr::filter()   masks stats::filter()\n✖ recipes::fixed()  masks stringr::fixed()\n✖ dplyr::lag()      masks stats::lag()\n✖ yardstick::spec() masks readr::spec()\n✖ recipes::step()   masks stats::step()\n• Use tidymodels_prefer() to resolve common conflicts.\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\nlibrary(tidyposterior)\nlibrary(patchwork)\n\ntheme_set(theme_classic()) \n```\n:::\n\n\nSource support functions\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n# EDA\ndevtools::source_url(\"https://github.com/jjcurtin/lab_support/blob/main/fun_eda.R?raw=true\")\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nℹ SHA-1 hash of file is \"c045eee2655a18dc85e715b78182f176327358a7\"\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n# CHTC support functions\ndevtools::source_url(\"https://github.com/jjcurtin/lab_support/blob/main/chtc/static_files/fun_chtc.R?raw=true\")\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nℹ SHA-1 hash of file is \"75cc6f7b855da59c240908bd936834b4da01285b\"\n```\n\n\n:::\n:::\n\n\nAbsolute paths\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nswitch (Sys.info()[['sysname']],\n        # PC paths\n        Windows = {\n          path_models <- str_c(\"P:/studydata/match/models/\")},\n        \n        # IOS paths\n        Darwin = {\n          path_models <- str_c(\"/Volumes/private/studydata/match/models/\")},\n        \n        # Linux paths\n        Linux = {\n          path_models <- str_c(\"~/mnt/private/studydata/match/models/\")}\n)\n```\n:::\n\n\nChunk Defaults\n\n::: {.cell .hidden}\n\n```{.r .cell-code .hidden}\n#| include: false\n\nknitr::opts_chunk$set(attr.output='style=\"max-height: 500px;\"')\n\noptions(tibble.width = Inf)\noptions(tibble.print_max = Inf)\n```\n:::\n\n\n\nSource training controls \n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n# EDA\ndevtools::source_url(\"https://github.com/jjcurtin/lab_support/blob/main/fun_eda.R?raw=true\")\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nℹ SHA-1 hash of file is \"c045eee2655a18dc85e715b78182f176327358a7\"\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n# ML functions\ndevtools::source_url(\"https://github.com/jjcurtin/lab_support/blob/main/fun_ml.R?raw=true\")\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nℹ SHA-1 hash of file is \"77e91675366f10788c6bcb59fa1cfc9ee0c75281\"\n```\n\n\n:::\n:::\n\n\n## Read in model performance metrics\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\npreds4 <- read_rds(file.path(path_models, \"pp_hybrid_wk4_outcome\",\n                             str_c(\"outer_preds_\", version, \n                                   \"_\", cv, \".rds\"))) |> \n  glimpse()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```{style=\"max-height: 500px;\"}\nRows: 3,258\nColumns: 3\n$ outer_split_num <dbl> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …\n$ prob_raw        <dbl> 0.1909314, 0.4794358, 0.3849448, 0.2902418, 0.3972917,…\n$ label           <fct> smoking, smoking, smoking, smoking, abstinent, abstine…\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\npreds12 <- read_rds(file.path(path_models, \"pp_hybrid_wk12_outcome\",\n                             str_c(\"outer_preds_\", version, \n                                   \"_\", cv, \".rds\"))) |> \n  glimpse()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```{style=\"max-height: 500px;\"}\nRows: 3,258\nColumns: 3\n$ outer_split_num <dbl> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …\n$ prob_raw        <dbl> 0.1862854, 0.3980996, 0.3649690, 0.1939145, 0.3186398,…\n$ label           <fct> smoking, smoking, smoking, smoking, abstinent, abstine…\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\npreds26 <- read_rds(file.path(path_models, \"pp_hybrid_wk26_outcome\",\n                             str_c(\"outer_preds_\", version, \n                                   \"_\", cv, \".rds\"))) |> \n  glimpse()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```{style=\"max-height: 500px;\"}\nRows: 3,258\nColumns: 3\n$ outer_split_num <dbl> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …\n$ prob_raw        <dbl> 0.10822448, 0.36604609, 0.21339801, 0.11732050, 0.2180…\n$ label           <fct> smoking, smoking, smoking, smoking, smoking, abstinent…\n```\n\n\n:::\n:::\n\n\n## ROC curves\n\n### 4-week model\n\nSet up\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nroc_data4 <- preds4 %>%\n  roc_curve(prob_raw, truth = label)\n\n# rocs per fold\nroc_folds4 <- preds4 %>%\n  nest(.by = outer_split_num, .key = \"preds\") |> \n  mutate(roc = map(preds, \\(preds) roc_curve(preds, prob_raw, \n                                             truth = label)))\n\nfig_roc_folds4 <- roc_data4 %>%  # plot region from full concatenated data \n  ggplot(aes(x = 1 - specificity, y = sensitivity)) + \n  geom_abline(lty = 3) +\n  coord_fixed(xlim = c(0, 1), ylim = c(0, 1)) +\n  labs(x = \"False Positive Rate\",\n       y = \"True Positive Rate\") +\n  scale_x_continuous(breaks = seq(0,1,.25),\n                     labels = sprintf(\"%.2f\", seq(1,0,-.25))) +\n  theme(axis.text = element_text(size = rel(0.75)),\n        axis.title = element_text(size = rel(1)))\n\nfor (i in 1:nrow(roc_folds4)) {\n  fig_roc_folds4 <- fig_roc_folds4 +\n    geom_path(data = roc_folds4$roc[[i]],\n              mapping = aes(x = 1 - specificity, y = sensitivity),\n              color = \"gray\")\n}\n```\n:::\n\n::: {#cell-fig-roc-wk4 .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-roc-wk4\n\n#add full concatenated curve\nfig_roc_all_wk4 <- fig_roc_folds4 +\n  geom_path(data = roc_data4,\n            mapping = aes(x = 1 - specificity, y = sensitivity, color = \"red\"),\n            linewidth = 2) +\n  labs(x = \"False Positive Rate\",\n       title = \"Week 4 ROC Curves\") +\n  theme(legend.position = \"none\")\n\nfig_roc_all_wk4\n```\n\n::: {.cell-output-display}\n![](mak_fig_roc_supp_files/figure-html/fig-roc-wk4-1.png){#fig-roc-wk4 width=672}\n:::\n:::\n\n\n### 12-week model\n\nSet up\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nroc_data12 <- preds12 %>%\n  roc_curve(prob_raw, truth = label)\n\n# rocs per fold\nroc_folds12 <- preds12 %>%\n  nest(.by = outer_split_num, .key = \"preds\") |> \n  mutate(roc = map(preds, \\(preds) roc_curve(preds, prob_raw, \n                                             truth = label)))\n\nfig_roc_folds12 <- roc_data12 %>%  # plot region from full concatenated data \n  ggplot(aes(x = 1 - specificity, y = sensitivity)) + \n  geom_abline(lty = 3) +\n  coord_fixed(xlim = c(0, 1), ylim = c(0, 1)) +\n  labs(x = \"False Positive Rate\",\n       y = \"True Positive Rate\") +\n  scale_x_continuous(breaks = seq(0,1,.25),\n                     labels = sprintf(\"%.2f\", seq(1,0,-.25))) +\n  theme(axis.text = element_text(size = rel(0.75)),\n        axis.title = element_text(size = rel(1)))\n\nfor (i in 1:nrow(roc_folds12)) {\n  fig_roc_folds12 <- fig_roc_folds12 +\n    geom_path(data = roc_folds12$roc[[i]],\n              mapping = aes(x = 1 - specificity, y = sensitivity),\n              color = \"gray\")\n}\n```\n:::\n\n::: {#cell-fig-roc-wk12 .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-roc-wk12\n\n#add full concatenated curve\nfig_roc_all_wk12 <- fig_roc_folds12 +\n  geom_path(data = roc_data12,\n            mapping = aes(x = 1 - specificity, y = sensitivity, color = \"red\"),\n            linewidth = 2) +\n  labs(x = \"False Positive Rate\",\n       title = \"Week 12 ROC Curves\") +\n  theme(legend.position = \"none\")\n\nfig_roc_all_wk12\n```\n\n::: {.cell-output-display}\n![](mak_fig_roc_supp_files/figure-html/fig-roc-wk12-1.png){#fig-roc-wk12 width=672}\n:::\n:::\n\n\n### 26-week model\n\nSet up\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nroc_data26 <- preds26 %>%\n  roc_curve(prob_raw, truth = label)\n\n# rocs per fold\nroc_folds26 <- preds26 %>%\n  nest(.by = outer_split_num, .key = \"preds\") |> \n  mutate(roc = map(preds, \\(preds) roc_curve(preds, prob_raw, \n                                             truth = label)))\n\nfig_roc_folds26 <- roc_data26 %>%  # plot region from full concatenated data \n  ggplot(aes(x = 1 - specificity, y = sensitivity)) + \n  geom_abline(lty = 3) +\n  coord_fixed(xlim = c(0, 1), ylim = c(0, 1)) +\n  labs(x = \"False Positive Rate\",\n       y = \"True Positive Rate\") +\n  scale_x_continuous(breaks = seq(0,1,.25),\n                     labels = sprintf(\"%.2f\", seq(1,0,-.25))) +\n  theme(axis.text = element_text(size = rel(0.75)),\n        axis.title = element_text(size = rel(1)))\n\nfor (i in 1:nrow(roc_folds26)) {\n  fig_roc_folds26 <- fig_roc_folds26 +\n    geom_path(data = roc_folds26$roc[[i]],\n              mapping = aes(x = 1 - specificity, y = sensitivity),\n              color = \"gray\")\n}\n```\n:::\n\n::: {#cell-fig-roc-wk26 .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-roc-wk26\n\n#add full concatenated curve\nfig_roc_all_wk26 <- fig_roc_folds26 +\n  geom_path(data = roc_data26,\n            mapping = aes(x = 1 - specificity, y = sensitivity, color = \"red\"),\n            linewidth = 2) +\n  labs(x = \"False Positive Rate\",\n       title = \"Week 26 ROC Curves\") +\n  theme(legend.position = \"none\")\n\nfig_roc_all_wk26\n```\n\n::: {.cell-output-display}\n![](mak_fig_roc_supp_files/figure-html/fig-roc-wk26-1.png){#fig-roc-wk26 width=672}\n:::\n:::\n\n\n## Make paneled figure\n\n\n::: {#cell-fig-roc-all .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-roc-all\n#| fig-cap: \"Supplemental Figure 1: ROC Curves. Dotted, diagonal line represents chance performance (0.5). Grey lines display individual ROC curves from each of 30 held-out folds. Thick, red line displays ROC curve concatenated across all 30 held-out folds. A) 4-week model. B) 12-week model. C) 26-week model.\"\n#| fig-height: 10\n\nfig_roc_all <- fig_roc_all_wk4 + fig_roc_all_wk12 + fig_roc_all_wk26 + \n  plot_layout(ncol = 1) +\n  plot_annotation(tag_levels = \"A\")\n\nfig_roc_all\n```\n\n::: {.cell-output-display}\n![Supplemental Figure 1: ROC Curves. Dotted, diagonal line represents chance performance (0.5). Grey lines display individual ROC curves from each of 30 held-out folds. Thick, red line displays ROC curve concatenated across all 30 held-out folds. A) 4-week model. B) 12-week model. C) 26-week model.](mak_fig_roc_supp_files/figure-html/fig-roc-all-1.png){#fig-roc-all width=672}\n:::\n:::\n",
    "supporting": [
      "mak_fig_roc_supp_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}