{
  "hash": "1104c99f9a8fd54e3dba590e4f156242",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Make Calibration Figures (Supplement)\"\nauthor: \"Gaylen Fronk\"\ndate: \"2024-06-05\"\nnumber-sections: true\noutput: \n  html_document:\n    toc: true \n    toc_depth: 4\nformat:\n  html:\n    embed-resources: true\n    toc: true\n    toc-depth: 4\neditor_options: \n  chunk_output_type: console\n---\n\n\n## Setup\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nversion <- \"v6\"\ncv <- \"nested\"\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\n# packages for script\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.4     ✔ readr     2.1.5\n✔ forcats   1.0.0     ✔ stringr   1.5.1\n✔ ggplot2   3.5.1     ✔ tibble    3.2.1\n✔ lubridate 1.9.3     ✔ tidyr     1.3.1\n✔ purrr     1.0.2     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\nlibrary(tidymodels)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n── Attaching packages ────────────────────────────────────── tidymodels 1.2.0 ──\n✔ broom        1.0.5      ✔ rsample      1.2.1 \n✔ dials        1.2.1      ✔ tune         1.2.1 \n✔ infer        1.0.7      ✔ workflows    1.1.4 \n✔ modeldata    1.3.0      ✔ workflowsets 1.1.0 \n✔ parsnip      1.2.1      ✔ yardstick    1.3.1 \n✔ recipes      1.0.10     \n── Conflicts ───────────────────────────────────────── tidymodels_conflicts() ──\n✖ scales::discard() masks purrr::discard()\n✖ dplyr::filter()   masks stats::filter()\n✖ recipes::fixed()  masks stringr::fixed()\n✖ dplyr::lag()      masks stats::lag()\n✖ yardstick::spec() masks readr::spec()\n✖ recipes::step()   masks stats::step()\n• Learn how to get started at https://www.tidymodels.org/start/\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\nlibrary(tidyposterior)\nlibrary(probably)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n\nAttaching package: 'probably'\n\nThe following objects are masked from 'package:base':\n\n    as.factor, as.ordered\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\nlibrary(patchwork)\n\ndevtools::source_url(\"https://github.com/jjcurtin/lab_support/blob/main/fun_eda.R?raw=true\")\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nℹ SHA-1 hash of file is \"c045eee2655a18dc85e715b78182f176327358a7\"\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\ndevtools::source_url(\"https://github.com/jjcurtin/lab_support/blob/main/chtc/static_files/fun_chtc.R?raw=true\")\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nℹ SHA-1 hash of file is \"75cc6f7b855da59c240908bd936834b4da01285b\"\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\ntheme_set(theme_classic()) \n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\n# handle conflicts\noptions(conflicts.policy = \"depends.ok\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nswitch (Sys.info()[['sysname']],\n        # PC paths\n        Windows = {\n          path_models <- str_c(\"P:/studydata/match/models/\")\n        },\n        \n        # IOS paths\n        Darwin = {\n          path_models <- str_c(\"/Volumes/private/studydata/match/models/\")\n        },\n        \n        # Linux paths\n        Linux = {\n          path_models <- str_c(\"~/mnt/private/studydata/match/models/\")\n        }\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n# chunk defaults\n\noptions(tibble.width = Inf)\noptions(tibble.print_max = Inf)\n```\n:::\n\n\n## Individual Calibration Plots\n\nRead in final model predictions (LOOCV)\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\ny_col_4 <- \"pp_hybrid_wk4_outcome\"\ny_col_12 <- \"pp_hybrid_wk12_outcome\"\ny_col_26 <- \"pp_hybrid_wk26_outcome\"\n\nd_cal_4 <- read_csv(file.path(path_models, y_col_4,\n                               str_c(\"aim_2_\", version, \"_\", y_col_4, \".csv\")),\n                     show_col_types = FALSE) |> \n  glimpse()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 1,086\nColumns: 11\n$ subid            <dbl> 20010, 20015, 20030, 20049, 20051, 20072, 20077, 2008…\n$ tx_rct           <chr> \"patch\", \"combo_nrt\", \"patch\", \"varenicline\", \"patch\"…\n$ tx_best          <chr> \"varenicline\", \"varenicline\", \"combo_nrt\", \"varenicli…\n$ tx_match         <lgl> FALSE, FALSE, FALSE, TRUE, FALSE, TRUE, FALSE, FALSE,…\n$ prob_best        <dbl> 0.2799119, 0.5102584, 0.3089657, 0.4553562, 0.4605510…\n$ outcome_rct_wk4  <chr> \"smoking\", \"smoking\", \"smoking\", \"smoking\", \"smoking\"…\n$ outcome_rct_wk12 <chr> \"smoking\", \"smoking\", \"smoking\", \"abstinent\", \"smokin…\n$ outcome_rct_wk26 <chr> \"smoking\", \"smoking\", \"smoking\", \"abstinent\", \"smokin…\n$ prob_patch       <dbl> 0.2080906, 0.4220443, 0.2330746, 0.3961983, 0.3172879…\n$ prob_combo_nrt   <dbl> 0.1754414, 0.4957828, 0.3089657, 0.4056079, 0.4605510…\n$ prob_varenicline <dbl> 0.2799119, 0.5102584, 0.2883452, 0.4553562, 0.4409814…\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nd_cal_12 <- read_csv(file.path(path_models, y_col_12,\n                               str_c(\"aim_2_\", version, \"_\", y_col_12, \".csv\")),\n                     show_col_types = FALSE) |> \n  glimpse()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 1,086\nColumns: 11\n$ subid            <dbl> 20010, 20015, 20030, 20049, 20051, 20072, 20077, 2008…\n$ tx_rct           <chr> \"patch\", \"combo_nrt\", \"patch\", \"varenicline\", \"patch\"…\n$ tx_best          <chr> \"combo_nrt\", \"varenicline\", \"combo_nrt\", \"varenicline…\n$ tx_match         <lgl> FALSE, FALSE, FALSE, TRUE, FALSE, FALSE, FALSE, FALSE…\n$ prob_best        <dbl> 0.1860530, 0.5184533, 0.3185973, 0.4938523, 0.4883779…\n$ outcome_rct_wk12 <chr> \"smoking\", \"smoking\", \"smoking\", \"abstinent\", \"smokin…\n$ outcome_rct_wk4  <chr> \"smoking\", \"smoking\", \"smoking\", \"smoking\", \"smoking\"…\n$ outcome_rct_wk26 <chr> \"smoking\", \"smoking\", \"smoking\", \"abstinent\", \"smokin…\n$ prob_patch       <dbl> 0.1610573, 0.3272543, 0.2825550, 0.3491451, 0.4286955…\n$ prob_combo_nrt   <dbl> 0.1860530, 0.3877443, 0.3185973, 0.4018380, 0.4309108…\n$ prob_varenicline <dbl> 0.1601103, 0.5184533, 0.2743758, 0.4938523, 0.4883779…\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nd_cal_26 <- read_csv(file.path(path_models, y_col_26,\n                               str_c(\"aim_2_\", version, \"_\", y_col_26, \".csv\")),\n                     show_col_types = FALSE) |> \n  glimpse()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 1,086\nColumns: 11\n$ subid            <dbl> 20010, 20015, 20030, 20049, 20051, 20072, 20077, 2008…\n$ tx_rct           <chr> \"patch\", \"combo_nrt\", \"patch\", \"varenicline\", \"patch\"…\n$ tx_best          <chr> \"combo_nrt\", \"combo_nrt\", \"combo_nrt\", \"varenicline\",…\n$ tx_match         <lgl> FALSE, TRUE, FALSE, TRUE, FALSE, TRUE, FALSE, FALSE, …\n$ prob_best        <dbl> 0.1874374, 0.2612399, 0.2328017, 0.3057146, 0.2614553…\n$ outcome_rct_wk26 <chr> \"smoking\", \"smoking\", \"smoking\", \"abstinent\", \"smokin…\n$ outcome_rct_wk4  <chr> \"smoking\", \"smoking\", \"smoking\", \"smoking\", \"smoking\"…\n$ outcome_rct_wk12 <chr> \"smoking\", \"smoking\", \"smoking\", \"abstinent\", \"smokin…\n$ prob_patch       <dbl> 0.1445079, 0.2329569, 0.1925487, 0.2558933, 0.2404972…\n$ prob_combo_nrt   <dbl> 0.1874374, 0.2612399, 0.2328017, 0.2565972, 0.2576872…\n$ prob_varenicline <dbl> 0.1100380, 0.2481624, 0.1514820, 0.3057146, 0.2614553…\n```\n\n\n:::\n:::\n\n\nSet up data\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nd_cal_4 <- d_cal_4 |> \n  mutate(.pred_abstinent = case_when(\n    tx_rct == \"patch\" ~ prob_patch,\n    tx_rct == \"combo_nrt\" ~ prob_combo_nrt,\n    tx_rct == \"varenicline\" ~ prob_varenicline,\n    TRUE ~ NA_real_\n  )) |> \n  select(outcome_rct = outcome_rct_wk4, .pred_abstinent) |> \n  mutate(outcome_rct = factor(outcome_rct,\n                              levels = c(\"abstinent\", \"smoking\"))) |> \n  glimpse()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 1,086\nColumns: 2\n$ outcome_rct     <fct> smoking, smoking, smoking, smoking, smoking, smoking, …\n$ .pred_abstinent <dbl> 0.2080906, 0.4957828, 0.2330746, 0.4553562, 0.3172879,…\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nd_cal_12 <- d_cal_12 |> \n  mutate(.pred_abstinent = case_when(\n    tx_rct == \"patch\" ~ prob_patch,\n    tx_rct == \"combo_nrt\" ~ prob_combo_nrt,\n    tx_rct == \"varenicline\" ~ prob_varenicline,\n    TRUE ~ NA_real_\n  )) |> \n  select(outcome_rct = outcome_rct_wk12, .pred_abstinent) |> \n  mutate(outcome_rct = factor(outcome_rct,\n                              levels = c(\"abstinent\", \"smoking\"))) |> \n  glimpse()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 1,086\nColumns: 2\n$ outcome_rct     <fct> smoking, smoking, smoking, abstinent, smoking, smoking…\n$ .pred_abstinent <dbl> 0.1610573, 0.3877443, 0.2825550, 0.4938523, 0.4286955,…\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nd_cal_26 <- d_cal_26 |> \n  mutate(.pred_abstinent = case_when(\n    tx_rct == \"patch\" ~ prob_patch,\n    tx_rct == \"combo_nrt\" ~ prob_combo_nrt,\n    tx_rct == \"varenicline\" ~ prob_varenicline,\n    TRUE ~ NA_real_\n  )) |> \n  select(outcome_rct = outcome_rct_wk26, .pred_abstinent) |> \n  mutate(outcome_rct = factor(outcome_rct,\n                              levels = c(\"abstinent\", \"smoking\"))) |> \n  glimpse()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 1,086\nColumns: 2\n$ outcome_rct     <fct> smoking, smoking, smoking, abstinent, smoking, smoking…\n$ .pred_abstinent <dbl> 0.1445079, 0.2612399, 0.1925487, 0.3057146, 0.2404972,…\n```\n\n\n:::\n:::\n\n\nCreated binned plot\n\n::: {#cell-fig-cal-bins-wk4 .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-cal-bins-wk4\n\nbin_width = 0.10\n\nfig_cal_bins_4 <- d_cal_4 |> \n  rename(prob_raw = .pred_abstinent) |> \n  mutate(bins = cut(prob_raw, breaks = seq(0, 1, bin_width)),\n         abstinent = if_else(outcome_rct == \"abstinent\", 1, 0)) |> \n  group_by(bins)  |> \n  summarize(mean_abstinent = mean(abstinent),\n            .groups = \"drop\") |>\n  mutate(bins = as.numeric(bins),\n         midpoints = bin_width/2 + bin_width * (bins - 1))  |> \n  ggplot(data = _, aes(x = midpoints, y = mean_abstinent)) +\n  geom_abline(slope = 1, intercept = 0, linetype = \"dotted\") +\n  geom_line() +\n  geom_point() +\n  xlab(\"Predicted Abstinence Probability (bin mid-point)\") +\n  ylab(\"Observed Abstinence Probability\") +\n  scale_x_continuous(breaks = seq(0, 1, bin_width),\n                     limits = c(0, 1)) +\n  scale_y_continuous(breaks = seq(0, 1, bin_width),\n                     limits = c(0, 1)) +\n  theme(axis.text = element_text(size = rel(1)),\n        axis.title = element_text(size = rel(1)))\n\nfig_cal_bins_4\n```\n\n::: {.cell-output-display}\n![](mak_fig_cal_supp_files/figure-html/fig-cal-bins-wk4-1.png){#fig-cal-bins-wk4 width=672}\n:::\n:::\n\n\nCreated binned plot week 12\n\n::: {#cell-fig-cal-bins-wk12 .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-cal-bins-wk12\n\nbin_width = 0.10\n\nfig_cal_bins_12 <- d_cal_12 |> \n  rename(prob_raw = .pred_abstinent) |> \n  mutate(bins = cut(prob_raw, breaks = seq(0, 1, bin_width)),\n         abstinent = if_else(outcome_rct == \"abstinent\", 1, 0)) |> \n  group_by(bins)  |> \n  summarize(mean_abstinent = mean(abstinent),\n            .groups = \"drop\") |>\n  mutate(bins = as.numeric(bins),\n         midpoints = bin_width/2 + bin_width * (bins - 1))  |> \n  ggplot(data = _, aes(x = midpoints, y = mean_abstinent)) +\n  geom_abline(slope = 1, intercept = 0, linetype = \"dotted\") +\n  geom_line() +\n  geom_point() +\n  labs(\n    x = \"Predicted Abstinence Probability (bin mid-point)\",\n    y = \"Observed Abstinence Probability\",\n    title = \"Week 12 Model Calibration\") +\n  scale_x_continuous(breaks = seq(0, 1, bin_width),\n                     limits = c(0, 1)) +\n  scale_y_continuous(breaks = seq(0, 1, bin_width),\n                     limits = c(0, 1)) +\n  theme(axis.text = element_text(size = rel(1)),\n        axis.title = element_text(size = rel(1)))\n\nfig_cal_bins_12\n```\n\n::: {.cell-output-display}\n![](mak_fig_cal_supp_files/figure-html/fig-cal-bins-wk12-1.png){#fig-cal-bins-wk12 width=672}\n:::\n:::\n\n\nCreated binned plot week 26\n\n::: {#cell-fig-cal-bins-wk26 .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-cal-bins-wk26\n\nbin_width = 0.10\n\nfig_cal_bins_26 <- d_cal_26 |> \n  rename(prob_raw = .pred_abstinent) |> \n  mutate(bins = cut(prob_raw, breaks = seq(0, 1, bin_width)),\n         abstinent = if_else(outcome_rct == \"abstinent\", 1, 0)) |> \n  group_by(bins)  |> \n  summarize(mean_abstinent = mean(abstinent),\n            .groups = \"drop\") |>\n  mutate(bins = as.numeric(bins),\n         midpoints = bin_width/2 + bin_width * (bins - 1))  |> \n  ggplot(data = _, aes(x = midpoints, y = mean_abstinent)) +\n  geom_abline(slope = 1, intercept = 0, linetype = \"dotted\") +\n  geom_line() +\n  geom_point() +\n  labs(\n    x = \"Predicted Abstinence Probability (bin mid-point)\",\n    y = \"Observed Abstinence Probability\",\n    title = \"Week 26 Model Calibration\") +\n  scale_x_continuous(breaks = seq(0, 1, bin_width),\n                     limits = c(0, 1)) +\n  scale_y_continuous(breaks = seq(0, 1, bin_width),\n                     limits = c(0, 1)) +\n  theme(axis.text = element_text(size = rel(1)),\n        axis.title = element_text(size = rel(1)))\n\nfig_cal_bins_26\n```\n\n::: {.cell-output-display}\n![](mak_fig_cal_supp_files/figure-html/fig-cal-bins-wk26-1.png){#fig-cal-bins-wk26 width=672}\n:::\n:::\n\n\n## Combine plots into paneled figure\n\n\n::: {#cell-fig-cal-supp .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-cal-supp\n#| fig-cap: \"(Supplemental) Binned calibration plots. A) 4-week model. B) 12-week model. C) 26-week model.\"\n#| fig-height: 11\n\nfig_cal_supp <- (fig_cal_bins_4 / fig_cal_bins_12 / fig_cal_bins_26) +\n  plot_layout(ncol = 1,\n              heights = unit(c(2.5, 2.5, 2.5), \"in\"),\n              widths = unit(c(3.5, 3.5, 3.5), \"in\")) +\n  plot_annotation(tag_levels = \"A\")\n\nfig_cal_supp\n```\n\n::: {.cell-output-display}\n![(Supplemental) Binned calibration plots. A) 4-week model. B) 12-week model. C) 26-week model.](mak_fig_cal_supp_files/figure-html/fig-cal-supp-1.png){#fig-cal-supp width=672}\n:::\n:::\n",
    "supporting": [
      "mak_fig_cal_supp_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}