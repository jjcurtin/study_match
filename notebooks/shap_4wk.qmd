---
title: "SHAP for 4-Week Model"
author: "Gaylen Fronk"
date: "`r lubridate::today()`"
number-sections: true
output: 
  html_document:
    toc: true 
    toc_depth: 4
format:
  html:
    embed-resources: true
    toc: true
    toc-depth: 4
editor_options: 
  chunk_output_type: console
---

```{r set_variables}
study <- "match"
version <- "v6"
y_col_name <- "pp_hybrid_wk4_outcome"
```

```{r, packages_script}
#| message: false
#| warning: false

# packages for script
library(tidyverse)
library(patchwork)

theme_set(theme_classic()) 
```

```{r, packages_workflow}
#| message: false
#| warning: false

# handle conflicts
options(conflicts.policy = "depends.ok")
```

```{r, absolute paths}

# absolute paths
switch (Sys.info()[['sysname']],
        # PC paths
        Windows = {
          path_data <- str_c("P:/studydata/match/chtc/", y_col_name)},
        
        # IOS paths
        Darwin = {
          path_data <- str_c("/Volumes/private/studydata/match/chtc/", y_col_name)},
        
        # Linux paths
        Linux = {
          path_data <- str_c("~/mnt/private/studydata/match/chtc/", y_col_name)}
)
```

```{r defaults}

# chunk defaults

options(tibble.width = Inf)
options(tibble.print_max = Inf)
```

## Read in data

SHAP obtained with LOOCV at CHTC
```{r}
local <- read_csv(file.path(path_data, str_c("shap_loocv_", version), 
                            "output", "batch_results.csv"),
                  col_types = "cddd")

glimpse(local)
```
This dataset is already local SHAP values because we have one observation per subid per variable.

## Get global Shapley values

```{r}
global <- local |> 
  mutate(abs_contribution = abs(contribution)) |> 
  group_by(variable_name) |> 
  summarize(mean_contribution = mean(abs_contribution)) |> 
  arrange(desc(mean_contribution))

glimpse(global)

```

Delineate treatment interactions
```{r}
global <- global |> 
  mutate(tx_int = if_else(str_detect(variable_name, "treatment_"), "Interaction", "Main Effect"))

local <- local |> 
  mutate(tx_int = if_else(str_detect(variable_name, "treatment_"), "Interaction", "Main Effect"))
```

## Make global figures

Overall
```{r}

fig_shap_global <- global |> 
  arrange(desc(mean_contribution)) |> 
  slice(1:25) |> 
  arrange(mean_contribution) |> 
  mutate(variable_name = str_replace(variable_name, "treatment_", "")) |> 
  mutate(variable_name = fct_inorder(variable_name)) |> 
  ggplot(mapping = aes(x = variable_name, y = mean_contribution, color = tx_int)) +
  geom_point(size = 2) +
  geom_segment(aes(x = variable_name, y = mean_contribution, xend = variable_name),
               yend = 0) +
  labs(
    x = "",
    y = "Mean |Shapley value|",
    color = "Feature Type",
    title = "All Features"
  ) +
  coord_flip() +
  theme(legend.position = "bottom")

fig_shap_global
```

Global Shapley values among treatment interactions
```{r}

fig_shap_global_tx <- global |> 
  filter(tx_int == "Interaction") |> 
  arrange(desc(mean_contribution)) |> 
  slice(1:25) |> 
  arrange(mean_contribution) |> 
  mutate(variable_name = str_replace(variable_name, "treatment_", "")) |> 
  mutate(variable_name = fct_inorder(variable_name)) |> 
  ggplot(mapping = aes(x = variable_name, y = mean_contribution, color = tx_int)) +
  geom_point(size = 2) +
  geom_segment(aes(x = variable_name, y = mean_contribution, xend = variable_name),
               yend = 0) +
  labs(
    x = "",
    y = "Mean |Shapley value|",
    title = "Interaction Features"
  ) +
  coord_flip() +
  theme(legend.position = "none")

fig_shap_global_tx
```

Paneled Global figure
```{r}
#| label: fig-shap-global
#| fig-height: 9
#| fig-cap: "Global Shapley values for the 25 features with the highest importance. Bar represents magnitude of the overall feature importance, which is calculated from the mean of the absolute value across all observations for that feature. A) Global feature importance among all features. B) Global feature importance among treatment interaction features."
#| 
fig_panel_shap_global <- (fig_shap_global / fig_shap_global_tx / guide_area()) +
  plot_layout(guides = "collect", axes = "collect", ncol = 1,
              heights = unit(c(3, 3, 0.5), "in")) +
  plot_annotation(tag_levels = "A",
                  title = "Top Global Shapley Values")

fig_panel_shap_global
```

## Make Sina plots (local) 

Set up data
```{r}
local_fig <- global |>
  arrange(desc(mean_contribution)) |> 
  slice(1:25) |> 
  left_join(local, by = c("variable_name", "tx_int"))

local_fig_tx <- global |> 
  filter(tx_int == "Interaction") |> 
  arrange(desc(mean_contribution)) |> 
  slice(1:25) |> 
  left_join(local, by = c("variable_name", "tx_int"))
```


Overall
```{r}
fig_shap_local_all <- local_fig |>
  arrange(mean_contribution) |> 
  mutate(variable_name = str_replace(variable_name, "treatment_", "")) |> 
  mutate(variable_name = fct_inorder(variable_name)) |> 
  ggplot(mapping = aes(x = variable_name, y = contribution,
                       color = tx_int)) +
  ggforce::geom_sina(method = "counts", maxwidth = 0.7, alpha = 0.4) +
  geom_hline(yintercept = 0) +
  scale_y_continuous(limits = c(-0.15, 0.2)) +
  labs(
    x = "",
    y = "Shapley Value",
    color = "Feature Type",
    title = "All Features"
  ) +
  theme(axis.text = element_text(size = 9.5),
        legend.position = "bottom") +
  coord_flip()

fig_shap_local_all

```

Local Shapley values among treatment interactions
```{r}

fig_shap_local_tx <- local_fig_tx |> 
  arrange(mean_contribution) |> 
  mutate(variable_name = str_replace(variable_name, "treatment_", "")) |> 
  mutate(variable_name = fct_inorder(variable_name)) |> 
  ggplot(mapping = aes(x = variable_name, y = contribution,
                       color = tx_int)) +
  ggforce::geom_sina(method = "counts", maxwidth = 0.7, alpha = 0.4) +
  geom_hline(yintercept = 0) +
  scale_y_continuous(limits = c(-0.15, 0.2)) +
  labs(
    x = "",
    y = "Shapley Value",
    title = "Interaction Features"
  ) +
  theme(axis.text = element_text(size = 9.5),
        legend.position = "none") +
  coord_flip()

fig_shap_local_tx
```

Paneled local figure
```{r}
#| label: fig-shap-local
#| fig-height: 9
#| fig-cap: "Local Shapley values for features with the highest global importance. Each dot represents the influence of that feature on a specific observation. A) Local feature importance among all features. B) Local feature importance among treatment interaction features."
#| 
fig_panel_shap_local <- (fig_shap_local_all / fig_shap_local_tx / guide_area()) +
  plot_layout(guides = "collect", axes = "collect", ncol = 1,
              heights = unit(c(3, 3, 0.5), "in")) +
  plot_annotation(tag_levels = "A",
                  title = "Local Shapley Values")

fig_panel_shap_local
```


