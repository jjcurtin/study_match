{
  "hash": "7acad8b900869eca9d71907786617fed",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"SHAP for 4-Week Model\"\nauthor: \"Gaylen Fronk\"\ndate: \"2024-06-03\"\nnumber-sections: true\noutput: \n  html_document:\n    toc: true \n    toc_depth: 4\nformat:\n  html:\n    embed-resources: true\n    toc: true\n    toc-depth: 4\neditor_options: \n  chunk_output_type: console\n---\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nstudy <- \"match\"\nversion <- \"v6\"\ny_col_name <- \"pp_hybrid_wk4_outcome\"\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\n# packages for script\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.4     ✔ readr     2.1.5\n✔ forcats   1.0.0     ✔ stringr   1.5.1\n✔ ggplot2   3.5.1     ✔ tibble    3.2.1\n✔ lubridate 1.9.3     ✔ tidyr     1.3.1\n✔ purrr     1.0.2     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\nlibrary(patchwork)\n\ntheme_set(theme_classic()) \n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\n# handle conflicts\noptions(conflicts.policy = \"depends.ok\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n# absolute paths\nswitch (Sys.info()[['sysname']],\n        # PC paths\n        Windows = {\n          path_data <- str_c(\"P:/studydata/match/chtc/\", y_col_name)},\n        \n        # IOS paths\n        Darwin = {\n          path_data <- str_c(\"/Volumes/private/studydata/match/chtc/\", y_col_name)},\n        \n        # Linux paths\n        Linux = {\n          path_data <- str_c(\"~/mnt/private/studydata/match/chtc/\", y_col_name)}\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n# chunk defaults\n\noptions(tibble.width = Inf)\noptions(tibble.print_max = Inf)\n```\n:::\n\n\n## Read in data\n\nSHAP obtained with LOOCV at CHTC\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nlocal <- read_csv(file.path(path_data, str_c(\"shap_loocv_\", version), \n                            \"output\", \"batch_results.csv\"),\n                  col_types = \"cddd\")\n\nglimpse(local)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 1,272,852\nColumns: 4\n$ variable_name  <chr> \"age_1st_cig\", \"age_daily_smoker\", \"age_ehr\", \"alc_bing…\n$ variable_value <dbl> 0.18140, -0.56780, 0.57420, 0.70530, 1.41800, -0.02156,…\n$ contribution   <dbl> 0.0000000000, 0.0000000000, 0.0000000000, 0.0000000000,…\n$ subid          <dbl> 51514, 51514, 51514, 51514, 51514, 51514, 51514, 51514,…\n```\n\n\n:::\n:::\n\nThis dataset is already local SHAP values because we have one observation per subid per variable.\n\n## Get global Shapley values\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nglobal <- local |> \n  mutate(abs_contribution = abs(contribution)) |> \n  group_by(variable_name) |> \n  summarize(mean_contribution = mean(abs_contribution)) |> \n  arrange(desc(mean_contribution))\n\nglimpse(global)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 1,173\nColumns: 2\n$ variable_name     <chr> \"co\", \"race_ehr_white\", \"wisdm37_2_item_order\", \"mot…\n$ mean_contribution <dbl> 0.029854168, 0.023656426, 0.018174897, 0.016328284, …\n```\n\n\n:::\n:::\n\n\nDelineate treatment interactions\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nglobal <- global |> \n  mutate(tx_int = if_else(str_detect(variable_name, \"treatment_\"), \"Interaction\", \"Main Effect\"))\n\nlocal <- local |> \n  mutate(tx_int = if_else(str_detect(variable_name, \"treatment_\"), \"Interaction\", \"Main Effect\"))\n```\n:::\n\n\n## Make global figures\n\nOverall\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nfig_shap_global <- global |> \n  arrange(desc(mean_contribution)) |> \n  slice(1:25) |> \n  arrange(mean_contribution) |> \n  mutate(variable_name = str_replace(variable_name, \"treatment_\", \"\")) |> \n  mutate(variable_name = fct_inorder(variable_name)) |> \n  ggplot(mapping = aes(x = variable_name, y = mean_contribution, color = tx_int)) +\n  geom_point(size = 2) +\n  geom_segment(aes(x = variable_name, y = mean_contribution, xend = variable_name),\n               yend = 0) +\n  labs(\n    x = \"\",\n    y = \"Mean |Shapley value|\",\n    color = \"Feature Type\",\n    title = \"All Features\"\n  ) +\n  coord_flip() +\n  theme(legend.position = \"bottom\")\n\nfig_shap_global\n```\n\n::: {.cell-output-display}\n![](shap_4wk_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\nGlobal Shapley values among treatment interactions\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nfig_shap_global_tx <- global |> \n  filter(tx_int == \"Interaction\") |> \n  arrange(desc(mean_contribution)) |> \n  slice(1:25) |> \n  arrange(mean_contribution) |> \n  mutate(variable_name = str_replace(variable_name, \"treatment_\", \"\")) |> \n  mutate(variable_name = fct_inorder(variable_name)) |> \n  ggplot(mapping = aes(x = variable_name, y = mean_contribution, color = tx_int)) +\n  geom_point(size = 2) +\n  geom_segment(aes(x = variable_name, y = mean_contribution, xend = variable_name),\n               yend = 0) +\n  labs(\n    x = \"\",\n    y = \"Mean |Shapley value|\",\n    title = \"Interaction Features\"\n  ) +\n  coord_flip() +\n  theme(legend.position = \"none\")\n\nfig_shap_global_tx\n```\n\n::: {.cell-output-display}\n![](shap_4wk_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\nPaneled Global figure\n\n::: {#cell-fig-shap-global .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-shap-global\n#| fig-height: 7\n#| fig-cap: \"Global Shapley values for the 25 features with the highest importance. Bar represents magnitude of the overall feature importance, which is calculated from the mean of the absolute value across all observations for that feature. A) Global feature importance among all features. B) Global feature importance among treatment interaction features.\"\n#|\nfig_panel_shap_global <- (fig_shap_global / fig_shap_global_tx / guide_area()) +\n  plot_layout(guides = \"collect\", axes = \"collect\", ncol = 1,\n              heights = unit(c(3, 3, 0.5), \"in\")) +\n  plot_annotation(tag_levels = \"A\",\n                  title = \"Top Global Shapley Values\")\n\nfig_panel_shap_global\n```\n\n::: {.cell-output-display}\n![Global Shapley values for the 25 features with the highest importance. Bar represents magnitude of the overall feature importance, which is calculated from the mean of the absolute value across all observations for that feature. A) Global feature importance among all features. B) Global feature importance among treatment interaction features.](shap_4wk_files/figure-html/fig-shap-global-1.png){#fig-shap-global width=672}\n:::\n:::\n\n\n## Make Sina plots (local) \n\nSet up data\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nlocal_fig <- global |>\n  arrange(desc(mean_contribution)) |> \n  slice(1:25) |> \n  left_join(local, by = c(\"variable_name\", \"tx_int\"))\n\nlocal_fig_tx <- global |> \n  filter(tx_int == \"Interaction\") |> \n  arrange(desc(mean_contribution)) |> \n  slice(1:25) |> \n  left_join(local, by = c(\"variable_name\", \"tx_int\"))\n```\n:::\n\n\n\nOverall\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nfig_shap_local_all <- local_fig |>\n  arrange(mean_contribution) |> \n  mutate(variable_name = str_replace(variable_name, \"treatment_\", \"\")) |> \n  mutate(variable_name = fct_inorder(variable_name)) |> \n  ggplot(mapping = aes(x = variable_name, y = contribution,\n                       color = tx_int)) +\n  ggforce::geom_sina(method = \"counts\", maxwidth = 0.7, alpha = 0.4) +\n  geom_hline(yintercept = 0) +\n  scale_y_continuous(limits = c(-0.15, 0.2)) +\n  labs(\n    x = \"\",\n    y = \"Shapley Value\",\n    color = \"Feature Type\",\n    title = \"All Features\"\n  ) +\n  theme(axis.text = element_text(size = 9.5),\n        legend.position = \"bottom\") +\n  coord_flip()\n\nfig_shap_local_all\n```\n\n::: {.cell-output-display}\n![](shap_4wk_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\nLocal Shapley values among treatment interactions\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nfig_shap_local_tx <- local_fig_tx |> \n  arrange(mean_contribution) |> \n  mutate(variable_name = str_replace(variable_name, \"treatment_\", \"\")) |> \n  mutate(variable_name = fct_inorder(variable_name)) |> \n  ggplot(mapping = aes(x = variable_name, y = contribution,\n                       color = tx_int)) +\n  ggforce::geom_sina(method = \"counts\", maxwidth = 0.7, alpha = 0.4) +\n  geom_hline(yintercept = 0) +\n  scale_y_continuous(limits = c(-0.15, 0.2)) +\n  labs(\n    x = \"\",\n    y = \"Shapley Value\",\n    title = \"Interaction Features\"\n  ) +\n  theme(axis.text = element_text(size = 9.5),\n        legend.position = \"none\") +\n  coord_flip()\n\nfig_shap_local_tx\n```\n\n::: {.cell-output-display}\n![](shap_4wk_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\nPaneled local figure\n\n::: {#cell-fig-shap-local .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-shap-local\n#| fig-height: 7\n#| fig-cap: \"Local Shapley values for features with the highest global importance. Each dot represents the influence of that feature on a specific observation. A) Local feature importance among all features. B) Local feature importance among treatment interaction features.\"\n#|\nfig_panel_shap_local <- (fig_shap_local_all / fig_shap_local_tx / guide_area()) +\n  plot_layout(guides = \"collect\", axes = \"collect\", ncol = 1,\n              heights = unit(c(3, 3, 0.5), \"in\")) +\n  plot_annotation(tag_levels = \"A\",\n                  title = \"Local Shapley Values\")\n\nfig_panel_shap_local\n```\n\n::: {.cell-output-display}\n![Local Shapley values for features with the highest global importance. Each dot represents the influence of that feature on a specific observation. A) Local feature importance among all features. B) Local feature importance among treatment interaction features.](shap_4wk_files/figure-html/fig-shap-local-1.png){#fig-shap-local width=672}\n:::\n:::\n",
    "supporting": [
      "shap_4wk_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}