{
  "hash": "0f339941b2bb90a46076f10eb97ba668",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Evaluation of Clinical Benefit: Week 26 Model\"\nauthor: \"Gaylen Fronk\"\ndate: \"2024-06-05\"\nnumber-sections: true\noutput: \n  html_document:\n    toc: true \n    toc_depth: 4\nformat:\n  html:\n    embed-resources: true\n    toc: true\n    toc-depth: 4\neditor_options: \n  chunk_output_type: console\n---\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nstudy <- \"match\"\nversion <- \"v6\"\ny_col_name <- \"pp_hybrid_wk26_outcome\"\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\n# packages for script\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.4     ✔ readr     2.1.5\n✔ forcats   1.0.0     ✔ stringr   1.5.1\n✔ ggplot2   3.5.1     ✔ tibble    3.2.1\n✔ lubridate 1.9.3     ✔ tidyr     1.3.1\n✔ purrr     1.0.2     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\nlibrary(blme)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nLoading required package: lme4\nLoading required package: Matrix\n\nAttaching package: 'Matrix'\n\nThe following objects are masked from 'package:tidyr':\n\n    expand, pack, unpack\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\nlibrary(lme4)\n\ndevtools::source_url(\"https://github.com/jjcurtin/lab_support/blob/main/fun_eda.R?raw=true\")\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nℹ SHA-1 hash of file is \"c045eee2655a18dc85e715b78182f176327358a7\"\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\ndevtools::source_url(\"https://github.com/jjcurtin/lab_support/blob/main/chtc/static_files/fun_chtc.R?raw=true\")\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nℹ SHA-1 hash of file is \"75cc6f7b855da59c240908bd936834b4da01285b\"\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\ntheme_set(theme_classic()) \n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\n# handle conflicts\noptions(conflicts.policy = \"depends.ok\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n# absolute paths\nswitch (Sys.info()[['sysname']],\n        # PC paths\n        Windows = {\n          path_models <- str_c(\"P:/studydata/match/models/\", y_col_name)},\n        \n        # IOS paths\n        Darwin = {\n          path_models <- str_c(\"/Volumes/private/studydata/match/models/\", y_col_name)},\n        \n        # Linux paths\n        Linux = {\n          path_models <- str_c(\"~/mnt/private/studydata/match/models/\", y_col_name)}\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n# chunk defaults\n\noptions(tibble.width = Inf)\noptions(tibble.print_max = Inf)\n```\n:::\n\n\nRead in aim 2 dataset\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nd <- read_csv(file.path(path_models, \n                        str_c(\"aim_2_\", version, \"_\", y_col_name, \".csv\")),\n              show_col_types = FALSE) |> \n  mutate(outcome_rct_wk4_num = if_else(outcome_rct_wk4 == \"abstinent\", 1, 0),\n         outcome_rct_wk12_num = if_else(outcome_rct_wk12 == \"abstinent\", 1, 0),\n         outcome_rct_wk26_num = if_else(outcome_rct_wk26 == \"abstinent\", 1, 0),\n         tx_worst = case_when(\n           prob_patch < prob_combo_nrt & prob_patch < prob_varenicline ~ \"patch\",\n           prob_combo_nrt < prob_patch & prob_combo_nrt < prob_varenicline ~ \"combo_nrt\",\n           prob_varenicline < prob_patch & prob_varenicline < prob_combo_nrt ~ \"varenicline\",\n           TRUE ~ NA_character_),\n         tx_second = case_when(\n           tx_worst == \"patch\" & tx_best == \"varenicline\" ~ \"combo_nrt\",\n           tx_worst == \"patch\" & tx_best == \"combo_nrt\" ~ \"varenicline\",\n           tx_worst == \"varenicline\" & tx_best == \"patch\" ~ \"combo_nrt\",\n           tx_worst == \"varenicline\" & tx_best == \"combo_nrt\" ~ \"patch\",\n           tx_worst == \"combo_nrt\" & tx_best == \"varenicline\" ~ \"patch\",\n           tx_worst == \"combo_nrt\" & tx_best == \"patch\" ~ \"varenicline\",\n           TRUE ~ NA_character_)) |> \n  mutate(tx_rank = case_when(\n    tx_rct == tx_best ~ \"first\",\n    tx_rct == tx_second ~ \"second\",\n    tx_rct == tx_worst ~ \"third\",\n    TRUE ~ NA_character_)) |> \n  select(subid, starts_with(\"tx_\"), starts_with(\"prob_\"),\n         outcome_rct_wk4_num, outcome_rct_wk12_num, outcome_rct_wk26_num) |> \n  pivot_longer(\n    cols = c(outcome_rct_wk4_num, outcome_rct_wk12_num, outcome_rct_wk26_num),\n    names_to = \"week\",\n    names_pattern = \"(?<=outcome_rct_wk)(.+)(?=_num)\",\n    values_to = \"outcome_rct_num\"\n  ) |> \n  mutate(c_tx_match = if_else(tx_match == TRUE, 0.5, -0.5), # center\n         week = as.numeric(week)) |> \n  # log transformation\n  mutate(week_log_2 = log(week, base = 2)) |> \n  # week 4-centered log transformation\n  mutate(c4_week_log_2 = week_log_2 - log(4, base = 2))\n\nglimpse(d)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 3,258\nColumns: 16\n$ subid            <dbl> 20010, 20010, 20010, 20015, 20015, 20015, 20030, 2003…\n$ tx_rct           <chr> \"patch\", \"patch\", \"patch\", \"combo_nrt\", \"combo_nrt\", …\n$ tx_best          <chr> \"combo_nrt\", \"combo_nrt\", \"combo_nrt\", \"combo_nrt\", \"…\n$ tx_match         <lgl> FALSE, FALSE, FALSE, TRUE, TRUE, TRUE, FALSE, FALSE, …\n$ tx_worst         <chr> \"varenicline\", \"varenicline\", \"varenicline\", \"patch\",…\n$ tx_second        <chr> \"patch\", \"patch\", \"patch\", \"varenicline\", \"vareniclin…\n$ tx_rank          <chr> \"second\", \"second\", \"second\", \"first\", \"first\", \"firs…\n$ prob_best        <dbl> 0.1874374, 0.1874374, 0.1874374, 0.2612399, 0.2612399…\n$ prob_patch       <dbl> 0.1445079, 0.1445079, 0.1445079, 0.2329569, 0.2329569…\n$ prob_combo_nrt   <dbl> 0.1874374, 0.1874374, 0.1874374, 0.2612399, 0.2612399…\n$ prob_varenicline <dbl> 0.1100380, 0.1100380, 0.1100380, 0.2481624, 0.2481624…\n$ week             <dbl> 4, 12, 26, 4, 12, 26, 4, 12, 26, 4, 12, 26, 4, 12, 26…\n$ outcome_rct_num  <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0,…\n$ c_tx_match       <dbl> -0.5, -0.5, -0.5, 0.5, 0.5, 0.5, -0.5, -0.5, -0.5, 0.…\n$ week_log_2       <dbl> 2.000000, 3.584963, 4.700440, 2.000000, 3.584963, 4.7…\n$ c4_week_log_2    <dbl> 0.000000, 1.584963, 2.700440, 0.000000, 1.584963, 2.7…\n```\n\n\n:::\n:::\n\n\n## Analyses\n\n### Primary model\n\n*NOTE*: differs from preregistration (base 2 instead of base e)\n\n4-week-centered, log-transformed week (base 2)\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nif(file.exists(file.path(path_models, \n                         str_c(\"model_clin_benefit_\", version, \".rds\")))){\n  message(str_c(\"Model already exists for version \", \n                version, \". Reading in existing model\"))\n  \n  model_bayes <- read_rds(file.path(path_models, \n                                    str_c(\"model_clin_benefit_\", version, \".rds\")))\n  \n} else {\n  message(\"Fitting new model & saving out\")\n  model_bayes <- blme::bglmer(outcome_rct_num ~ c_tx_match * c4_week_log_2 + \n                                (1 + c4_week_log_2 | subid),\n                              data = d,\n                              family = binomial(link = \"logit\"),\n                              control = glmerControl(optCtrl = list(maxfun = 3e6)))\n  \n  model_bayes |> \n    write_rds(file.path(path_models, \n                        str_c(\"model_clin_benefit_\", version, \".rds\")))\n}\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nModel already exists for version v6. Reading in existing model\n```\n\n\n:::\n:::\n\n\nEvaluate model\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nsummary(model_bayes)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCov prior  : subid ~ wishart(df = 4.5, scale = Inf, posterior.scale = cov, common.scale = TRUE)\nPrior dev  : -0.878\n\nGeneralized linear mixed model fit by maximum likelihood (Laplace\n  Approximation) [bglmerMod]\n Family: binomial  ( logit )\nFormula: outcome_rct_num ~ c_tx_match * c4_week_log_2 + (1 + c4_week_log_2 |  \n    subid)\n   Data: d\nControl: glmerControl(optCtrl = list(maxfun = 3e+06))\n\n     AIC      BIC   logLik deviance df.resid \n  3092.1   3134.8  -1539.1   3078.1     3251 \n\nScaled residuals: \n     Min       1Q   Median       3Q      Max \n-1.22216 -0.42697 -0.06427  0.15007  1.37257 \n\nRandom effects:\n Groups Name          Variance Std.Dev. Corr\n subid  (Intercept)   3.369    1.836        \n        c4_week_log_2 6.219    2.494    0.96\nNumber of obs: 3258, groups:  subid, 1086\n\nFixed effects:\n                          Estimate Std. Error z value Pr(>|z|)    \n(Intercept)              -1.127130   0.140581  -8.018 1.08e-15 ***\nc_tx_match               -0.008524   0.204478  -0.042    0.967    \nc4_week_log_2            -1.568758   0.156091 -10.050  < 2e-16 ***\nc_tx_match:c4_week_log_2 -0.162704   0.194124  -0.838    0.402    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nCorrelation of Fixed Effects:\n            (Intr) c_tx_m c4___2\nc_tx_match   0.134              \nc4_wek_lg_2 -0.133  0.014       \nc_tx_:4___2  0.018  0.180  0.184\n```\n\n\n:::\n:::\n\n\n### Follow-up analyses: Simple Effects\n\nFrom preregistration: If the interaction between `tx_match` and `week` is significant (*p* < 0.05), we will conduct follow-up analyses to test the simple effect of `tx_match` at each time point.\n\nInteraction between `tx_match` and `week` was not significant (*p* = 0.83); however, we have opted to conduct simple effects analyses to more fully characterize our findings in probability terms and given known issues with conducting and interpreting interactions in logistic regression models.\n\nSimple effect at 4 weeks\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nd_4 <- d |> \n  filter(week == 4)\n\nmodel_4wk <- glm(outcome_rct_num ~ c_tx_match, \n                 data = d_4,\n                 family = binomial(link = \"logit\"))\n\nsummary(model_4wk)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nglm(formula = outcome_rct_num ~ c_tx_match, family = binomial(link = \"logit\"), \n    data = d_4)\n\nCoefficients:\n            Estimate Std. Error z value Pr(>|z|)    \n(Intercept) -0.65712    0.06524 -10.073   <2e-16 ***\nc_tx_match  -0.01072    0.13047  -0.082    0.935    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for binomial family taken to be 1)\n\n    Null deviance: 1394.7  on 1085  degrees of freedom\nResidual deviance: 1394.6  on 1084  degrees of freedom\nAIC: 1398.6\n\nNumber of Fisher Scoring iterations: 4\n```\n\n\n:::\n:::\n\n\nSimple effect at 12 weeks\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nd_12 <- d |> \n  filter(week == 12)\n\nmodel_12wk <- glm(outcome_rct_num ~ c_tx_match, \n                  data = d_12,\n                  family = binomial(link = \"logit\"))\n\nsummary(model_12wk)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nglm(formula = outcome_rct_num ~ c_tx_match, family = binomial(link = \"logit\"), \n    data = d_12)\n\nCoefficients:\n            Estimate Std. Error z value Pr(>|z|)    \n(Intercept) -0.90873    0.06858  -13.25   <2e-16 ***\nc_tx_match  -0.13167    0.13716   -0.96    0.337    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for binomial family taken to be 1)\n\n    Null deviance: 1308.0  on 1085  degrees of freedom\nResidual deviance: 1307.1  on 1084  degrees of freedom\nAIC: 1311.1\n\nNumber of Fisher Scoring iterations: 4\n```\n\n\n:::\n:::\n\n\nSimple effect at 26 weeks\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nd_26 <- d |> \n  filter(week == 26)\n\nmodel_26wk <- glm(outcome_rct_num ~ c_tx_match, \n                  data = d_26,\n                  family = binomial(link = \"logit\"))\n\nsummary(model_26wk)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nglm(formula = outcome_rct_num ~ c_tx_match, family = binomial(link = \"logit\"), \n    data = d_26)\n\nCoefficients:\n            Estimate Std. Error z value Pr(>|z|)    \n(Intercept) -1.12905    0.07225 -15.627   <2e-16 ***\nc_tx_match  -0.12618    0.14450  -0.873    0.383    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for binomial family taken to be 1)\n\n    Null deviance: 1213.6  on 1085  degrees of freedom\nResidual deviance: 1212.9  on 1084  degrees of freedom\nAIC: 1216.9\n\nNumber of Fisher Scoring iterations: 4\n```\n\n\n:::\n:::\n\n\n## Figure\n\nPrimary figure\n\n::: {#cell-fig-clin-ben-wk26 .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-clin-ben-wk26\n#| fig-cap: \"(Supplemental) Benefit of treatment matching from 12-week prediction model. Bars represent mean observed abstinence (from original trial) for individuals who did and did not receive their model-predicted best treatment, over time. Error bars indicate standard errors.\"\nfig_clin_ben_wk26 <- d |> \n  mutate(week_cat = factor(week,\n                           levels = c(4, 12, 26),\n                           labels = c(\"Week 4\", \"Week 12\", \"Week 26\")),\n         tx_match = factor(tx_match, \n                           levels = c(TRUE, FALSE),\n                           labels = c(\"Best Treatment\", \"Other Treatment\"))) |> \n  group_by(week_cat, tx_match) |> \n  summarize(mean_outcome = mean(outcome_rct_num),\n            sd_outcome = sd(outcome_rct_num),\n            n_group = n()) |> \n  mutate(se_outcome = (sd_outcome / sqrt(n_group))) |> \n  ggplot(aes(x = week_cat, y = mean_outcome, fill = tx_match)) +\n  geom_col(position = \"dodge\") +\n  geom_errorbar(aes(ymin = mean_outcome - se_outcome, \n                    ymax = mean_outcome + se_outcome,\n                    x = week_cat),\n                position = position_dodge(width = 0.9),\n                width = 0.5) +\n  scale_y_continuous(limits = c(0, 0.425)) +\n  labs(\n    x = \"Week On-Study\",\n    y = \"Mean Abstinence Rate\",\n    fill = \"Treatment Matching\"\n  )\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n`summarise()` has grouped output by 'week_cat'. You can override using the\n`.groups` argument.\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| label: fig-clin-ben-wk26\n#| fig-cap: \"(Supplemental) Benefit of treatment matching from 12-week prediction model. Bars represent mean observed abstinence (from original trial) for individuals who did and did not receive their model-predicted best treatment, over time. Error bars indicate standard errors.\"\nfig_clin_ben_wk26\n```\n\n::: {.cell-output-display}\n![(Supplemental) Benefit of treatment matching from 12-week prediction model. Bars represent mean observed abstinence (from original trial) for individuals who did and did not receive their model-predicted best treatment, over time. Error bars indicate standard errors.](eval_benefit_26wk_files/figure-html/fig-clin-ben-wk26-1.png){#fig-clin-ben-wk26 width=672}\n:::\n:::\n\n\nMake predicted dataset\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nd_fig_alt <- d |> \n  select(subid, c_tx_match, c4_week_log_2) |> \n  mutate(pred_logodds = predict(model_bayes, d)) |> \n  mutate(pred_probs = predict(model_bayes, d, type = \"response\")) |> \n  mutate(week_cat = factor(c4_week_log_2,\n                           levels = c(0, (log(12, base = 2) - 2), \n                                      (log(26, base = 2) - 2)),\n                           labels = c(\"Week 4\", \"Week 12\", \"Week 26\")),\n         tx_match = factor(c_tx_match, \n                           levels = c(0.5, -0.5),\n                           labels = c(\"Matched to Best\", \"Unmatched\"))) |> \n  group_by(week_cat, tx_match) |> \n  summarize(mean_pred_logodds = mean(pred_logodds),\n            mean_pred_probs = mean(pred_probs))\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n`summarise()` has grouped output by 'week_cat'. You can override using the\n`.groups` argument.\n```\n\n\n:::\n:::\n\n\nLog odds figure\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nd_fig_alt |> \n  ggplot(aes(x = week_cat, y = mean_pred_logodds, fill = tx_match)) +\n  geom_col(position = \"dodge\") +\n  labs(\n    x = \"Week On-Study\",\n    y = \"Log Odds\",\n    fill = \"Treatment Matching\"\n  )\n```\n\n::: {.cell-output-display}\n![](eval_benefit_26wk_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\nPredicted probabilities figure\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nd_fig_alt |> \n  ggplot(aes(x = week_cat, y = mean_pred_probs, fill = tx_match)) +\n  geom_col(position = \"dodge\") +\n  labs(\n    x = \"Week On-Study\",\n    y = \"Predicted Probabilities\",\n    fill = \"Treatment Matching\"\n  )\n```\n\n::: {.cell-output-display}\n![](eval_benefit_26wk_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "eval_benefit_26wk_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}